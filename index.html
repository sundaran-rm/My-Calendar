<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calendar</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f0f11;
    --surface: #18181c;
    --surface2: #222228;
    --surface3: #2c2c35;
    --border: #2e2e38;
    --accent: #7c6af7;
    --accent2: #a78bfa;
    --accent-soft: #7c6af720;
    --text: #e8e8f0;
    --text2: #9090a8;
    --text3: #5c5c72;
    --red: #f87171;
    --green: #4ade80;
  }

  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

  /* NAV */
  nav { display: flex; align-items: center; gap: 10px; padding: 10px 18px; border-bottom: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
  .logo { font-family: 'DM Serif Display', serif; font-size: 1.25rem; color: var(--text); letter-spacing: -0.02em; margin-right: 4px; }
  .logo span { color: var(--accent2); font-style: italic; }
  .nav-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 6px 12px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.82rem; font-weight: 500; transition: all 0.15s; display: flex; align-items: center; gap: 5px; }
  .nav-btn:hover { background: var(--surface3); border-color: var(--accent); }
  .nav-btn.active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent2); }
  .view-tabs { display: flex; gap: 4px; }
  .nav-center { display: flex; align-items: center; gap: 8px; margin: 0 auto; }
  .month-title { font-family: 'DM Serif Display', serif; font-size: 1.3rem; letter-spacing: -0.02em; min-width: 220px; text-align: center; }
  .arrow-btn { background: none; border: 1px solid var(--border); color: var(--text2); width: 30px; height: 30px; border-radius: 8px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
  .arrow-btn:hover { border-color: var(--accent); color: var(--accent2); background: var(--accent-soft); }
  .today-btn { background: none; border: 1px solid var(--border); color: var(--text2); padding: 5px 11px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.8rem; font-weight: 500; transition: all 0.15s; }
  .today-btn:hover { border-color: var(--accent); color: var(--accent2); }
  .add-btn { background: var(--accent); border: none; color: #fff; padding: 7px 15px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.82rem; font-weight: 600; transition: all 0.15s; display: flex; align-items: center; gap: 5px; margin-left: 4px; }
  .add-btn:hover { background: var(--accent2); transform: translateY(-1px); box-shadow: 0 4px 14px #7c6af740; }

  /* LAYOUT */
  .main { display: flex; flex: 1; overflow: hidden; }

  /* SIDEBAR */
  .sidebar { width: 236px; border-right: 1px solid var(--border); padding: 14px; overflow-y: auto; flex-shrink: 0; background: var(--surface); display: flex; flex-direction: column; gap: 16px; transition: width 0.25s ease, padding 0.25s ease, opacity 0.2s ease; }
  .sidebar.collapsed { width: 0; padding: 0; opacity: 0; overflow: hidden; border-right: none; }

  .mini-cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .mini-cal-title { font-size: 0.82rem; font-weight: 600; color: var(--text2); }
  .mini-arrow { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 0.8rem; width: 20px; height: 20px; border-radius: 5px; display: flex; align-items: center; justify-content: center; transition: all 0.12s; }
  .mini-arrow:hover { color: var(--text); background: var(--surface2); }
  .mini-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
  .mini-day-label { font-size: 0.6rem; color: var(--text3); text-align: center; padding: 2px 0; font-weight: 600; letter-spacing: 0.05em; }
  .mini-day { font-size: 0.7rem; text-align: center; border-radius: 50%; cursor: pointer; color: var(--text2); width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; margin: auto; transition: all 0.1s; }
  .mini-day:hover { background: var(--surface3); color: var(--text); }
  .mini-day.today { background: var(--accent); color: #fff; font-weight: 700; }
  .mini-day.other-month { color: var(--text3); }

  .section-title { font-size: 0.67rem; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 7px; display: flex; align-items: center; justify-content: space-between; }
  .mini-toggle-btn { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 0.72rem; padding: 2px 5px; border-radius: 4px; transition: all 0.12s; font-family: inherit; }
  .mini-toggle-btn:hover { color: var(--accent2); background: var(--accent-soft); }

  .upcoming-event { padding: 7px 9px; border-radius: 8px; background: var(--surface2); border-left: 3px solid var(--accent); margin-bottom: 5px; cursor: pointer; transition: all 0.12s; }
  .upcoming-event:hover { background: var(--surface3); }
  .upcoming-event .ev-title { font-size: 0.8rem; font-weight: 500; }
  .upcoming-event .ev-date { font-size: 0.7rem; color: var(--text2); margin-top: 2px; }
  .recur-badge { display: inline-block; font-size: 0.58rem; background: var(--accent-soft); color: var(--accent2); padding: 1px 5px; border-radius: 10px; margin-left: 4px; vertical-align: middle; font-weight: 600; }

  .calendar-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  /* MONTH */
  .month-view { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .day-headers { display: grid; grid-template-columns: repeat(7, 1fr); border-bottom: 1px solid var(--border); background: var(--surface); }
  .day-header { text-align: center; padding: 9px 4px; font-size: 0.68rem; font-weight: 600; letter-spacing: 0.08em; color: var(--text3); text-transform: uppercase; border-right: 1px solid var(--border); }
  .day-header:last-child { border-right: none; }
  .month-grid { flex: 1; display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: repeat(6, 1fr); overflow: hidden; }
  .day-cell { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 5px; overflow: hidden; cursor: pointer; transition: background 0.1s; display: flex; flex-direction: column; }
  .day-cell:nth-child(7n) { border-right: none; }
  .day-cell:hover { background: #ffffff06; }
  .day-cell.other-month { opacity: 0.3; }
  .day-cell.today .day-num-inner { background: var(--accent); color: #fff; }
  .day-num { display: flex; align-items: center; margin-bottom: 3px; }
  .day-num-inner { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.74rem; font-weight: 600; color: var(--text2); flex-shrink: 0; }
  .day-cell:hover .day-num-inner { color: var(--text); }
  .event-pill { display: flex; align-items: center; gap: 3px; padding: 2px 5px; border-radius: 4px; font-size: 0.67rem; margin-bottom: 2px; cursor: pointer; overflow: hidden; white-space: nowrap; color: var(--text); transition: opacity 0.1s; min-width: 0; border-left: 2px solid; }
  .event-pill:hover { opacity: 0.8; }
  .pill-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
  .pill-text { overflow: hidden; text-overflow: ellipsis; flex: 1; }
  .pill-recur { font-size: 0.58rem; flex-shrink: 0; opacity: 0.7; }
  .more-events { font-size: 0.62rem; color: var(--text3); padding: 1px 4px; cursor: pointer; }
  .more-events:hover { color: var(--accent2); }

  /* WEEK */
  .week-view { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .week-header { display: grid; grid-template-columns: 58px repeat(7, 1fr); border-bottom: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
  .week-day-header { text-align: center; padding: 9px 4px; border-right: 1px solid var(--border); }
  .wdh-name { color: var(--text3); font-size: 0.64rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; }
  .wdh-num { font-size: 1.1rem; font-weight: 600; color: var(--text2); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 3px auto 0; }
  .wdh-num.today { background: var(--accent); color: #fff; }
  .week-body { flex: 1; display: grid; grid-template-columns: 58px repeat(7, 1fr); overflow-y: auto; }
  .time-col { border-right: 1px solid var(--border); position: sticky; left: 0; background: var(--surface); z-index: 2; }
  .time-label { height: 60px; display: flex; align-items: flex-start; justify-content: flex-end; padding: 4px 7px 0 0; font-size: 0.62rem; color: var(--text3); }
  .week-day-col { border-right: 1px solid var(--border); position: relative; min-height: 1440px; cursor: pointer; }
  .week-day-col:last-child { border-right: none; }
  .hour-line { position: absolute; left: 0; right: 0; border-top: 1px solid var(--border); height: 60px; }
  .now-line { position: absolute; left: 0; right: 0; z-index: 3; border-top: 2px solid var(--red); }
  .now-dot { position: absolute; left: -4px; top: -4px; width: 8px; height: 8px; background: var(--red); border-radius: 50%; }
  .week-event { position: absolute; left: 2px; right: 2px; border-radius: 4px; padding: 2px 5px; font-size: 0.7rem; color: var(--text); cursor: pointer; overflow: hidden; z-index: 1; transition: opacity 0.1s; border-left: 2px solid; }
  .week-event:hover { opacity: 0.8; z-index: 5; }
  .we-title { font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .we-time { color: var(--text2); font-size: 0.62rem; }

  /* All-day row */
  .allday-row { display: grid; border-bottom: 1px solid var(--border); background: var(--surface); flex-shrink: 0; min-height: 28px; }
  .allday-row.week-allday { grid-template-columns: 58px repeat(7, 1fr); }
  .allday-row.day-allday  { grid-template-columns: 58px 1fr; }
  .allday-gutter { border-right: 1px solid var(--border); display: flex; align-items: center; justify-content: flex-end; padding: 4px 7px 0 0; font-size: 0.58rem; color: var(--text3); font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; }
  .allday-cell  { border-right: 1px solid var(--border); padding: 3px 4px; display: flex; flex-direction: column; gap: 2px; }
  .allday-cell:last-child { border-right: none; }
  .allday-pill  { display: flex; align-items: center; gap: 3px; padding: 2px 6px; border-radius: 4px; font-size: 0.68rem; cursor: pointer; overflow: hidden; white-space: nowrap; color: var(--text); transition: opacity 0.1s; border-left: 2px solid; }
  .allday-pill:hover { opacity: 0.8; }
  .allday-pill-dot  { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
  .allday-pill-text { overflow: hidden; text-overflow: ellipsis; flex: 1; }

  /* DAY */
  .day-view { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .day-header-bar { text-align: center; padding: 10px; border-bottom: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
  .dhb-name { font-size: 0.7rem; color: var(--text3); font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; }
  .dhb-num { font-size: 1.9rem; font-weight: 700; color: var(--text); }
  .day-body { flex: 1; display: grid; grid-template-columns: 58px 1fr; overflow-y: auto; }

  /* OVERLAYS & MODALS */
  .overlay { position: fixed; inset: 0; background: #00000099; z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .overlay.open { opacity: 1; pointer-events: all; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 26px; width: 460px; max-width: 95vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 24px 80px #00000090; transform: translateY(20px) scale(0.97); transition: transform 0.2s; }
  .overlay.open .modal { transform: translateY(0) scale(1); }
  .modal-title { font-family: 'DM Serif Display', serif; font-size: 1.35rem; margin-bottom: 18px; color: var(--text); }
  .form-group { margin-bottom: 12px; }
  .form-label { font-size: 0.7rem; font-weight: 600; color: var(--text2); margin-bottom: 5px; display: block; letter-spacing: 0.05em; text-transform: uppercase; }
  .form-input { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 9px 11px; border-radius: 8px; font-family: inherit; font-size: 0.87rem; outline: none; transition: border-color 0.15s; }
  .form-input:focus { border-color: var(--accent); }
  select.form-input option { background: var(--surface2); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .color-picker { display: flex; gap: 7px; flex-wrap: wrap; }
  .color-swatch { width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.12s; position: relative; }
  .color-swatch.selected::after { content: '‚úì'; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 0.66rem; font-weight: 700; }
  .color-swatch:hover { transform: scale(1.15); }
  .modal-actions { display: flex; gap: 9px; justify-content: flex-end; margin-top: 18px; padding-top: 14px; border-top: 1px solid var(--border); }
  .btn-cancel { background: none; border: 1px solid var(--border); color: var(--text2); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.82rem; transition: all 0.15s; }
  .btn-cancel:hover { border-color: var(--text3); color: var(--text); }
  .btn-save { background: var(--accent); border: none; color: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.82rem; font-weight: 600; transition: all 0.15s; }
  .btn-save:hover { background: var(--accent2); }
  .btn-delete { background: none; border: 1px solid var(--red); color: var(--red); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.82rem; transition: all 0.15s; margin-right: auto; }
  .btn-delete:hover { background: #f8717120; }

  /* Recurrence */
  .recur-section { background: var(--surface2); border-radius: 10px; padding: 13px; margin-bottom: 12px; border: 1px solid var(--border); }
  .recur-section .form-group { margin-bottom: 9px; }
  .recur-section .form-group:last-child { margin-bottom: 0; }

  /* Event popup */
  .event-popup { position: fixed; z-index: 90; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 14px; width: 290px; box-shadow: 0 12px 40px #00000080; display: none; }
  .event-popup.open { display: block; }
  .ep-header { display: flex; align-items: flex-start; gap: 9px; margin-bottom: 8px; }
  .ep-color { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; margin-top: 3px; }
  .ep-title { font-weight: 600; font-size: 0.92rem; flex: 1; }
  .ep-close { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 1.1rem; line-height: 1; }
  .ep-meta { font-size: 0.75rem; color: var(--text2); margin-bottom: 3px; }
  .ep-recur-badge { display: inline-flex; align-items: center; gap: 3px; font-size: 0.68rem; background: var(--accent-soft); color: var(--accent2); padding: 2px 7px; border-radius: 10px; margin-top: 5px; }
  .ep-desc { font-size: 0.77rem; color: var(--text2); margin-top: 8px; border-top: 1px solid var(--border); padding-top: 8px; }
  .ep-actions { display: flex; gap: 6px; margin-top: 11px; flex-wrap: wrap; }
  .ep-btn { flex: 1; padding: 6px 4px; border-radius: 6px; border: 1px solid var(--border); background: none; color: var(--text2); font-family: inherit; font-size: 0.73rem; cursor: pointer; transition: all 0.12s; white-space: nowrap; text-align: center; }
  .ep-btn:hover { border-color: var(--accent); color: var(--accent2); }
  .ep-btn.danger { border-color: var(--red); color: var(--red); }
  .ep-btn.danger:hover { background: #f8717120; }
  .ep-btn.success { border-color: var(--green); color: var(--green); }
  .ep-btn.success:hover { background: #4ade8020; }

  /* Copy modal */
  .copy-modal { width: 340px; }
  .copy-modal p { font-size: 0.84rem; color: var(--text2); margin-bottom: 16px; }

  /* Delete dialog */
  .del-dialog { width: 370px; }
  .del-dialog p { font-size: 0.83rem; color: var(--text2); margin-bottom: 4px; }
  .del-choice { display: flex; flex-direction: column; gap: 7px; margin: 13px 0; }
  .del-opt { display: flex; align-items: flex-start; gap: 9px; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; transition: all 0.12s; }
  .del-opt:hover { border-color: var(--red); background: #f8717110; }
  .del-opt input { margin-top: 3px; accent-color: var(--accent); }
  .del-opt-label { font-size: 0.84rem; font-weight: 500; }
  .del-opt-sub { font-size: 0.74rem; color: var(--text2); margin-top: 2px; }

  ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 10px; }
  .no-events { color: var(--text3); font-size: 0.77rem; text-align: center; padding: 14px 0; }

  /* Toast */
  #toast { position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%); background: var(--surface3); border: 1px solid var(--border); color: var(--text); padding: 10px 20px; border-radius: 10px; font-size: 0.82rem; z-index: 999; box-shadow: 0 8px 24px #00000060; opacity: 0; transition: opacity 0.3s; pointer-events: none; }

  /* Import/Export dropdown */
  .io-wrapper { position: relative; }
  .io-dropdown { position: absolute; top: calc(100% + 6px); right: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; min-width: 200px; box-shadow: 0 12px 36px #00000070; z-index: 200; overflow: hidden; display: none; }
  .io-wrapper.open .io-dropdown { display: block; }
  .io-section-label { font-size: 0.65rem; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.1em; padding: 10px 14px 4px; }
  .io-item { display: flex; align-items: center; gap: 9px; padding: 9px 14px; cursor: pointer; font-size: 0.83rem; color: var(--text2); transition: all 0.12s; border: none; background: none; font-family: inherit; width: 100%; text-align: left; }
  .io-item:hover { background: var(--surface2); color: var(--text); }
  .io-item .io-icon { font-size: 1rem; width: 18px; text-align: center; flex-shrink: 0; }
  .io-item .io-sub { font-size: 0.7rem; color: var(--text3); display: block; margin-top: 1px; }
  .io-divider { height: 1px; background: var(--border); margin: 4px 0; }

  /* Import modal */
  .import-modal { width: 420px; }
  .import-drop-zone { border: 2px dashed var(--border); border-radius: 10px; padding: 28px 20px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 14px; }
  .import-drop-zone:hover, .import-drop-zone.drag-over { border-color: var(--accent); background: var(--accent-soft); }
  .import-drop-zone .dz-icon { font-size: 2rem; margin-bottom: 8px; }
  .import-drop-zone .dz-title { font-size: 0.9rem; font-weight: 600; color: var(--text); margin-bottom: 4px; }
  .import-drop-zone .dz-sub { font-size: 0.76rem; color: var(--text2); }
  .import-drop-zone .dz-file { font-size: 0.8rem; color: var(--accent2); margin-top: 8px; font-weight: 500; }
  .import-preview { background: var(--surface2); border-radius: 8px; padding: 12px 14px; margin-bottom: 14px; display: none; }
  .import-preview .ip-stat { font-size: 0.82rem; color: var(--text2); margin-bottom: 4px; }
  .import-preview .ip-stat strong { color: var(--text); }
  .import-mode { display: flex; gap: 8px; margin-bottom: 4px; }
  .import-mode-opt { flex: 1; padding: 9px 10px; border-radius: 8px; border: 1px solid var(--border); background: none; font-family: inherit; font-size: 0.78rem; color: var(--text2); cursor: pointer; transition: all 0.12s; text-align: center; }
  .import-mode-opt.selected { border-color: var(--accent); background: var(--accent-soft); color: var(--accent2); }
  .import-mode-sub { font-size: 0.7rem; color: var(--text3); text-align: center; margin-top: 4px; }

  /* Jump-to-date */
  .jump-wrapper { position: relative; }
  .jump-btn { background: none; border: 1px solid var(--border); color: var(--text2); padding: 5px 11px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.8rem; font-weight: 500; transition: all 0.15s; display: flex; align-items: center; gap: 5px; }
  .jump-btn:hover { border-color: var(--accent); color: var(--accent2); }
  .jump-dropdown { position: absolute; top: calc(100% + 6px); left: 50%; transform: translateX(-50%); background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: 0 12px 36px #00000070; z-index: 200; display: none; min-width: 240px; }
  .jump-wrapper.open .jump-dropdown { display: block; }
  .jump-dropdown label { font-size: 0.7rem; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.06em; display: block; margin-bottom: 7px; }
  .jump-date-input { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 9px 11px; border-radius: 8px; font-family: inherit; font-size: 0.9rem; outline: none; transition: border-color 0.15s; margin-bottom: 10px; }
  .jump-date-input:focus { border-color: var(--accent); }
  .jump-go-btn { width: 100%; background: var(--accent); border: none; color: #fff; padding: 8px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.85rem; font-weight: 600; transition: background 0.15s; }
  .jump-go-btn:hover { background: var(--accent2); }


  /* ‚îÄ‚îÄ FIREBASE / SYNC ‚îÄ‚îÄ */
  .sync-indicator { display: flex; align-items: center; gap: 6px; padding: 5px 11px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.78rem; color: var(--text2); background: var(--surface2); cursor: pointer; transition: all 0.15s; user-select: none; }
  .sync-indicator:hover { border-color: var(--accent); color: var(--text); }
  .sync-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; transition: background 0.3s; }
  .sync-dot.connected { background: #4ade80; box-shadow: 0 0 6px #4ade8060; }
  .sync-dot.syncing   { background: #fbbf24; animation: pulse-dot 1s infinite; }
  .sync-dot.offline   { background: #f87171; }
  .sync-dot.local     { background: var(--text3); }
  @keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .room-badge { display: inline-flex; align-items: center; gap: 5px; background: var(--accent-soft); border: 1px solid var(--accent); color: var(--accent2); padding: 4px 10px; border-radius: 20px; font-size: 0.76rem; font-weight: 600; letter-spacing: 0.06em; cursor: pointer; transition: all 0.15s; }
  .room-badge:hover { background: var(--accent); color: #fff; }

  /* Firebase setup + room modals */
  .fb-modal { width: 480px; }
  .fb-steps { counter-reset: step; }
  .fb-step { display: flex; gap: 12px; margin-bottom: 16px; }
  .fb-step-num { width: 22px; height: 22px; border-radius: 50%; background: var(--accent); color: #fff; font-size: 0.7rem; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
  .fb-step-body { flex: 1; }
  .fb-step-title { font-size: 0.85rem; font-weight: 600; color: var(--text); margin-bottom: 4px; }
  .fb-step-sub { font-size: 0.76rem; color: var(--text2); line-height: 1.5; }
  .fb-step-sub a { color: var(--accent2); text-decoration: none; }
  .fb-step-sub a:hover { text-decoration: underline; }
  .fb-config-area { width: 100%; min-height: 110px; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 10px 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.78rem; outline: none; resize: vertical; transition: border-color 0.15s; }
  .fb-config-area:focus { border-color: var(--accent); }
  .fb-skip { background: none; border: none; color: var(--text3); font-family: inherit; font-size: 0.78rem; cursor: pointer; padding: 4px; text-decoration: underline; }
  .fb-skip:hover { color: var(--text2); }
  .fb-info-box { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 13px; font-size: 0.78rem; color: var(--text2); line-height: 1.6; margin-bottom: 14px; }
  .fb-info-box strong { color: var(--text); }

  /* Room modal */
  .room-modal { width: 400px; }
  .room-section { margin-bottom: 20px; }
  .room-section-title { font-size: 0.78rem; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 10px; }
  .room-code-display { font-family: 'Courier New', monospace; font-size: 1.6rem; font-weight: 700; letter-spacing: 0.18em; color: var(--accent2); background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px; text-align: center; margin-bottom: 10px; }
  .room-divider { display: flex; align-items: center; gap: 10px; margin: 18px 0; color: var(--text3); font-size: 0.75rem; }
  .room-divider::before, .room-divider::after { content:''; flex:1; height:1px; background:var(--border); }
  .room-join-row { display: flex; gap: 8px; }
  .room-join-input { flex:1; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 9px 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9rem; font-weight: 600; letter-spacing: 0.1em; outline: none; text-transform: uppercase; transition: border-color 0.15s; }
  .room-join-input:focus { border-color: var(--accent); }
  .btn-join { background: var(--surface3); border: 1px solid var(--border); color: var(--text); padding: 9px 16px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.83rem; font-weight: 600; transition: all 0.15s; }
  .btn-join:hover { border-color: var(--accent); color: var(--accent2); }
  .room-current { background: var(--accent-soft); border: 1px solid var(--accent); border-radius: 10px; padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .room-current-code { font-family: 'Courier New', monospace; font-size: 1.1rem; font-weight: 700; color: var(--accent2); letter-spacing: 0.14em; }
  .room-current-label { font-size: 0.7rem; color: var(--text2); margin-top: 2px; }
  .btn-leave { background: none; border: 1px solid var(--red); color: var(--red); padding: 6px 12px; border-radius: 7px; cursor: pointer; font-family: inherit; font-size: 0.76rem; transition: all 0.15s; }
  .btn-leave:hover { background: #f8717120; }

  /* ‚îÄ‚îÄ LABELS ‚îÄ‚îÄ */
  .label-row { display: flex; align-items: center; gap: 7px; padding: 5px 6px; border-radius: 7px; transition: background 0.12s; margin-bottom: 2px; }
  .label-row:hover { background: var(--surface2); }
  .label-row:hover .label-edit-btn { opacity: 1; }
  .label-vis-btn { background: none; border: none; padding: 0; cursor: pointer; width: 16px; height: 16px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border-radius: 3px; font-size: 0.75rem; }
  .label-dot { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; transition: opacity 0.15s; }
  .label-name { font-size: 0.8rem; color: var(--text); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; transition: opacity 0.15s; cursor: default; }
  .label-count { font-size: 0.67rem; color: var(--text3); flex-shrink: 0; }
  .label-edit-btn { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 0.72rem; padding: 2px 4px; border-radius: 4px; opacity: 0; transition: all 0.12s; font-family: inherit; }
  .label-edit-btn:hover { color: var(--accent2); background: var(--accent-soft); }
  .label-row.hidden .label-dot { opacity: 0.22; }
  .label-row.hidden .label-name { opacity: 0.35; }
  .label-row.hidden .label-count { opacity: 0.35; }
  .label-add-btn { display: flex; align-items: center; gap: 5px; width: 100%; padding: 5px 6px; background: none; border: 1px dashed var(--border); border-radius: 7px; color: var(--text3); font-family: inherit; font-size: 0.78rem; cursor: pointer; transition: all 0.12s; margin-top: 4px; }
  .label-add-btn:hover { border-color: var(--accent); color: var(--accent2); background: var(--accent-soft); }
  .pill-label { font-size: 0.57rem; background: #ffffff18; padding: 1px 4px; border-radius: 3px; flex-shrink: 0; max-width: 54px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .label-modal { width: 360px; }
  .label-color-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; }
  .label-color-sw { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.12s; position: relative; flex-shrink: 0; }
  .label-color-sw.selected::after { content: '\2713'; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 0.62rem; font-weight: 700; }
  .label-color-sw:hover { transform: scale(1.15); }
  .ep-label-badge { display: inline-flex; align-items: center; gap: 5px; font-size: 0.74rem; padding: 3px 9px; border-radius: 20px; margin-top: 6px; font-weight: 500; }
  .ep-label-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
</style>
</head>
<body>

<nav>
  <div class="logo">Cal<span>¬∑</span>IO</div>
  <div class="view-tabs">
    <button class="nav-btn active" onclick="setView('month')" id="btn-month">Month</button>
    <button class="nav-btn" onclick="setView('week')" id="btn-week">Week</button>
    <button class="nav-btn" onclick="setView('day')" id="btn-day">Day</button>
  </div>
  <div class="nav-center">
    <button class="arrow-btn" onclick="navigate(-1)">&#8249;</button>
    <button class="today-btn" onclick="goToday()">Today</button>
    <button class="arrow-btn" onclick="navigate(1)">&#8250;</button>
    <div class="month-title" id="main-title" style="cursor:pointer" onclick="openJumpToDate()" title="Click to jump to date (G)"></div>
    <div class="jump-wrapper" id="jump-wrapper">
      <button class="jump-btn" onclick="openJumpToDate()" title="Jump to date (G)">üìÖ Go to‚Ä¶</button>
      <div class="jump-dropdown" id="jump-dropdown">
        <label>Jump to Date</label>
        <input type="date" class="jump-date-input" id="jump-date-input" onkeydown="if(event.key==='Enter')confirmJump()" />
        <button class="jump-go-btn" onclick="confirmJump()">Go to Date</button>
      </div>
    </div>
  </div>
  <button class="nav-btn" id="sidebar-toggle-btn" onclick="toggleSidebar()" title="Toggle sidebar">&#9776; Sidebar</button>

  <!-- Import / Export dropdown -->
  <div class="io-wrapper" id="io-wrapper">
    <button class="nav-btn" onclick="toggleIODropdown(event)" title="Import / Export">‚áÖ Import/Export</button>
    <div class="io-dropdown" id="io-dropdown">
      <div class="io-section-label">Export</div>
      <button class="io-item" onclick="exportJSON()">
        <span class="io-icon">üì¶</span>
        <span><span style="font-weight:500;color:var(--text)">Export as JSON</span><span class="io-sub">Full backup, re-importable</span></span>
      </button>
      <button class="io-item" onclick="exportICS()">
        <span class="io-icon">üìÖ</span>
        <span><span style="font-weight:500;color:var(--text)">Export as .ics</span><span class="io-sub">Google, Apple, Outlook compatible</span></span>
      </button>
      <div class="io-divider"></div>
      <div class="io-section-label">Import</div>
      <button class="io-item" onclick="openImportModal('json')">
        <span class="io-icon">üìÇ</span>
        <span><span style="font-weight:500;color:var(--text)">Import JSON</span><span class="io-sub">Restore from backup</span></span>
      </button>
      <button class="io-item" onclick="openImportModal('ics')">
        <span class="io-icon">üóì</span>
        <span><span style="font-weight:500;color:var(--text)">Import .ics</span><span class="io-sub">From Google, Apple, Outlook‚Ä¶</span></span>
      </button>
    </div>
  </div>

  <!-- Firebase sync indicator -->
  <div id="sync-indicator" class="sync-indicator" onclick="openRoomModal()" title="Firebase sync / collaboration">
    <div class="sync-dot local" id="sync-dot"></div>
    <span id="sync-label">Local only</span>
  </div>
  <div id="room-badge-wrap" style="display:none">
    <div class="room-badge" onclick="openRoomModal()">‚ö° <span id="room-badge-code"></span></div>
  </div>

  <button class="add-btn" onclick="openModal()">+ New Event</button>
</nav>

<!-- ‚îÄ‚îÄ FIREBASE SETUP MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="fb-setup-overlay" onclick="if(event.target===this)closeFbSetup()">
  <div class="modal fb-modal">
    <div class="modal-title">Connect to Firebase</div>
    <div class="fb-info-box">
      Firebase lets you <strong>sync events across devices</strong> and <strong>collaborate in real-time</strong> using a shared room code ‚Äî no accounts needed. Your config is stored locally and never sent anywhere except Firebase itself.
    </div>
    <div class="fb-steps">
      <div class="fb-step">
        <div class="fb-step-num">1</div>
        <div class="fb-step-body">
          <div class="fb-step-title">Create a Firebase project</div>
          <div class="fb-step-sub">Go to <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a> ‚Üí Add project ‚Üí any name, disable Analytics ‚Üí Create.</div>
        </div>
      </div>
      <div class="fb-step">
        <div class="fb-step-num">2</div>
        <div class="fb-step-body">
          <div class="fb-step-title">Add a Web app &amp; copy the config</div>
          <div class="fb-step-sub">Project Overview ‚Üí &lt;/&gt; Web ‚Üí register app ‚Üí copy the <code style="background:var(--surface3);padding:1px 4px;border-radius:3px;font-size:0.9em">firebaseConfig</code> object shown.</div>
        </div>
      </div>
      <div class="fb-step">
        <div class="fb-step-num">3</div>
        <div class="fb-step-body">
          <div class="fb-step-title">Enable Firestore</div>
          <div class="fb-step-sub">Build ‚Üí Firestore Database ‚Üí Create database ‚Üí Start in <strong>test mode</strong> ‚Üí choose any region ‚Üí Enable.</div>
        </div>
      </div>
      <div class="fb-step">
        <div class="fb-step-num">4</div>
        <div class="fb-step-body">
          <div class="fb-step-title">Paste your config below</div>
          <div class="fb-step-sub" style="margin-bottom:8px">Paste the config <strong>exactly as shown</strong> in the Firebase console ‚Äî the full <code style="background:var(--surface3);padding:1px 4px;border-radius:3px;font-size:0.9em">const firebaseConfig = { ‚Ä¶ }</code> block works fine. No need to reformat it.</div>
          <textarea class="fb-config-area" id="fb-config-input" placeholder="Paste your config here, e.g.:&#10;&#10;const firebaseConfig = {&#10;  apiKey: &quot;AIza...&quot;,&#10;  authDomain: &quot;your-app.firebaseapp.com&quot;,&#10;  projectId: &quot;your-app&quot;,&#10;  storageBucket: &quot;your-app.appspot.com&quot;,&#10;  messagingSenderId: &quot;123456&quot;,&#10;  appId: &quot;1:123:web:abc&quot;&#10;};"></textarea>
          <div id="fb-config-error" style="color:var(--red);font-size:0.76rem;margin-top:5px;display:none"></div>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="fb-skip" onclick="closeFbSetup()">Skip for now</button>
      <button class="btn-save" onclick="connectFirebase()">Connect Firebase</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ ROOM MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="room-overlay" onclick="if(event.target===this)closeRoomModal()">
  <div class="modal room-modal">
    <div class="modal-title">Sync &amp; Collaboration</div>

    <!-- When connected to Firebase but no room -->
    <div id="room-no-firebase" style="display:none">
      <div class="fb-info-box" style="margin-bottom:14px">Firebase is not connected. Set it up first to use sync and rooms.</div>
      <div class="modal-actions" style="margin-top:0;padding-top:0;border-top:none">
        <button class="btn-cancel" onclick="closeRoomModal()">Close</button>
        <button class="btn-save" onclick="closeRoomModal();openFbSetup()">Connect Firebase</button>
      </div>
    </div>

    <!-- When Firebase connected -->
    <div id="room-firebase-panel" style="display:none">
      <!-- Current room (shown when in a room) -->
      <div id="room-active-section" style="display:none">
        <div class="room-section-title">Current Room</div>
        <div class="room-current">
          <div>
            <div class="room-current-code" id="room-active-code"></div>
            <div class="room-current-label">Shared with anyone using this code</div>
          </div>
          <button class="btn-leave" onclick="leaveRoom()">Leave</button>
        </div>
        <button class="btn-save" style="width:100%;margin-bottom:6px" onclick="copyRoomCode()">üìã Copy room code</button>
        <button class="btn-cancel" style="width:100%;text-align:center" onclick="closeRoomModal()">Done</button>
      </div>

      <!-- No room yet -->
      <div id="room-noroom-section" style="display:none">
        <div class="room-section">
          <div class="room-section-title">Create a new room</div>
          <div class="fb-info-box">A room lets multiple people share the same calendar in real-time. Anyone with the code can view and edit events.</div>
          <button class="btn-save" style="width:100%" onclick="createRoom()">‚ú¶ Create New Room</button>
        </div>
        <div class="room-divider">or join existing</div>
        <div class="room-section">
          <div class="room-section-title">Join a room</div>
          <div class="room-join-row">
            <input class="room-join-input" id="room-join-input" placeholder="ENTER CODE" maxlength="6"
              oninput="this.value=this.value.toUpperCase()"
              onkeydown="if(event.key==='Enter')joinRoom()" />
            <button class="btn-join" onclick="joinRoom()">Join</button>
          </div>
          <div id="room-join-error" style="color:var(--red);font-size:0.76rem;margin-top:6px;display:none"></div>
        </div>
        <div class="modal-actions" style="border-top:1px solid var(--border);padding-top:12px;margin-top:4px">
          <button class="btn-cancel" onclick="closeRoomModal()">Cancel</button>
          <button class="fb-skip" onclick="disconnectFirebase()" style="margin-left:auto">Disconnect Firebase</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden file input -->
<input type="file" id="file-input" style="display:none" />

<div class="main">
  <div class="sidebar" id="sidebar">

    <!-- Mini calendar -->
    <div id="mini-cal-section">
      <div class="mini-cal-header">
        <span class="mini-cal-title" id="mini-title"></span>
        <div style="display:flex;align-items:center;gap:3px">
          <button class="mini-arrow" onclick="miniNav(-1)">&#8249;</button>
          <button class="mini-arrow" onclick="miniNav(1)">&#8250;</button>
          <button class="mini-toggle-btn" onclick="toggleMiniCal()" title="Hide mini calendar">‚úï</button>
        </div>
      </div>
      <div class="mini-grid" id="mini-grid"></div>
    </div>

    <!-- Show button when hidden -->
    <div id="mini-show-row" style="display:none">
      <div class="section-title">Mini Calendar <button class="mini-toggle-btn" onclick="toggleMiniCal()">Show</button></div>
    </div>

    <!-- Upcoming -->
    <div id="upcoming-section">
      <div class="section-title">
        Upcoming
        <button class="mini-toggle-btn" onclick="toggleUpcoming()" id="upcoming-toggle-btn" title="Hide upcoming">‚úï</button>
      </div>
      <div id="upcoming-list"></div>
    </div>
    <div id="upcoming-show-row" style="display:none">
      <div class="section-title">Upcoming <button class="mini-toggle-btn" onclick="toggleUpcoming()">Show</button></div>
    </div>

    <!-- Labels -->
    <div id="labels-section">
      <div class="section-title">
        Labels
        <div style="display:flex;align-items:center;gap:4px">
          <button class="mini-toggle-btn" onclick="openLabelModal(null)" title="Add label">+ Add</button>
          <button class="mini-toggle-btn" onclick="toggleLabels()" id="labels-toggle-btn" title="Hide labels">‚úï</button>
        </div>
      </div>
      <div id="labels-list"></div>
    </div>
    <div id="labels-show-row" style="display:none">
      <div class="section-title">Labels <button class="mini-toggle-btn" onclick="toggleLabels()">Show</button></div>
    </div>

  </div>
  <div class="calendar-area" id="calendar-area"></div>
</div>

<!-- ‚îÄ‚îÄ EVENT MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="modal-overlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-title" id="modal-title">New Event</div>

    <div class="form-group">
      <label class="form-label">Title</label>
      <input class="form-input" id="ev-title" placeholder="Event title" />
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Date</label>
        <input class="form-input" id="ev-date" type="date" />
      </div>
      <div class="form-group">
        <label class="form-label">All Day</label>
        <select class="form-input" id="ev-allday" onchange="toggleTimeFields()">
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
    </div>
    <div id="time-fields" style="display:none">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Start Time</label>
          <input class="form-input" id="ev-start" type="time" value="09:00" />
        </div>
        <div class="form-group">
          <label class="form-label">End Time</label>
          <input class="form-input" id="ev-end" type="time" value="10:00" />
        </div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <input class="form-input" id="ev-desc" placeholder="Optional description" />
    </div>
    <div class="form-group">
      <label class="form-label">Label</label>
      <select class="form-input" id="ev-label" onchange="onLabelChange()">
        <option value="">‚Äî No label ‚Äî</option>
      </select>
      <div id="ev-label-preview" style="display:none;margin-top:7px;padding:6px 10px;border-radius:7px;font-size:0.78rem;font-weight:500;display:flex;align-items:center;gap:7px;">
        <span id="ev-label-preview-dot" style="width:9px;height:9px;border-radius:50%;flex-shrink:0;"></span>
        <span id="ev-label-preview-text"></span>
      </div>
    </div>

    <!-- RECURRENCE -->
    <div class="form-group">
      <label class="form-label">Repeat</label>
      <select class="form-input" id="ev-recur-type" onchange="onRecurTypeChange()">
        <option value="none">Does not repeat</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
      </select>
    </div>
    <div class="recur-section" id="recur-section" style="display:none">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Every</label>
          <input class="form-input" id="ev-recur-interval" type="number" min="1" max="99" value="1" />
        </div>
        <div class="form-group">
          <label class="form-label" id="recur-unit-label">day(s)</label>
          <select class="form-input" id="ev-recur-end-type" onchange="onRecurEndChange()">
            <option value="never">Never ends</option>
            <option value="on">Ends on date</option>
            <option value="after">Ends after N times</option>
          </select>
        </div>
      </div>
      <div class="form-group" id="recur-end-date-row" style="display:none">
        <label class="form-label">End Date</label>
        <input class="form-input" id="ev-recur-end-date" type="date" />
      </div>
      <div class="form-group" id="recur-end-count-row" style="display:none">
        <label class="form-label">Occurrences</label>
        <input class="form-input" id="ev-recur-count" type="number" min="1" max="999" value="10" />
      </div>
    </div>

    <div class="modal-actions" id="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="saveEvent()">Save Event</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ COPY MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="copy-overlay" onclick="if(event.target===this)closeCopyModal()">
  <div class="modal copy-modal">
    <div class="modal-title">Copy Event</div>
    <p>Choose a new date to copy <strong id="copy-ev-name" style="color:var(--text)"></strong> to. A new standalone copy will be created.</p>
    <div class="form-group">
      <label class="form-label">Copy to Date</label>
      <input class="form-input" id="copy-date" type="date" />
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeCopyModal()">Cancel</button>
      <button class="btn-save" onclick="confirmCopy()">Copy Event</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ DELETE RECUR DIALOG ‚îÄ‚îÄ -->
<div class="overlay" id="del-overlay" onclick="if(event.target===this)closeDelDialog()">
  <div class="modal del-dialog">
    <div class="modal-title">Delete Recurring Event</div>
    <p>How would you like to delete <strong id="del-ev-name" style="color:var(--text)"></strong>?</p>
    <div class="del-choice">
      <label class="del-opt"><input type="radio" name="del-scope" value="this" checked /><div><div class="del-opt-label">This occurrence only</div><div class="del-opt-sub">Removes just this one date from the series</div></div></label>
      <label class="del-opt"><input type="radio" name="del-scope" value="future" /><div><div class="del-opt-label">This and following events</div><div class="del-opt-sub">Ends the series at this date</div></div></label>
      <label class="del-opt"><input type="radio" name="del-scope" value="all" /><div><div class="del-opt-label">All occurrences</div><div class="del-opt-sub">Deletes the entire repeating series</div></div></label>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeDelDialog()">Cancel</button>
      <button class="btn-delete" style="margin-right:0" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ LABEL MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="label-overlay" onclick="if(event.target===this)closeLabelModal()">
  <div class="modal label-modal">
    <div class="modal-title" id="label-modal-title">New Label</div>
    <div class="form-group">
      <label class="form-label">Label Name</label>
      <input class="form-input" id="lbl-name" placeholder="e.g. Work, Personal, Health‚Ä¶" />
    </div>
    <div class="form-group">
      <label class="form-label">Color</label>
      <div class="label-color-row" id="label-color-picker"></div>
    </div>
    <div class="modal-actions" id="label-modal-actions">
      <button class="btn-cancel" onclick="closeLabelModal()">Cancel</button>
      <button class="btn-save" onclick="saveLabel()">Save Label</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ IMPORT MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="import-overlay" onclick="if(event.target===this)closeImportModal()">
  <div class="modal import-modal">
    <div class="modal-title" id="import-modal-title">Import Events</div>

    <div class="import-drop-zone" id="import-drop-zone" onclick="triggerFileInput()">
      <div class="dz-icon" id="dz-icon">üìÅ</div>
      <div class="dz-title" id="dz-title">Click to choose a file</div>
      <div class="dz-sub" id="dz-sub">or drag & drop here</div>
      <div class="dz-file" id="dz-file"></div>
    </div>

    <div class="import-preview" id="import-preview">
      <div class="ip-stat" id="ip-count"></div>
      <div class="ip-stat" id="ip-range"></div>
    </div>

    <div style="margin-bottom:6px">
      <label class="form-label">Import mode</label>
      <div class="import-mode">
        <button class="import-mode-opt selected" id="mode-merge" onclick="setImportMode('merge')">
          Merge
        </button>
        <button class="import-mode-opt" id="mode-replace" onclick="setImportMode('replace')">
          Replace all
        </button>
      </div>
      <div class="import-mode-sub" id="import-mode-desc">Add imported events alongside existing ones ‚Äî duplicates get new IDs.</div>
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeImportModal()">Cancel</button>
      <button class="btn-save" id="import-confirm-btn" onclick="confirmImport()" disabled style="opacity:0.4;cursor:not-allowed">Import Events</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ EVENT POPUP ‚îÄ‚îÄ -->
<div class="event-popup" id="event-popup">
  <div class="ep-header">
    <div class="ep-color" id="ep-color"></div>
    <div class="ep-title" id="ep-title"></div>
    <button class="ep-close" onclick="closePopup()">√ó</button>
  </div>
  <div class="ep-meta" id="ep-date-meta"></div>
  <div class="ep-meta" id="ep-time-meta"></div>
  <div id="ep-recur-badge" class="ep-recur-badge" style="display:none">‚Üª <span id="ep-recur-text"></span></div>
  <div id="ep-label-badge" class="ep-label-badge" style="display:none"><span class="ep-label-dot" id="ep-label-dot"></span><span id="ep-label-text"></span></div>
  <div class="ep-desc" id="ep-desc" style="display:none"></div>
  <div class="ep-actions">
    <button class="ep-btn" onclick="editEventFromPopup()">‚úè Edit</button>
    <button class="ep-btn success" onclick="copyEventFromPopup()">‚éò Copy to‚Ä¶</button>
    <button class="ep-btn danger" onclick="deleteEventFromPopup()">üóë Delete</button>
  </div>
</div>

<div id="toast"></div>

<script>
const COLORS=[{name:'violet',hex:'#7c6af7'},{name:'pink',hex:'#f472b6'},{name:'red',hex:'#f87171'},{name:'orange',hex:'#fb923c'},{name:'yellow',hex:'#fbbf24'},{name:'green',hex:'#4ade80'},{name:'teal',hex:'#2dd4bf'},{name:'blue',hex:'#60a5fa'}];
const DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const RECUR_UNITS={daily:'day(s)',weekly:'week(s)',monthly:'month(s)',yearly:'year(s)'};
const RECUR_NICE={daily:'Daily',weekly:'Weekly',monthly:'Monthly',yearly:'Yearly'};

let view='month',today=new Date();
let cursor=new Date(today.getFullYear(),today.getMonth(),1);
let miniCursor=new Date(today.getFullYear(),today.getMonth(),1);
let events=[],selectedColor=COLORS[0].hex,editingId=null,popupEventId=null,popupEventDate=null;
let sidebarVisible=true,miniCalVisible=true,upcomingVisible=true,labelsVisible=true;
let delTargetId=null,delTargetDate=null,copySourceId=null;
let labels=[],selectedLabelColor=COLORS[1].hex,editingLabelId=null;

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ
function loadEvents(){try{events=JSON.parse(localStorage.getItem('calioEvents')||'[]');}catch{events=[];}}
function saveEvents(){localStorage.setItem('calioEvents',JSON.stringify(events));}
function loadLabels(){try{labels=JSON.parse(localStorage.getItem('calioLabels')||'[]');}catch{labels=[];}}
function saveLabels(){localStorage.setItem('calioLabels',JSON.stringify(labels));}
function loadPrefs(){
  const p=JSON.parse(localStorage.getItem('calioPrefs')||'{}');
  sidebarVisible=p.sidebarVisible!==false;
  miniCalVisible=p.miniCalVisible!==false;
  upcomingVisible=p.upcomingVisible!==false;
  labelsVisible=p.labelsVisible!==false;
  applyPrefs();
}
function savePrefs(){localStorage.setItem('calioPrefs',JSON.stringify({sidebarVisible,miniCalVisible,upcomingVisible,labelsVisible}));}
function applyPrefs(){
  document.getElementById('sidebar').classList.toggle('collapsed',!sidebarVisible);
  document.getElementById('sidebar-toggle-btn').classList.toggle('active',sidebarVisible);
  document.getElementById('mini-cal-section').style.display=miniCalVisible?'':'none';
  document.getElementById('mini-show-row').style.display=miniCalVisible?'none':'';
  document.getElementById('upcoming-section').style.display=upcomingVisible?'':'none';
  document.getElementById('upcoming-show-row').style.display=upcomingVisible?'none':'';
  document.getElementById('labels-section').style.display=labelsVisible?'':'none';
  document.getElementById('labels-show-row').style.display=labelsVisible?'none':'';
}
loadEvents();loadLabels();loadPrefs();

function uuid(){return Date.now().toString(36)+Math.random().toString(36).slice(2);}

// ‚îÄ‚îÄ VIEW/NAV ‚îÄ‚îÄ
function setView(v){
  view=v;
  ['month','week','day'].forEach(x=>document.getElementById('btn-'+x).classList.toggle('active',x===v));
  if(v==='day') cursor=new Date(today.getFullYear(),today.getMonth(),today.getDate());
  render();
}
function navigate(dir){
  if(view==='month') cursor=new Date(cursor.getFullYear(),cursor.getMonth()+dir,1);
  else if(view==='week') cursor=new Date(cursor.getFullYear(),cursor.getMonth(),cursor.getDate()+dir*7);
  else cursor=new Date(cursor.getFullYear(),cursor.getMonth(),cursor.getDate()+dir);
  render();
}
function goToday(){today=new Date();cursor=view==='month'?new Date(today.getFullYear(),today.getMonth(),1):new Date(today);render();}
function miniNav(dir){miniCursor=new Date(miniCursor.getFullYear(),miniCursor.getMonth()+dir,1);renderMini();}
function toggleSidebar(){sidebarVisible=!sidebarVisible;applyPrefs();savePrefs();}
function toggleMiniCal(){miniCalVisible=!miniCalVisible;applyPrefs();savePrefs();if(miniCalVisible)renderMini();}
function toggleUpcoming(){upcomingVisible=!upcomingVisible;applyPrefs();savePrefs();}
function toggleLabels(){labelsVisible=!labelsVisible;applyPrefs();savePrefs();}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function isSameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
function fmtDate(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function parseDate(s){return new Date(s+'T12:00:00');}
function addDays(d,n){const r=new Date(d);r.setDate(r.getDate()+n);return r;}

// ‚îÄ‚îÄ RECURRENCE ‚îÄ‚îÄ
function matchesRecur(ev,d){
  const r=ev.recurrence;
  if(!r||r.type==='none') return false;
  const base=parseDate(ev.date);
  const check=parseDate(fmtDate(d));
  if(check<base) return false;
  const intv=Math.max(1,parseInt(r.interval)||1);
  const ds=fmtDate(d);
  if(r.endType==='on'&&r.endDate&&ds>r.endDate) return false;
  let idx=-1;
  if(r.type==='daily'){
    const diff=Math.round((check-base)/86400000);
    if(diff%intv!==0) return false;
    idx=diff/intv;
  } else if(r.type==='weekly'){
    if(d.getDay()!==base.getDay()) return false;
    const diff=Math.round((check-base)/86400000);
    if((diff/7)%intv!==0) return false;
    idx=(diff/7)/intv;
  } else if(r.type==='monthly'){
    if(d.getDate()!==base.getDate()) return false;
    const dm=(d.getFullYear()-base.getFullYear())*12+(d.getMonth()-base.getMonth());
    if(dm%intv!==0) return false;
    idx=dm/intv;
  } else if(r.type==='yearly'){
    if(d.getDate()!==base.getDate()||d.getMonth()!==base.getMonth()) return false;
    const dy=d.getFullYear()-base.getFullYear();
    if(dy%intv!==0) return false;
    idx=dy/intv;
  }
  if(idx<0) return false;
  if(r.endType==='after'&&idx>=parseInt(r.count||10)) return false;
  if(ev.exceptions&&ev.exceptions.includes(ds)) return false;
  return true;
}

function recurSummary(ev){
  const r=ev.recurrence;if(!r||r.type==='none') return '';
  const intv=parseInt(r.interval)||1;
  let s=intv===1?RECUR_NICE[r.type]:'Every '+intv+' '+RECUR_UNITS[r.type];
  if(r.endType==='on'&&r.endDate) s+=' until '+r.endDate;
  else if(r.endType==='after') s+=', '+r.count+' times';
  return s;
}

function eventsForDate(d){
  const ds=fmtDate(d);
  return events.filter(ev=>{
    // Filter by label visibility
    if(ev.labelId){const lbl=labels.find(l=>l.id===ev.labelId);if(lbl&&lbl.visible===false)return false;}
    if(ev.recurrence&&ev.recurrence.type!=='none') return matchesRecur(ev,d);
    return ev.date===ds;
  }).sort((a,b)=>{
    if(a.allDay&&!b.allDay) return -1;if(!a.allDay&&b.allDay) return 1;
    return (a.start||'').localeCompare(b.start||'');
  });
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function render(){renderTitle();renderMini();renderCalendar();renderUpcoming();renderLabels();}

function renderTitle(){
  const t=document.getElementById('main-title');
  if(view==='month') t.textContent=MONTHS[cursor.getMonth()]+' '+cursor.getFullYear();
  else if(view==='week'){
    const ws=getWeekStart(cursor),we=addDays(ws,6);
    t.textContent=MONTHS[ws.getMonth()].slice(0,3)+' '+ws.getDate()+' ‚Äì '+(ws.getMonth()!==we.getMonth()?MONTHS[we.getMonth()].slice(0,3)+' ':'')+we.getDate()+', '+we.getFullYear();
  } else t.textContent=DAYS[cursor.getDay()]+', '+MONTHS[cursor.getMonth()]+' '+cursor.getDate()+', '+cursor.getFullYear();
}
function getWeekStart(d){return new Date(d.getFullYear(),d.getMonth(),d.getDate()-d.getDay());}

function renderMini(){
  if(!miniCalVisible) return;
  document.getElementById('mini-title').textContent=MONTHS[miniCursor.getMonth()].slice(0,3)+' '+miniCursor.getFullYear();
  const grid=document.getElementById('mini-grid');grid.innerHTML='';
  DAYS.forEach(d=>{const el=document.createElement('div');el.className='mini-day-label';el.textContent=d[0];grid.appendChild(el);});
  const first=new Date(miniCursor.getFullYear(),miniCursor.getMonth(),1);
  const sd=first.getDay();
  for(let i=0;i<sd;i++) addMiniDay(grid,new Date(miniCursor.getFullYear(),miniCursor.getMonth(),1-sd+i),true);
  const dim=new Date(miniCursor.getFullYear(),miniCursor.getMonth()+1,0).getDate();
  for(let d=1;d<=dim;d++) addMiniDay(grid,new Date(miniCursor.getFullYear(),miniCursor.getMonth(),d),false);
  for(let i=1;i<=42-sd-dim;i++) addMiniDay(grid,new Date(miniCursor.getFullYear(),miniCursor.getMonth()+1,i),true);
}
function addMiniDay(grid,date,other){
  const el=document.createElement('div');
  el.className='mini-day'+(other?' other-month':'')+(isSameDay(date,today)?' today':'');
  el.textContent=date.getDate();
  el.onclick=()=>{
    // Navigate the main calendar to this date
    if(view==='month') cursor=new Date(date.getFullYear(),date.getMonth(),1);
    else cursor=new Date(date);
    render();
    // Also open event creation for that date
    openModal(fmtDate(date));
  };
  grid.appendChild(el);
}

function renderCalendar(){
  const area=document.getElementById('calendar-area');area.innerHTML='';
  if(view==='month') renderMonth(area);
  else if(view==='week') renderWeek(area);
  else renderDay(area);
}

// ‚îÄ‚îÄ MONTH ‚îÄ‚îÄ
function renderMonth(area){
  const mv=document.createElement('div');mv.className='month-view';
  const dh=document.createElement('div');dh.className='day-headers';
  DAYS.forEach(d=>{const el=document.createElement('div');el.className='day-header';el.textContent=d;dh.appendChild(el);});
  mv.appendChild(dh);
  const grid=document.createElement('div');grid.className='month-grid';
  const first=new Date(cursor.getFullYear(),cursor.getMonth(),1);
  const sd=first.getDay(),dim=new Date(cursor.getFullYear(),cursor.getMonth()+1,0).getDate();
  for(let i=0;i<sd;i++) grid.appendChild(makeCell(new Date(cursor.getFullYear(),cursor.getMonth(),1-sd+i),true));
  for(let d=1;d<=dim;d++) grid.appendChild(makeCell(new Date(cursor.getFullYear(),cursor.getMonth(),d),false));
  for(let i=1;i<=42-sd-dim;i++) grid.appendChild(makeCell(new Date(cursor.getFullYear(),cursor.getMonth()+1,i),true));
  mv.appendChild(grid);area.appendChild(mv);
}
function makeCell(date,other){
  const cell=document.createElement('div');
  cell.className='day-cell'+(other?' other-month':'')+(isSameDay(date,today)?' today':'');
  cell.onclick=e=>{if(e.target===cell||e.target.classList.contains('day-num-inner'))openModal(fmtDate(date));};
  const dn=document.createElement('div');dn.className='day-num';
  const num=document.createElement('div');num.className='day-num-inner';num.textContent=date.getDate();
  dn.appendChild(num);cell.appendChild(dn);
  const evs=eventsForDate(date);
  evs.slice(0,3).forEach(ev=>cell.appendChild(makePill(ev,date)));
  if(evs.length>3){const m=document.createElement('div');m.className='more-events';m.textContent='+'+(evs.length-3)+' more';cell.appendChild(m);}
  return cell;
}
function makePill(ev,date){
  const p=document.createElement('div');p.className='event-pill';
  p.style.borderLeftColor=ev.color;p.style.background=ev.color+'20';
  const dot=document.createElement('div');dot.className='pill-dot';dot.style.background=ev.color;
  const txt=document.createElement('div');txt.className='pill-text';txt.textContent=ev.title;
  p.appendChild(dot);p.appendChild(txt);
  if(ev.labelId){const lbl=labels.find(l=>l.id===ev.labelId);if(lbl){const lt=document.createElement('span');lt.className='pill-label';lt.textContent=lbl.name;lt.style.background=lbl.color+'30';lt.style.color=lbl.color;p.appendChild(lt);}}
  if(ev.recurrence&&ev.recurrence.type!=='none'){const r=document.createElement('span');r.className='pill-recur';r.textContent='‚Üª';p.appendChild(r);}
  p.onclick=e=>{e.stopPropagation();showPopup(ev.id,date,e);};
  return p;
}

// ‚îÄ‚îÄ WEEK ‚îÄ‚îÄ
function renderWeek(area){
  const wv=document.createElement('div');wv.className='week-view';
  const ws=getWeekStart(cursor);
  const wh=document.createElement('div');wh.className='week-header';
  const c=document.createElement('div');c.style.cssText='border-right:1px solid var(--border)';wh.appendChild(c);
  for(let i=0;i<7;i++){
    const d=addDays(ws,i);
    const h=document.createElement('div');h.className='week-day-header';
    const nm=document.createElement('div');nm.className='wdh-name';nm.textContent=DAYS[d.getDay()];
    const nu=document.createElement('div');nu.className='wdh-num'+(isSameDay(d,today)?' today':'');nu.textContent=d.getDate();
    h.appendChild(nm);h.appendChild(nu);wh.appendChild(h);
  }
  wv.appendChild(wh);

  // All-day strip
  const adr=document.createElement('div');adr.className='allday-row week-allday';
  const adg=document.createElement('div');adg.className='allday-gutter';adg.textContent='All-day';adr.appendChild(adg);
  for(let i=0;i<7;i++){
    const d=addDays(ws,i);
    const cell=document.createElement('div');cell.className='allday-cell';
    eventsForDate(d).filter(ev=>ev.allDay).forEach(ev=>{
      cell.appendChild(makeAlldayPill(ev,d));
    });
    adr.appendChild(cell);
  }
  wv.appendChild(adr);

  const wb=document.createElement('div');wb.className='week-body';
  const tc=makeTimeCol();wb.appendChild(tc);
  for(let i=0;i<7;i++) wb.appendChild(makeTimeColumn(addDays(ws,i)));
  wv.appendChild(wb);area.appendChild(wv);
  setTimeout(()=>{wb.scrollTop=30+8*60;},10);
}
function makeTimeCol(){
  const tc=document.createElement('div');tc.className='time-col';
  const bl=document.createElement('div');bl.style.height='30px';tc.appendChild(bl);
  for(let h=0;h<24;h++){const tl=document.createElement('div');tl.className='time-label';tl.textContent=h===0?'12 AM':h<12?h+' AM':h===12?'12 PM':(h-12)+' PM';tc.appendChild(tl);}
  return tc;
}
function makeTimeColumn(d){
  const col=document.createElement('div');col.className='week-day-col';
  const bl=document.createElement('div');bl.style.height='30px';col.appendChild(bl);
  for(let h=0;h<24;h++){const hl=document.createElement('div');hl.className='hour-line';hl.style.top=(30+h*60)+'px';col.appendChild(hl);}
  if(isSameDay(d,today)){
    const now=new Date(),tp=30+now.getHours()*60+now.getMinutes();
    const nl=document.createElement('div');nl.className='now-line';nl.style.top=tp+'px';
    const nd=document.createElement('div');nd.className='now-dot';nl.appendChild(nd);col.appendChild(nl);
  }
  col.onclick=e=>{
    if(e.target===col){
      const y=e.clientY-col.getBoundingClientRect().top-30;
      const h=Math.max(0,Math.floor(y/60));
      openModal(fmtDate(d),String(h).padStart(2,'0')+':00',String(Math.min(23,h+1)).padStart(2,'0')+':00');
    }
  };
  eventsForDate(d).filter(ev=>!ev.allDay).forEach(ev=>col.appendChild(makeWeekEvent(ev,d)));
  return col;
}
function makeAlldayPill(ev,date){
  const p=document.createElement('div');p.className='allday-pill';
  p.style.borderLeftColor=ev.color;p.style.background=ev.color+'22';
  const dot=document.createElement('div');dot.className='allday-pill-dot';dot.style.background=ev.color;
  const txt=document.createElement('div');txt.className='allday-pill-text';txt.textContent=ev.title;
  p.appendChild(dot);p.appendChild(txt);
  if(ev.recurrence&&ev.recurrence.type!=='none'){const r=document.createElement('span');r.style.cssText='font-size:0.58rem;opacity:0.7;flex-shrink:0';r.textContent='‚Üª';p.appendChild(r);}
  p.onclick=e=>{e.stopPropagation();showPopup(ev.id,date,e);};
  return p;
}
function makeWeekEvent(ev,date){
  const we=document.createElement('div');we.className='week-event';
  const [sh,sm]=ev.start.split(':').map(Number),[eh,em]=ev.end.split(':').map(Number);
  const t=30+sh*60+sm,h=(eh*60+em)-(sh*60+sm);
  we.style.top=t+'px';we.style.height=Math.max(22,h)+'px';
  we.style.borderLeftColor=ev.color;we.style.background=ev.color+'20';
  const wt=document.createElement('div');wt.className='we-title';wt.textContent=ev.title+(ev.recurrence&&ev.recurrence.type!=='none'?' ‚Üª':'');
  const wtime=document.createElement('div');wtime.className='we-time';wtime.textContent=ev.start+' ‚Äì '+ev.end;
  we.appendChild(wt);we.appendChild(wtime);
  we.onclick=e=>{e.stopPropagation();showPopup(ev.id,date,e);};
  return we;
}

// ‚îÄ‚îÄ DAY ‚îÄ‚îÄ
function renderDay(area){
  const dv=document.createElement('div');dv.className='day-view';
  const dhb=document.createElement('div');dhb.className='day-header-bar';
  const dn=document.createElement('div');dn.className='dhb-name';dn.textContent=DAYS[cursor.getDay()];
  const dnum=document.createElement('div');dnum.className='dhb-num';dnum.textContent=cursor.getDate();
  dhb.appendChild(dn);dhb.appendChild(dnum);dv.appendChild(dhb);

  // All-day strip
  const allDayEvs=eventsForDate(cursor).filter(ev=>ev.allDay);
  if(allDayEvs.length){
    const adr=document.createElement('div');adr.className='allday-row day-allday';
    const adg=document.createElement('div');adg.className='allday-gutter';adg.textContent='All-day';adr.appendChild(adg);
    const cell=document.createElement('div');cell.className='allday-cell';cell.style.borderRight='none';
    allDayEvs.forEach(ev=>cell.appendChild(makeAlldayPill(ev,cursor)));
    adr.appendChild(cell);
    dv.appendChild(adr);
  }

  const db=document.createElement('div');db.className='day-body';
  db.appendChild(makeTimeCol());
  const col=makeTimeColumn(cursor);col.style.borderRight='none';
  db.appendChild(col);dv.appendChild(db);area.appendChild(dv);
  setTimeout(()=>{db.scrollTop=30+8*60;},10);
}

// ‚îÄ‚îÄ UPCOMING ‚îÄ‚îÄ
function renderUpcoming(){
  const list=document.getElementById('upcoming-list');list.innerHTML='';
  const seen=new Set(),upcoming=[];
  for(let i=0;i<120&&upcoming.length<7;i++){
    const d=addDays(today,i);
    eventsForDate(d).forEach(ev=>{
      const k=ev.id+':'+fmtDate(d);
      if(!seen.has(k)){seen.add(k);upcoming.push({ev,date:d});}
    });
  }
  if(!upcoming.length){list.innerHTML='<div class="no-events">No upcoming events</div>';return;}
  upcoming.slice(0,6).forEach(({ev,date})=>{
    const el=document.createElement('div');el.className='upcoming-event';el.style.borderLeftColor=ev.color;
    const t=document.createElement('div');t.className='ev-title';
    t.innerHTML=ev.title+(ev.recurrence&&ev.recurrence.type!=='none'?'<span class="recur-badge">‚Üª</span>':'');
    const d=document.createElement('div');d.className='ev-date';
    d.textContent=MONTHS[date.getMonth()].slice(0,3)+' '+date.getDate()+(ev.allDay?'':' ¬∑ '+ev.start);
    el.appendChild(t);el.appendChild(d);
    el.onclick=()=>showPopup(ev.id,date,{clientX:window.innerWidth/2,clientY:window.innerHeight/2});
    list.appendChild(el);
  });
}

// ‚îÄ‚îÄ COLOR PICKER ‚îÄ‚îÄ
function buildColorPicker(){
  const cp=document.getElementById('color-picker');cp.innerHTML='';
  COLORS.forEach(c=>{
    const sw=document.createElement('div');sw.className='color-swatch'+(selectedColor===c.hex?' selected':'');
    sw.style.background=c.hex;sw.title=c.name;
    sw.onclick=()=>{selectedColor=c.hex;buildColorPicker();};
    cp.appendChild(sw);
  });
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(dateStr,startT,endT){
  editingId=null;
  document.getElementById('modal-title').textContent='New Event';
  document.getElementById('ev-title').value='';
  document.getElementById('ev-date').value=dateStr||fmtDate(today);
  document.getElementById('ev-desc').value='';
  document.getElementById('ev-allday').value=startT?'no':'yes';
  document.getElementById('ev-start').value=startT||'09:00';
  document.getElementById('ev-end').value=endT||'10:00';
  document.getElementById('ev-recur-type').value='none';
  document.getElementById('ev-recur-interval').value='1';
  document.getElementById('ev-recur-end-type').value='never';
  document.getElementById('ev-recur-end-date').value='';
  document.getElementById('ev-recur-count').value='10';
  toggleTimeFields();onRecurTypeChange();onRecurEndChange();
  populateLabelDropdown('');
  document.getElementById('modal-actions').innerHTML=`<button class="btn-cancel" onclick="closeModal()">Cancel</button><button class="btn-save" onclick="saveEvent()">Save Event</button>`;
  document.getElementById('modal-overlay').classList.add('open');
  setTimeout(()=>document.getElementById('ev-title').focus(),100);
}
function openEditModal(id){
  const ev=events.find(e=>e.id===id);if(!ev)return;
  closePopup();editingId=id;
  document.getElementById('modal-title').textContent='Edit Event';
  document.getElementById('ev-title').value=ev.title;
  document.getElementById('ev-date').value=ev.date;
  document.getElementById('ev-desc').value=ev.description||'';
  document.getElementById('ev-allday').value=ev.allDay?'yes':'no';
  document.getElementById('ev-start').value=ev.start||'09:00';
  document.getElementById('ev-end').value=ev.end||'10:00';
  const r=ev.recurrence||{type:'none'};
  document.getElementById('ev-recur-type').value=r.type||'none';
  document.getElementById('ev-recur-interval').value=r.interval||1;
  document.getElementById('ev-recur-end-type').value=r.endType||'never';
  document.getElementById('ev-recur-end-date').value=r.endDate||'';
  document.getElementById('ev-recur-count').value=r.count||10;
  toggleTimeFields();onRecurTypeChange();onRecurEndChange();
  populateLabelDropdown(ev.labelId||'');
  document.getElementById('modal-actions').innerHTML=`<button class="btn-delete" onclick="handleDeleteEdit('${id}')">Delete</button><button class="btn-cancel" onclick="closeModal()">Cancel</button><button class="btn-save" onclick="saveEvent()">Save Changes</button>`;
  document.getElementById('modal-overlay').classList.add('open');
}
function closeModal(){document.getElementById('modal-overlay').classList.remove('open');}
function handleOverlayClick(e){if(e.target===document.getElementById('modal-overlay'))closeModal();}
function toggleTimeFields(){document.getElementById('time-fields').style.display=document.getElementById('ev-allday').value==='yes'?'none':'block';}
function onRecurTypeChange(){
  const t=document.getElementById('ev-recur-type').value;
  document.getElementById('recur-section').style.display=t==='none'?'none':'block';
  if(t!=='none') document.getElementById('recur-unit-label').textContent=RECUR_UNITS[t];
}
function onRecurEndChange(){
  const et=document.getElementById('ev-recur-end-type').value;
  document.getElementById('recur-end-date-row').style.display=et==='on'?'block':'none';
  document.getElementById('recur-end-count-row').style.display=et==='after'?'block':'none';
}

function saveEvent(){
  const title=document.getElementById('ev-title').value.trim();
  if(!title){document.getElementById('ev-title').style.borderColor='var(--red)';setTimeout(()=>document.getElementById('ev-title').style.borderColor='',1500);return;}
  const allDay=document.getElementById('ev-allday').value==='yes';
  const rType=document.getElementById('ev-recur-type').value;
  const recurrence=rType==='none'?{type:'none'}:{
    type:rType,
    interval:Math.max(1,parseInt(document.getElementById('ev-recur-interval').value)||1),
    endType:document.getElementById('ev-recur-end-type').value,
    endDate:document.getElementById('ev-recur-end-date').value||null,
    count:Math.max(1,parseInt(document.getElementById('ev-recur-count').value)||10),
  };
  const existing=editingId?events.find(e=>e.id===editingId):null;
  const ev={
    id:editingId||uuid(),title,
    date:document.getElementById('ev-date').value,
    allDay,
    start:allDay?null:document.getElementById('ev-start').value,
    end:allDay?null:document.getElementById('ev-end').value,
    description:document.getElementById('ev-desc').value.trim(),
    color:(()=>{const lid=document.getElementById('ev-label').value;if(lid){const l=labels.find(x=>x.id===lid);if(l)return l.color;}return COLORS[0].hex;})(),recurrence,
    labelId:document.getElementById('ev-label').value||null,
    exceptions:existing?existing.exceptions||[]:[]
  };
  if(editingId){const idx=events.findIndex(e=>e.id===editingId);if(idx>=0)events[idx]=ev;}
  else events.push(ev);
  localStorage.setItem('calioEvents',JSON.stringify(events));
  _fbPushEvent(ev);
  closeModal();render();
}

function handleDeleteEdit(id){
  closeModal();
  const ev=events.find(e=>e.id===id);
  if(ev?.recurrence?.type!=='none') openDelDialog(id,parseDate(ev.date));
  else{const _did=id;events=events.filter(e=>e.id!==_did);localStorage.setItem('calioEvents',JSON.stringify(events));_fbDeleteEventDoc(_did);render();}
}

// ‚îÄ‚îÄ DELETE DIALOG ‚îÄ‚îÄ
function openDelDialog(id,date){
  delTargetId=id;delTargetDate=date;
  const ev=events.find(e=>e.id===id);
  document.getElementById('del-ev-name').textContent=ev?ev.title:'';
  document.querySelector('input[name="del-scope"][value="this"]').checked=true;
  document.getElementById('del-overlay').classList.add('open');
}
function closeDelDialog(){document.getElementById('del-overlay').classList.remove('open');delTargetId=null;delTargetDate=null;}
function confirmDelete(){
  if(!delTargetId) return;
  const ev=events.find(e=>e.id===delTargetId);
  if(!ev){closeDelDialog();return;}
  const scope=document.querySelector('input[name="del-scope"]:checked').value;
  if(scope==='all'){
    events=events.filter(e=>e.id!==delTargetId);
  } else if(scope==='this'&&delTargetDate){
    if(!ev.exceptions) ev.exceptions=[];
    ev.exceptions.push(fmtDate(delTargetDate));
  } else if(scope==='future'&&delTargetDate){
    if(!ev.recurrence) ev.recurrence={};
    ev.recurrence.endType='on';
    ev.recurrence.endDate=fmtDate(addDays(delTargetDate,-1));
  } else {
    events=events.filter(e=>e.id!==delTargetId);
  }
  localStorage.setItem('calioEvents',JSON.stringify(events));
  // Push updated/deleted docs to Firestore
  if(scope==='all'){ _fbDeleteEventDoc(delTargetId); }
  else { const _upd=events.find(e=>e.id===delTargetId); if(_upd) _fbPushEvent(_upd); }
  closeDelDialog();closePopup();render();
}

// ‚îÄ‚îÄ COPY ‚îÄ‚îÄ
function openCopyModal(id){
  copySourceId=id;
  const ev=events.find(e=>e.id===id);
  document.getElementById('copy-ev-name').textContent=ev?ev.title:'';
  document.getElementById('copy-date').value=fmtDate(today);
  document.getElementById('copy-overlay').classList.add('open');
}
function closeCopyModal(){document.getElementById('copy-overlay').classList.remove('open');copySourceId=null;}
function confirmCopy(){
  if(!copySourceId) return;
  const ev=events.find(e=>e.id===copySourceId);if(!ev) return;
  const nd=document.getElementById('copy-date').value;
  if(!nd) return;
  const newEv={...ev,id:uuid(),date:nd,recurrence:{type:'none'},exceptions:[]};
  events.push(newEv);
  localStorage.setItem('calioEvents',JSON.stringify(events));
  _fbPushEvent(newEv);
  closeCopyModal();closePopup();render();
  showToast('Copied "'+ev.title+'" to '+nd);
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.opacity='1';
  clearTimeout(t._t);t._t=setTimeout(()=>t.style.opacity='0',2600);
}

// ‚îÄ‚îÄ POPUP ‚îÄ‚îÄ
function showPopup(id,date,e){
  closePopup();
  const ev=events.find(x=>x.id===id);if(!ev) return;
  popupEventId=id;popupEventDate=date;
  const p=document.getElementById('event-popup');
  document.getElementById('ep-color').style.background=ev.color;
  document.getElementById('ep-title').textContent=ev.title;
  const dt=date instanceof Date?date:parseDate(ev.date);
  document.getElementById('ep-date-meta').textContent='üìÖ '+DAYS[dt.getDay()]+', '+MONTHS[dt.getMonth()]+' '+dt.getDate()+', '+dt.getFullYear();
  document.getElementById('ep-time-meta').textContent=ev.allDay?'üóì All day':'üïê '+ev.start+' ‚Äì '+ev.end;
  const rs=recurSummary(ev);
  const badge=document.getElementById('ep-recur-badge');
  if(rs){badge.style.display='inline-flex';document.getElementById('ep-recur-text').textContent=rs;}else{badge.style.display='none';}
  const lblBadge=document.getElementById('ep-label-badge');
  if(ev.labelId){const lbl=labels.find(l=>l.id===ev.labelId);if(lbl){lblBadge.style.display='inline-flex';lblBadge.style.background=lbl.color+'22';lblBadge.style.color=lbl.color;document.getElementById('ep-label-dot').style.background=lbl.color;document.getElementById('ep-label-text').textContent=lbl.name;}else{lblBadge.style.display='none';}}else{lblBadge.style.display='none';}
  const desc=document.getElementById('ep-desc');
  if(ev.description){desc.textContent=ev.description;desc.style.display='block';}else{desc.style.display='none';}
  p.classList.add('open');
  const px=Math.min(e.clientX+12,window.innerWidth-305);
  const py=Math.min(e.clientY+12,window.innerHeight-230);
  p.style.left=px+'px';p.style.top=py+'px';
}
function closePopup(){document.getElementById('event-popup').classList.remove('open');popupEventId=null;popupEventDate=null;}
function editEventFromPopup(){if(popupEventId)openEditModal(popupEventId);}
function copyEventFromPopup(){if(popupEventId){closePopup();openCopyModal(popupEventId);}}
function deleteEventFromPopup(){
  if(!popupEventId) return;
  const ev=events.find(e=>e.id===popupEventId);
  if(ev?.recurrence?.type!=='none'){
    const d=popupEventDate;closePopup();openDelDialog(ev.id,d);
  } else {
    const _pid=popupEventId;events=events.filter(e=>e.id!==_pid);
    localStorage.setItem('calioEvents',JSON.stringify(events));_fbDeleteEventDoc(_pid);closePopup();render();
  }
}

document.addEventListener('click',e=>{
  const p=document.getElementById('event-popup');
  if(p.classList.contains('open')&&!p.contains(e.target)) closePopup();
  // close io dropdown when clicking outside
  const iow=document.getElementById('io-wrapper');
  if(iow.classList.contains('open')&&!iow.contains(e.target)) iow.classList.remove('open');
  // close jump dropdown when clicking outside
  const jw=document.getElementById('jump-wrapper');
  if(jw.classList.contains('open')&&!jw.contains(e.target)) closeJumpDropdown();
});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    const ioOpen=document.getElementById('io-wrapper').classList.contains('open')||document.getElementById('jump-wrapper').classList.contains('open')||document.getElementById('room-overlay').classList.contains('open')||document.getElementById('fb-setup-overlay').classList.contains('open');
    const anyOverlay=[
      document.getElementById('modal-overlay'),
      document.getElementById('copy-overlay'),
      document.getElementById('del-overlay'),
      document.getElementById('import-overlay'),
      document.getElementById('label-overlay'),
    ].some(el=>el&&el.classList.contains('open'));
    const popupOpen=document.getElementById('event-popup').classList.contains('open');
    if(anyOverlay||ioOpen||popupOpen){
      closeModal();closePopup();closeCopyModal();closeDelDialog();closeImportModal();closeLabelModal();closeRoomModal();closeFbSetup();
      document.getElementById('io-wrapper').classList.remove('open');closeJumpDropdown();
    } else {
      // Nothing open ‚Äî toggle sidebar
      toggleSidebar();
    }
  }
  if(e.target.matches('input,select,textarea')) return;
  const mo=document.getElementById('modal-overlay');
  if(!mo.classList.contains('open')){
    if(e.key==='ArrowLeft') navigate(-1);
    if(e.key==='ArrowRight') navigate(1);
    if(e.key==='n') openModal();
    if(e.key==='g') openJumpToDate();
  }
});
setInterval(()=>{if(view==='week'||view==='day')renderCalendar();},60000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LABELS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderLabels(){
  const list=document.getElementById('labels-list');
  if(!list) return;
  list.innerHTML='';
  if(!labels.length){
    const empty=document.createElement('div');
    empty.style.cssText='font-size:0.75rem;color:var(--text3);padding:4px 6px;';
    empty.textContent='No labels yet. Add one!';
    list.appendChild(empty);
  }
  labels.forEach(lbl=>{
    // Count visible events for this label
    const cnt=events.filter(e=>e.labelId===lbl.id).length;
    const row=document.createElement('div');
    row.className='label-row'+(lbl.visible===false?' hidden':'');

    // Visibility toggle button
    const vis=document.createElement('button');
    vis.className='label-vis-btn';
    vis.title=lbl.visible===false?'Show events':'Hide events';
    vis.innerHTML=lbl.visible===false
      ?'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" style="color:var(--text3)"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
      :'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" style="color:var(--text2)"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
    vis.onclick=(e)=>{e.stopPropagation();toggleLabelVisibility(lbl.id);};

    const dot=document.createElement('div');
    dot.className='label-dot';dot.style.background=lbl.color;

    const name=document.createElement('div');
    name.className='label-name';name.textContent=lbl.name;

    const count=document.createElement('div');
    count.className='label-count';count.textContent=cnt||'';

    const editBtn=document.createElement('button');
    editBtn.className='label-edit-btn';editBtn.textContent='‚Ä¢‚Ä¢‚Ä¢';editBtn.title='Edit label';
    editBtn.onclick=(e)=>{e.stopPropagation();openLabelModal(lbl.id);};

    row.appendChild(vis);row.appendChild(dot);row.appendChild(name);row.appendChild(count);row.appendChild(editBtn);
    list.appendChild(row);
  });

  // Add label button
  const addBtn=document.createElement('button');
  addBtn.className='label-add-btn';
  addBtn.innerHTML='<span style="font-size:0.9rem">+</span> New label';
  addBtn.onclick=()=>openLabelModal(null);
  list.appendChild(addBtn);
}

function toggleLabelVisibility(id){
  const lbl=labels.find(l=>l.id===id);
  if(!lbl) return;
  lbl.visible=lbl.visible===false?true:false;
  saveLabels();render();
}

function populateLabelDropdown(selectedId){
  const sel=document.getElementById('ev-label');
  sel.innerHTML='<option value="">‚Äî No label ‚Äî</option>';
  labels.forEach(lbl=>{
    const opt=document.createElement('option');
    opt.value=lbl.id;opt.textContent=lbl.name;
    if(lbl.id===selectedId) opt.selected=true;
    sel.appendChild(opt);
  });
  onLabelChange();
}
function onLabelChange(){
  const lid=document.getElementById('ev-label').value;
  const prev=document.getElementById('ev-label-preview');
  if(lid){
    const lbl=labels.find(l=>l.id===lid);
    if(lbl){
      prev.style.display='flex';
      prev.style.background=lbl.color+'22';
      prev.style.color=lbl.color;
      document.getElementById('ev-label-preview-dot').style.background=lbl.color;
      document.getElementById('ev-label-preview-text').textContent=lbl.name;
      return;
    }
  }
  prev.style.display='none';
}

// ‚îÄ‚îÄ LABEL MODAL ‚îÄ‚îÄ
let selectedLabelColorLocal=COLORS[1].hex;

function buildLabelColorPicker(){
  const cp=document.getElementById('label-color-picker');cp.innerHTML='';
  COLORS.forEach(c=>{
    const sw=document.createElement('div');sw.className='label-color-sw'+(selectedLabelColorLocal===c.hex?' selected':'');
    sw.style.background=c.hex;sw.title=c.name;
    sw.onclick=()=>{selectedLabelColorLocal=c.hex;buildLabelColorPicker();};
    cp.appendChild(sw);
  });
}

function openLabelModal(id){
  editingLabelId=id;
  const lbl=id?labels.find(l=>l.id===id):null;
  document.getElementById('label-modal-title').textContent=id?'Edit Label':'New Label';
  document.getElementById('lbl-name').value=lbl?lbl.name:'';
  selectedLabelColorLocal=lbl?lbl.color:COLORS[1].hex;
  buildLabelColorPicker();
  const actions=document.getElementById('label-modal-actions');
  if(id){
    actions.innerHTML=`<button class="btn-delete" onclick="deleteLabel('${id}')">Delete</button><button class="btn-cancel" onclick="closeLabelModal()">Cancel</button><button class="btn-save" onclick="saveLabel()">Save</button>`;
  } else {
    actions.innerHTML=`<button class="btn-cancel" onclick="closeLabelModal()">Cancel</button><button class="btn-save" onclick="saveLabel()">Save Label</button>`;
  }
  document.getElementById('label-overlay').classList.add('open');
  setTimeout(()=>document.getElementById('lbl-name').focus(),80);
}

function closeLabelModal(){document.getElementById('label-overlay').classList.remove('open');editingLabelId=null;}

function saveLabel(){
  const name=document.getElementById('lbl-name').value.trim();
  if(!name){document.getElementById('lbl-name').style.borderColor='var(--red)';setTimeout(()=>document.getElementById('lbl-name').style.borderColor='',1500);return;}
  let pushLbl;
  if(editingLabelId){
    const lbl=labels.find(l=>l.id===editingLabelId);
    if(lbl){lbl.name=name;lbl.color=selectedLabelColorLocal;pushLbl=lbl;}
  } else {
    const newLbl={id:uuid(),name,color:selectedLabelColorLocal,visible:true};
    labels.push(newLbl);pushLbl=newLbl;
  }
  saveLabels();if(pushLbl)_fbPushLabel(pushLbl);closeLabelModal();render();
}

function deleteLabel(id){
  events.forEach(ev=>{if(ev.labelId===id){ev.labelId=null;_fbPushEvent(ev);}});
  localStorage.setItem('calioEvents',JSON.stringify(events));
  labels=labels.filter(l=>l.id!==id);
  saveLabels();_fbDeleteLabelDoc(id);closeLabelModal();render();
}

// ‚îÄ‚îÄ JUMP TO DATE ‚îÄ‚îÄ
function openJumpToDate(){
  const jw=document.getElementById('jump-wrapper');
  jw.classList.toggle('open');
  if(jw.classList.contains('open')){
    // Pre-fill with the current cursor date
    const d=view==='month'?new Date(cursor.getFullYear(),cursor.getMonth(),today.getDate()):cursor;
    document.getElementById('jump-date-input').value=fmtDate(d);
    setTimeout(()=>document.getElementById('jump-date-input').focus(),60);
  }
}
function closeJumpDropdown(){document.getElementById('jump-wrapper').classList.remove('open');}
function confirmJump(){
  const val=document.getElementById('jump-date-input').value;
  if(!val) return;
  const d=new Date(val+'T12:00:00');
  if(isNaN(d)) return;
  // Navigate the calendar to this date
  if(view==='month') cursor=new Date(d.getFullYear(),d.getMonth(),1);
  else cursor=new Date(d);
  closeJumpDropdown();
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT / EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function toggleIODropdown(e){
  e.stopPropagation();
  document.getElementById('io-wrapper').classList.toggle('open');
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ

function downloadFile(content, filename, mime){
  const blob=new Blob([content],{type:mime});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}

function exportJSON(){
  document.getElementById('io-wrapper').classList.remove('open');
  if(!events.length){showToast('No events to export.');return;}
  const payload=JSON.stringify({version:1,exportedAt:new Date().toISOString(),events,labels},null,2);
  const filename='calio-backup-'+fmtDate(new Date())+'.json';
  downloadFile(payload,filename,'application/json');
  showToast('Exported '+events.length+' event'+(events.length!==1?'s':'')+' as JSON');
}

function exportICS(){
  document.getElementById('io-wrapper').classList.remove('open');
  if(!events.length){showToast('No events to export.');return;}
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//CalIO//CalIO Calendar//EN','CALSCALE:GREGORIAN','METHOD:PUBLISH'];

  events.forEach(ev=>{
    // For recurring events, we export a RRULE; for single events, just a VEVENT
    const base=parseDate(ev.date);
    lines.push('BEGIN:VEVENT');
    lines.push('UID:'+ev.id+'@calio');
    lines.push('SUMMARY:'+escapeICS(ev.title));
    lines.push('DTSTAMP:'+toICSDate(new Date(),false));
    if(ev.description) lines.push('DESCRIPTION:'+escapeICS(ev.description));

    if(ev.allDay){
      lines.push('DTSTART;VALUE=DATE:'+ev.date.replace(/-/g,''));
      lines.push('DTEND;VALUE=DATE:'+ev.date.replace(/-/g,''));
    } else {
      const [sh,sm]=ev.start.split(':').map(Number);
      const [eh,em]=ev.end.split(':').map(Number);
      const startDt=new Date(base.getFullYear(),base.getMonth(),base.getDate(),sh,sm);
      const endDt=new Date(base.getFullYear(),base.getMonth(),base.getDate(),eh,em);
      lines.push('DTSTART:'+toICSDate(startDt,false));
      lines.push('DTEND:'+toICSDate(endDt,false));
    }

    // RRULE
    const r=ev.recurrence;
    if(r&&r.type!=='none'){
      let rrule='RRULE:FREQ='+r.type.toUpperCase();
      if(r.interval&&r.interval>1) rrule+=';INTERVAL='+r.interval;
      if(r.endType==='on'&&r.endDate) rrule+=';UNTIL='+r.endDate.replace(/-/g,'')+'T235959Z';
      else if(r.endType==='after'&&r.count) rrule+=';COUNT='+r.count;
      lines.push(rrule);
      // EXDATE for exceptions
      if(ev.exceptions&&ev.exceptions.length){
        ev.exceptions.forEach(ex=>lines.push('EXDATE;VALUE=DATE:'+ex.replace(/-/g,'')));
      }
    }

    // Color as X-APPLE-CALENDAR-COLOR
    lines.push('X-APPLE-CALENDAR-COLOR:'+ev.color);
    lines.push('END:VEVENT');
  });

  lines.push('END:VCALENDAR');
  const filename='calio-'+fmtDate(new Date())+'.ics';
  downloadFile(lines.join('\r\n'),filename,'text/calendar');
  showToast('Exported '+events.length+' event'+(events.length!==1?'s':'')+' as .ics');
}

function toICSDate(d,utc){
  const pad=n=>String(n).padStart(2,'0');
  if(utc) return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+'T'+pad(d.getUTCHours())+pad(d.getUTCMinutes())+'00Z';
  return d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate())+'T'+pad(d.getHours())+pad(d.getMinutes())+'00';
}
function escapeICS(s){return (s||'').replace(/\\/g,'\\\\').replace(/;/g,'\\;').replace(/,/g,'\\,').replace(/\n/g,'\\n');}

// ‚îÄ‚îÄ IMPORT ‚îÄ‚îÄ

let importMode='merge';
let importedEventsBuffer=[];
let activeImportType='json';

function openImportModal(type){
  document.getElementById('io-wrapper').classList.remove('open');
  activeImportType=type;
  importedEventsBuffer=[];
  document.getElementById('import-modal-title').textContent=type==='ics'?'Import .ics File':'Import JSON Backup';
  document.getElementById('dz-icon').textContent='üìÅ';
  document.getElementById('dz-title').textContent='Click to choose a file';
  document.getElementById('dz-sub').textContent='or drag & drop here';
  document.getElementById('dz-file').textContent='';
  document.getElementById('import-preview').style.display='none';
  document.getElementById('import-confirm-btn').disabled=true;
  document.getElementById('import-confirm-btn').style.opacity='0.4';
  document.getElementById('import-confirm-btn').style.cursor='not-allowed';
  setImportMode('merge');
  // Setup file input
  const fi=document.getElementById('file-input');
  fi.accept=type==='ics'?'.ics,text/calendar':'.json,application/json';
  fi.value='';
  fi.onchange=e=>{if(e.target.files[0])readImportFile(e.target.files[0]);};
  // Drag and drop
  const dz=document.getElementById('import-drop-zone');
  dz.ondragover=e=>{e.preventDefault();dz.classList.add('drag-over');};
  dz.ondragleave=()=>dz.classList.remove('drag-over');
  dz.ondrop=e=>{e.preventDefault();dz.classList.remove('drag-over');const f=e.dataTransfer.files[0];if(f)readImportFile(f);};
  document.getElementById('import-overlay').classList.add('open');
}
function closeImportModal(){document.getElementById('import-overlay').classList.remove('open');importedEventsBuffer=[];}
function triggerFileInput(){document.getElementById('file-input').click();}

function setImportMode(mode){
  importMode=mode;
  document.getElementById('mode-merge').classList.toggle('selected',mode==='merge');
  document.getElementById('mode-replace').classList.toggle('selected',mode==='replace');
  document.getElementById('import-mode-desc').textContent=mode==='merge'
    ?'Add imported events alongside existing ones ‚Äî duplicates get new IDs.'
    :'Replace ALL current events with the imported ones. This cannot be undone.';
}

function readImportFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const content=e.target.result;
      let parsed=[];
      if(activeImportType==='json') parsed=parseJSONImport(content);
      else parsed=parseICSImport(content);
      if(!parsed.length) throw new Error('No valid events found in file.');
      importedEventsBuffer=parsed;
      // Show preview
      const dates=parsed.map(ev=>ev.date).filter(Boolean).sort();
      document.getElementById('ip-count').innerHTML='<strong>'+parsed.length+'</strong> event'+(parsed.length!==1?'s':'')+' found in file';
      document.getElementById('ip-range').innerHTML=dates.length?'Date range: <strong>'+dates[0]+'</strong> ‚Üí <strong>'+dates[dates.length-1]+'</strong>':'';
      document.getElementById('import-preview').style.display='block';
      document.getElementById('dz-icon').textContent='‚úÖ';
      document.getElementById('dz-title').textContent=file.name;
      document.getElementById('dz-sub').textContent='Ready to import';
      document.getElementById('dz-file').textContent='';
      const btn=document.getElementById('import-confirm-btn');
      btn.disabled=false;btn.style.opacity='1';btn.style.cursor='pointer';
    } catch(err){
      document.getElementById('dz-icon').textContent='‚ùå';
      document.getElementById('dz-title').textContent='Failed to parse file';
      document.getElementById('dz-sub').textContent=err.message||'Please check the file format.';
      document.getElementById('import-preview').style.display='none';
      importedEventsBuffer=[];
      const btn=document.getElementById('import-confirm-btn');
      btn.disabled=true;btn.style.opacity='0.4';btn.style.cursor='not-allowed';
    }
  };
  reader.readAsText(file);
}

function parseJSONImport(content){
  const data=JSON.parse(content);
  // Accept array directly or {events:[...]} shape
  // Restore labels if present
  if(!Array.isArray(data)&&data.labels){labels=[...data.labels];saveLabels();}
  const raw=Array.isArray(data)?data:(data.events||[]);
  if(!Array.isArray(raw)||!raw.length) throw new Error('No events array found.');
  return raw.filter(e=>e&&e.title&&e.date).map(e=>({
    id:uuid(), // always give fresh ID
    title:String(e.title),
    date:String(e.date),
    allDay:!!e.allDay,
    start:e.start||null,
    end:e.end||null,
    description:e.description||'',
    color:e.color||COLORS[0].hex,
    recurrence:e.recurrence||{type:'none'},
    exceptions:e.exceptions||[]
  }));
}

function parseICSImport(content){
  // Unfold lines (RFC 5545 line folding: CRLF + space/tab)
  const unfolded=content.replace(/\r\n[ \t]/g,'').replace(/\n[ \t]/g,'');
  const lines=unfolded.split(/\r?\n/);
  const eventsOut=[];
  let current=null;

  for(let line of lines){
    line=line.trim();
    if(line==='BEGIN:VEVENT'){current={};continue;}
    if(line==='END:VEVENT'){
      if(current){
        const ev=buildEventFromVEvent(current);
        if(ev) eventsOut.push(ev);
      }
      current=null;continue;
    }
    if(!current) continue;
    // Parse key:value (handle params like DTSTART;VALUE=DATE:...)
    const sep=line.indexOf(':');if(sep<0) continue;
    const keyFull=line.slice(0,sep).toUpperCase();
    const val=line.slice(sep+1);
    const key=keyFull.split(';')[0];
    current[key]=current[key]||{raw:val,full:keyFull+':'+val};
    if(!current[key].raw) current[key].raw=val;
  }
  if(!eventsOut.length) throw new Error('No VEVENT blocks found in this .ics file.');
  return eventsOut;
}

function buildEventFromVEvent(vev){
  const get=k=>vev[k]?vev[k].raw:'';
  const title=unescapeICS(get('SUMMARY'));
  if(!title) return null;

  // Determine date and allDay
  let date='',allDay=false,start=null,end=null;
  const dtstart=get('DTSTART'),dtend=get('DTEND');
  const fullStart=vev['DTSTART']?vev['DTSTART'].full||'':'';

  if(dtstart){
    if(dtstart.length===8&&/^\d{8}$/.test(dtstart)){
      // DATE only
      date=dtstart.slice(0,4)+'-'+dtstart.slice(4,6)+'-'+dtstart.slice(6,8);
      allDay=true;
    } else {
      // DATE-TIME
      const ys=dtstart.slice(0,4),ms=dtstart.slice(4,6),ds2=dtstart.slice(6,8);
      date=ys+'-'+ms+'-'+ds2;
      const hs=dtstart.slice(9,11),mins=dtstart.slice(11,13);
      start=hs+':'+mins;
      if(dtend&&dtend.length>=15){
        end=dtend.slice(9,11)+':'+dtend.slice(11,13);
      } else {
        const sh=parseInt(hs),sm=parseInt(mins);
        end=String(Math.min(23,sh+1)).padStart(2,'0')+':'+String(sm).padStart(2,'0');
      }
    }
  }
  if(!date) return null;

  // Recurrence
  let recurrence={type:'none'};
  const rrule=get('RRULE');
  if(rrule){
    const parts={};
    rrule.split(';').forEach(p=>{const [k,v]=p.split('=');parts[k]=v;});
    const freqMap={DAILY:'daily',WEEKLY:'weekly',MONTHLY:'monthly',YEARLY:'yearly'};
    const type=freqMap[parts.FREQ]||'none';
    if(type!=='none'){
      recurrence={type};
      if(parts.INTERVAL) recurrence.interval=parseInt(parts.INTERVAL)||1;
      if(parts.UNTIL){
        recurrence.endType='on';
        const u=parts.UNTIL.replace('Z','');
        recurrence.endDate=u.slice(0,4)+'-'+u.slice(4,6)+'-'+u.slice(6,8);
      } else if(parts.COUNT){
        recurrence.endType='after';recurrence.count=parseInt(parts.COUNT)||10;
      } else {
        recurrence.endType='never';
      }
    }
  }

  // Exceptions
  const exceptions=[];
  const exdate=get('EXDATE');
  if(exdate){
    exdate.split(',').forEach(ex=>{
      const d=ex.trim().replace(/T.*$/,'');
      if(d.length===8) exceptions.push(d.slice(0,4)+'-'+d.slice(4,6)+'-'+d.slice(6,8));
    });
  }

  // Color (from X-APPLE-CALENDAR-COLOR or fallback)
  const appleColor=get('X-APPLE-CALENDAR-COLOR');
  const color=COLORS.find(c=>c.hex.toLowerCase()===(appleColor||'').toLowerCase())?.hex||COLORS[0].hex;

  return{
    id:uuid(),title,date,allDay,start,end,
    description:unescapeICS(get('DESCRIPTION')||''),
    color,recurrence,exceptions
  };
}

function unescapeICS(s){return (s||'').replace(/\\n/g,'\n').replace(/\\,/g,',').replace(/\\;/g,';').replace(/\\\\/g,'\\');}

function confirmImport(){
  if(!importedEventsBuffer.length) return;
  if(importMode==='replace'){
    events=importedEventsBuffer;
  } else {
    events=[...events,...importedEventsBuffer];
  }
  saveEvents();
  // Also push imported labels to Firebase if connected
  if(fbDb&&currentRoom){labels.forEach(lbl=>{const d={...lbl};delete d.id;fbDb.collection('rooms').doc(currentRoom).collection('labels').doc(lbl.id).set(d);});}
  closeImportModal();render();
  showToast((importMode==='replace'?'Replaced all events with ':'Imported ')+importedEventsBuffer.length+' event'+(importedEventsBuffer.length!==1?'s':''));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE INTEGRATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let fbApp = null;
let fbDb  = null;
let currentRoom = null;        // 6-char room code string
let syncListeners = [];        // unsubscribe functions from onSnapshot
let isSyncing = false;
let isFirebaseReady = false;

// ‚îÄ‚îÄ persist config & room in localStorage ‚îÄ‚îÄ
function loadFbConfig(){
  try { return JSON.parse(localStorage.getItem('calioFbConfig')||'null'); } catch{ return null; }
}
function saveFbConfig(cfg){ localStorage.setItem('calioFbConfig', JSON.stringify(cfg)); }
function clearFbConfig(){ localStorage.removeItem('calioFbConfig'); }
function loadSavedRoom(){ return localStorage.getItem('calioRoom')||null; }
function saveRoomLocal(code){ if(code) localStorage.setItem('calioRoom',code); else localStorage.removeItem('calioRoom'); }

// ‚îÄ‚îÄ sync status UI ‚îÄ‚îÄ
function setSyncStatus(status, label){
  const dot = document.getElementById('sync-dot');
  const lbl = document.getElementById('sync-label');
  if(!dot||!lbl) return;
  dot.className = 'sync-dot ' + status;
  lbl.textContent = label;
}

// ‚îÄ‚îÄ initialise Firebase from stored or provided config ‚îÄ‚îÄ
function initFirebase(cfg){
  try {
    // Avoid double-init
    if(fbApp){
      try{ fbApp.delete(); }catch(e){}
      fbApp = null; fbDb = null;
    }
    // Firebase compat SDK
    if(!firebase.apps.length){
      fbApp = firebase.initializeApp(cfg);
    } else {
      fbApp = firebase.app();
    }
    fbDb = firebase.firestore();
    // Enable offline persistence (Firestore caches writes when offline)
    fbDb.enablePersistence({ synchronizeTabs: true })
      .catch(err => {
        if(err.code !== 'failed-precondition' && err.code !== 'unimplemented')
          console.warn('Persistence error:', err);
      });
    isFirebaseReady = true;
    setSyncStatus('connected', 'Firebase ready');
    return true;
  } catch(err){
    console.error('Firebase init failed:', err);
    isFirebaseReady = false;
    setSyncStatus('offline', 'Firebase error');
    return false;
  }
}

// ‚îÄ‚îÄ auto-init on load if config stored ‚îÄ‚îÄ
function tryAutoConnect(){
  const cfg = loadFbConfig();
  if(!cfg){ setSyncStatus('local','Local only'); return; }
  const ok = initFirebase(cfg);
  if(!ok) return;
  const savedRoom = loadSavedRoom();
  if(savedRoom){
    attachRoom(savedRoom);
  }
}

// ‚îÄ‚îÄ generate a random 6-char room code ‚îÄ‚îÄ
function genRoomCode(){
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s = '';
  for(let i=0;i<6;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}

// ‚îÄ‚îÄ detach all live listeners ‚îÄ‚îÄ
function detachListeners(){
  syncListeners.forEach(unsub => { try{ unsub(); }catch(e){} });
  syncListeners = [];
}

// ‚îÄ‚îÄ attach to a room (subscribe to live Firestore updates) ‚îÄ‚îÄ
async function attachRoom(code){
  if(!fbDb){ setSyncStatus('offline','Not connected'); return false; }
  detachListeners();
  currentRoom = code;
  saveRoomLocal(code);
  setSyncStatus('syncing', 'Connecting‚Ä¶');
  updateRoomBadge();

  const roomRef = fbDb.collection('rooms').doc(code);

  // Ensure room document exists
  try {
    await roomRef.set({ createdAt: Date.now() }, { merge: true });
  } catch(e){ console.warn('room set:', e); }

  // Listen to events sub-collection
  const evUnsub = roomRef.collection('events').onSnapshot(snap => {
    const remoteEvents = [];
    snap.forEach(doc => remoteEvents.push({ ...doc.data(), id: doc.id }));
    events = remoteEvents;
    saveEvents(); // keep localStorage in sync
    render();
    setSyncStatus('connected', 'Synced ¬∑ ' + code);
    isSyncing = false;
  }, err => {
    console.error('events snapshot error:', err);
    setSyncStatus('offline', 'Sync error');
  });

  // Listen to labels sub-collection
  const lblUnsub = roomRef.collection('labels').onSnapshot(snap => {
    const remoteLabels = [];
    snap.forEach(doc => remoteLabels.push({ ...doc.data(), id: doc.id }));
    labels = remoteLabels;
    saveLabels();
    render();
  }, err => { console.error('labels snapshot error:', err); });

  syncListeners = [evUnsub, lblUnsub];
  return true;
}

// ‚îÄ‚îÄ write a single event to Firestore ‚îÄ‚îÄ
async function fbSaveEvent(ev){
  if(!fbDb||!currentRoom) return;
  isSyncing = true;
  setSyncStatus('syncing','Saving‚Ä¶');
  try {
    const data = { ...ev };
    delete data.id; // doc ID is the event ID
    await fbDb.collection('rooms').doc(currentRoom)
              .collection('events').doc(ev.id).set(data);
  } catch(e){
    console.error('fbSaveEvent error:', e);
    setSyncStatus('offline','Sync error');
  }
}

// ‚îÄ‚îÄ delete a single event from Firestore ‚îÄ‚îÄ
async function fbDeleteEvent(id){
  if(!fbDb||!currentRoom) return;
  try {
    await fbDb.collection('rooms').doc(currentRoom)
              .collection('events').doc(id).delete();
  } catch(e){ console.error('fbDeleteEvent error:', e); }
}

// ‚îÄ‚îÄ write all events to Firestore (batch) ‚îÄ‚îÄ
async function fbSaveAllEvents(){
  if(!fbDb||!currentRoom) return;
  isSyncing = true;
  setSyncStatus('syncing','Saving‚Ä¶');
  try {
    const col = fbDb.collection('rooms').doc(currentRoom).collection('events');
    // Use batched writes (max 500 per batch)
    const chunks = [];
    for(let i=0;i<events.length;i+=400) chunks.push(events.slice(i,i+400));
    for(const chunk of chunks){
      const batch = fbDb.batch();
      chunk.forEach(ev => {
        const data={...ev}; delete data.id;
        batch.set(col.doc(ev.id), data);
      });
      await batch.commit();
    }
  } catch(e){
    console.error('fbSaveAllEvents error:', e);
    setSyncStatus('offline','Sync error');
  }
}

// ‚îÄ‚îÄ write a single label ‚îÄ‚îÄ
async function fbSaveLabel(lbl){
  if(!fbDb||!currentRoom) return;
  try {
    const data={...lbl}; delete data.id;
    await fbDb.collection('rooms').doc(currentRoom)
              .collection('labels').doc(lbl.id).set(data);
  } catch(e){ console.error('fbSaveLabel:', e); }
}

// ‚îÄ‚îÄ delete a label from Firestore ‚îÄ‚îÄ
async function fbDeleteLabel(id){
  if(!fbDb||!currentRoom) return;
  try {
    await fbDb.collection('rooms').doc(currentRoom)
              .collection('labels').doc(id).delete();
  } catch(e){ console.error('fbDeleteLabel:', e); }
}

// ‚îÄ‚îÄ Override saveEvents / saveLabels to also push to Firestore ‚îÄ‚îÄ
// (The original localStorage versions are kept as fallback)
const _origSaveEvents = saveEvents;
saveEvents = function(){
  _origSaveEvents();
  // Firestore writes are done per-operation (fbSaveEvent/fbDeleteEvent)
  // This is called as a catch-all after bulk ops (import, etc.)
  if(fbDb && currentRoom) fbSaveAllEvents();
};

// ‚îÄ‚îÄ Room UI helpers ‚îÄ‚îÄ
function updateRoomBadge(){
  const wrap = document.getElementById('room-badge-wrap');
  const codeEl = document.getElementById('room-badge-code');
  const si = document.getElementById('sync-indicator');
  if(currentRoom){
    if(wrap){ wrap.style.display=''; codeEl.textContent = currentRoom; }
    if(si) si.style.display='none';
  } else {
    if(wrap) wrap.style.display='none';
    if(si) si.style.display='';
  }
}

// ‚îÄ‚îÄ FIREBASE SETUP MODAL ‚îÄ‚îÄ
function openFbSetup(){
  const cfg = loadFbConfig();
  if(cfg) document.getElementById('fb-config-input').value = JSON.stringify(cfg, null, 2);
  document.getElementById('fb-config-error').style.display='none';
  document.getElementById('fb-setup-overlay').classList.add('open');
}
function closeFbSetup(){ document.getElementById('fb-setup-overlay').classList.remove('open'); }

function parseFirebaseConfig(raw){
  // Use new Function() to evaluate the config as real JavaScript.
  // This handles every format the Firebase console produces:
  // unquoted keys, single-quoted strings, trailing commas, // comments,
  // and the full "const firebaseConfig = { ... };" wrapper.

  let s = raw.trim();

  // Strip <script> tags if pasted from a full HTML snippet
  s = s.replace(/<script[^>]*>/gi,'').replace(/<\/script>/gi,'').trim();

  // Remove // line comments so they don't break brace matching
  s = s.replace(/\/\/[^\n]*/g, '');

  // Find the first complete { ... } block
  const start = s.indexOf('{');
  if(start === -1) throw new Error('No { } object block found ‚Äî paste the full firebaseConfig block.');
  let depth = 0, end = -1;
  for(let i = start; i < s.length; i++){
    if(s[i] === '{') depth++;
    else if(s[i] === '}' && --depth === 0){ end = i; break; }
  }
  if(end === -1) throw new Error('Config object is missing its closing } ‚Äî make sure you pasted the full block.');

  const objStr = s.slice(start, end + 1);

  // Safely evaluate as a JS expression (returns a plain object ‚Äî no side effects possible)
  // eslint-disable-next-line no-new-func
  const result = (new Function('return ' + objStr))();
  if(typeof result !== 'object' || result === null) throw new Error('Config did not evaluate to an object.');
  return result;
}

function connectFirebase(){
  const raw = document.getElementById('fb-config-input').value.trim();
  const errEl = document.getElementById('fb-config-error');
  errEl.style.display='none';
  let cfg;
  try {
    if(!raw) throw new Error('Please paste your Firebase config first.');
    cfg = parseFirebaseConfig(raw);
    if(!cfg.apiKey)      throw new Error('"apiKey" not found ‚Äî make sure you copied the full config block.');
    if(!cfg.projectId)   throw new Error('"projectId" not found ‚Äî make sure you copied the full config block.');
  } catch(e){
    errEl.textContent = '‚ö† ' + e.message;
    errEl.style.display='block';
    return;
  }
  saveFbConfig(cfg);
  const ok = initFirebase(cfg);
  if(!ok){
    errEl.textContent = 'Firebase init failed ‚Äî check your config and try again.';
    errEl.style.display='block';
    return;
  }
  closeFbSetup();
  openRoomModal();
}

function disconnectFirebase(){
  detachListeners();
  leaveRoom(true);
  clearFbConfig();
  isFirebaseReady = false;
  fbDb = null;
  if(fbApp){ try{ fbApp.delete(); }catch(e){} fbApp=null; }
  setSyncStatus('local','Local only');
  updateRoomBadge();
  closeRoomModal();
  showToast('Disconnected from Firebase');
}

// ‚îÄ‚îÄ ROOM MODAL ‚îÄ‚îÄ
function openRoomModal(){
  // Decide which panel to show
  const noFb   = document.getElementById('room-no-firebase');
  const fbPanel= document.getElementById('room-firebase-panel');
  const active = document.getElementById('room-active-section');
  const noRoom = document.getElementById('room-noroom-section');
  if(!isFirebaseReady){
    noFb.style.display=''; fbPanel.style.display='none';
  } else {
    noFb.style.display='none'; fbPanel.style.display='';
    if(currentRoom){
      active.style.display=''; noRoom.style.display='none';
      document.getElementById('room-active-code').textContent = currentRoom;
    } else {
      active.style.display='none'; noRoom.style.display='';
      document.getElementById('room-join-input').value='';
      document.getElementById('room-join-error').style.display='none';
    }
  }
  document.getElementById('room-overlay').classList.add('open');
}
function closeRoomModal(){ document.getElementById('room-overlay').classList.remove('open'); }

async function createRoom(){
  const code = genRoomCode();
  const ok = await attachRoom(code);
  if(ok){
    closeRoomModal();
    // Push current local events + labels up to the new room
    await fbSaveAllEvents();
    const col = fbDb.collection('rooms').doc(code).collection('labels');
    for(const lbl of labels){
      const d={...lbl}; delete d.id;
      await col.doc(lbl.id).set(d);
    }
    showToast('Room created: ' + code + ' ‚Äî share this code!');
    updateRoomBadge();
  }
}

async function joinRoom(){
  const code = document.getElementById('room-join-input').value.trim().toUpperCase();
  const errEl = document.getElementById('room-join-error');
  errEl.style.display='none';
  if(code.length!==6){ errEl.textContent='Code must be 6 characters'; errEl.style.display=''; return; }
  // Check room exists
  try {
    const doc = await fbDb.collection('rooms').doc(code).get();
    if(!doc.exists){ errEl.textContent='Room not found. Check the code and try again.'; errEl.style.display=''; return; }
  } catch(e){ errEl.textContent='Connection error: '+e.message; errEl.style.display=''; return; }
  await attachRoom(code);
  closeRoomModal();
  showToast('Joined room: ' + code);
  updateRoomBadge();
}

function leaveRoom(silent){
  detachListeners();
  currentRoom = null;
  saveRoomLocal(null);
  updateRoomBadge();
  if(!silent) showToast('Left room ‚Äî back to local only');
  setSyncStatus(isFirebaseReady?'connected':'local', isFirebaseReady?'Firebase ready':'Local only');
  closeRoomModal();
}

function copyRoomCode(){
  if(!currentRoom) return;
  navigator.clipboard.writeText(currentRoom).then(()=>showToast('Room code copied: '+currentRoom));
}

// ‚îÄ‚îÄ Intercept all write operations to push to Firestore ‚îÄ‚îÄ
// saveEvent ‚Üí also fbSaveEvent
const _origSaveEvent_inner = saveEvent;
// We monkey-patch the downstream effect: after saveEvent writes to local,
// we push the relevant event doc to Firestore.
// Since saveEvent calls saveEvents() which calls the overridden version,
// and fbSaveAllEvents would re-push everything, we instead patch at a finer level.
// The cleanest approach: wrap the per-doc operations.

// Wrap per-event write: called from saveEvent()
function _fbPushEvent(ev){ if(fbDb&&currentRoom) fbSaveEvent(ev); }
// Wrap per-event delete: called from delete operations
function _fbDeleteEventDoc(id){ if(fbDb&&currentRoom) fbDeleteEvent(id); }
// Wrap per-label write/delete
function _fbPushLabel(lbl){ if(fbDb&&currentRoom) fbSaveLabel(lbl); }
function _fbDeleteLabelDoc(id){ if(fbDb&&currentRoom) fbDeleteLabel(id); }

// ‚îÄ‚îÄ boot ‚îÄ‚îÄ
tryAutoConnect();


render();
</script>
</body>
</html>
