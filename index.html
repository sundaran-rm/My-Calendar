<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>CalIO</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* ‚îÄ‚îÄ THEMES ‚îÄ‚îÄ */
:root,[data-theme="dark"]{
  --bg:#0f0f11; --surface:#18181c; --surface2:#222228; --surface3:#2c2c35;
  --border:#2e2e38; --accent:#7c6af7; --accent2:#a78bfa; --accent-soft:#7c6af720;
  --text:#e8e8f0; --text2:#9090a8; --text3:#5c5c72; --red:#f87171; --green:#4ade80;
  --shadow:#00000080; --drag-ghost:rgba(124,106,247,0.15);
}
[data-theme="light"]{
  --bg:#f5f5fa; --surface:#ffffff; --surface2:#f0f0f6; --surface3:#e4e4ef;
  --border:#d4d4e2; --accent:#6c5ce7; --accent2:#8b7cf8; --accent-soft:#6c5ce715;
  --text:#18181c; --text2:#5c5c72; --text3:#9090a8; --red:#e53e3e; --green:#2f855a;
  --shadow:#0000001a; --drag-ghost:rgba(108,92,231,0.12);
}

body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; transition:background 0.2s,color 0.2s; }

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav { display:flex; align-items:center; gap:8px; padding:8px 14px; border-bottom:1px solid var(--border); background:var(--surface); flex-shrink:0; flex-wrap:wrap; min-height:52px; }
.logo { font-family:'DM Serif Display',serif; font-size:1.2rem; color:var(--text); letter-spacing:-0.02em; margin-right:2px; white-space:nowrap; }
.logo span { color:var(--accent2); font-style:italic; }
.nav-btn { background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:5px 10px; border-radius:8px; cursor:pointer; font-family:inherit; font-size:0.8rem; font-weight:500; transition:all 0.15s; display:flex; align-items:center; gap:4px; white-space:nowrap; }
.nav-btn:hover { background:var(--surface3); border-color:var(--accent); }
.nav-btn.active { background:var(--accent-soft); border-color:var(--accent); color:var(--accent2); }
.view-tabs { display:flex; gap:3px; }
.nav-center { display:flex; align-items:center; gap:7px; margin:0 auto; }
.month-title { font-family:'DM Serif Display',serif; font-size:1.2rem; letter-spacing:-0.02em; min-width:200px; text-align:center; cursor:pointer; }
.month-title:hover { color:var(--accent2); }
.arrow-btn { background:none; border:1px solid var(--border); color:var(--text2); width:28px; height:28px; border-radius:8px; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
.arrow-btn:hover { border-color:var(--accent); color:var(--accent2); background:var(--accent-soft); }
.today-btn { background:none; border:1px solid var(--border); color:var(--text2); padding:4px 10px; border-radius:8px; cursor:pointer; font-family:inherit; font-size:0.78rem; font-weight:500; transition:all 0.15s; }
.today-btn:hover { border-color:var(--accent); color:var(--accent2); }
.add-btn { background:var(--accent); border:none; color:#fff; padding:6px 14px; border-radius:8px; cursor:pointer; font-family:inherit; font-size:0.8rem; font-weight:600; transition:all 0.15s; display:flex; align-items:center; gap:4px; }
.add-btn:hover { background:var(--accent2); transform:translateY(-1px); box-shadow:0 4px 14px #7c6af740; }
.icon-btn { background:none; border:1px solid var(--border); color:var(--text2); width:30px; height:30px; border-radius:8px; cursor:pointer; font-size:0.9rem; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
.icon-btn:hover { border-color:var(--accent); color:var(--accent2); background:var(--accent-soft); }

/* ‚îÄ‚îÄ SEARCH BAR ‚îÄ‚îÄ */
.search-wrap { position:relative; }
.search-input { background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:5px 10px 5px 30px; border-radius:8px; font-family:inherit; font-size:0.8rem; outline:none; width:160px; transition:all 0.2s; }
.search-input:focus { border-color:var(--accent); width:220px; }
.search-icon { position:absolute; left:9px; top:50%; transform:translateY(-50%); color:var(--text3); font-size:0.82rem; pointer-events:none; }
.search-results { position:absolute; top:calc(100% + 6px); left:0; background:var(--surface); border:1px solid var(--border); border-radius:10px; width:320px; max-height:360px; overflow-y:auto; box-shadow:0 12px 36px var(--shadow); z-index:300; display:none; }
.search-wrap.has-results .search-results { display:block; }
.sr-item { padding:10px 14px; cursor:pointer; border-bottom:1px solid var(--border); transition:background 0.1s; }
.sr-item:last-child { border-bottom:none; }
.sr-item:hover { background:var(--surface2); }
.sr-title { font-size:0.84rem; font-weight:500; }
.sr-meta { font-size:0.71rem; color:var(--text2); margin-top:2px; }
.sr-empty { padding:18px; text-align:center; color:var(--text3); font-size:0.82rem; }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.main { display:flex; flex:1; overflow:hidden; }

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar { width:230px; border-right:1px solid var(--border); padding:12px; overflow-y:auto; flex-shrink:0; background:var(--surface); display:flex; flex-direction:column; gap:14px; transition:width 0.25s ease,padding 0.25s ease,opacity 0.2s ease; }
.sidebar.collapsed { width:0; padding:0; opacity:0; overflow:hidden; border-right:none; }
.mini-cal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:7px; }
.mini-cal-title { font-size:0.8rem; font-weight:600; color:var(--text2); }
.mini-arrow { background:none; border:none; color:var(--text3); cursor:pointer; font-size:0.8rem; width:20px; height:20px; border-radius:5px; display:flex; align-items:center; justify-content:center; transition:all 0.12s; }
.mini-arrow:hover { color:var(--text); background:var(--surface2); }
.mini-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; }
.mini-day-label { font-size:0.58rem; color:var(--text3); text-align:center; padding:2px 0; font-weight:600; letter-spacing:0.05em; }
.mini-day { font-size:0.68rem; text-align:center; border-radius:50%; cursor:pointer; color:var(--text2); width:22px; height:22px; display:flex; align-items:center; justify-content:center; margin:auto; transition:all 0.1s; position:relative; }
.mini-day:hover { background:var(--surface3); color:var(--text); }
.mini-day.today { background:var(--accent); color:#fff; font-weight:700; }
.mini-day.other-month { color:var(--text3); }
.mini-day.has-events::after { content:''; position:absolute; bottom:1px; left:50%; transform:translateX(-50%); width:3px; height:3px; border-radius:50%; background:var(--accent2); }
.mini-day.today.has-events::after { background:#fff; }
.section-title { font-size:0.65rem; font-weight:600; color:var(--text3); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:6px; display:flex; align-items:center; justify-content:space-between; }
.mini-toggle-btn { background:none; border:none; color:var(--text3); cursor:pointer; font-size:0.7rem; padding:2px 5px; border-radius:4px; transition:all 0.12s; font-family:inherit; }
.mini-toggle-btn:hover { color:var(--accent2); background:var(--accent-soft); }
.upcoming-event { padding:6px 8px; border-radius:7px; background:var(--surface2); border-left:3px solid; margin-bottom:4px; cursor:pointer; transition:all 0.12s; }
.upcoming-event:hover { background:var(--surface3); }
.upcoming-event .ev-title { font-size:0.78rem; font-weight:500; }
.upcoming-event .ev-date { font-size:0.68rem; color:var(--text2); margin-top:2px; }
.recur-badge { display:inline-block; font-size:0.56rem; background:var(--accent-soft); color:var(--accent2); padding:1px 5px; border-radius:10px; margin-left:4px; vertical-align:middle; font-weight:600; }

/* ‚îÄ‚îÄ CALENDARS SIDEBAR ‚îÄ‚îÄ */
.cal-row { display:flex; align-items:center; gap:6px; padding:4px 5px; border-radius:6px; transition:background 0.12s; margin-bottom:2px; }
.cal-row:hover { background:var(--surface2); }
.cal-row:hover .cal-edit-btn { opacity:1; }
.cal-check { width:14px; height:14px; border-radius:3px; border:2px solid; cursor:pointer; flex-shrink:0; display:flex; align-items:center; justify-content:center; transition:all 0.12s; font-size:0.6rem; color:#fff; }
.cal-name { font-size:0.79rem; color:var(--text); flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.cal-count { font-size:0.65rem; color:var(--text3); }
.cal-edit-btn { background:none; border:none; color:var(--text3); cursor:pointer; font-size:0.7rem; padding:2px 4px; border-radius:4px; opacity:0; transition:all 0.12s; font-family:inherit; }
.cal-edit-btn:hover { color:var(--accent2); background:var(--accent-soft); }
.cal-add-btn { display:flex; align-items:center; gap:5px; width:100%; padding:4px 5px; background:none; border:1px dashed var(--border); border-radius:6px; color:var(--text3); font-family:inherit; font-size:0.76rem; cursor:pointer; transition:all 0.12s; margin-top:3px; }
.cal-add-btn:hover { border-color:var(--accent); color:var(--accent2); background:var(--accent-soft); }

/* ‚îÄ‚îÄ LABELS SIDEBAR ‚îÄ‚îÄ */
.label-row { display:flex; align-items:center; gap:6px; padding:4px 5px; border-radius:6px; transition:background 0.12s; margin-bottom:2px; }
.label-row:hover { background:var(--surface2); }
.label-row:hover .label-edit-btn { opacity:1; }
.label-vis-btn { background:none; border:none; padding:0; cursor:pointer; width:16px; height:16px; flex-shrink:0; display:flex; align-items:center; justify-content:center; }
.label-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; transition:opacity 0.15s; }
.label-name { font-size:0.79rem; color:var(--text); flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; transition:opacity 0.15s; }
.label-count { font-size:0.65rem; color:var(--text3); }
.label-edit-btn { background:none; border:none; color:var(--text3); cursor:pointer; font-size:0.7rem; padding:2px 4px; border-radius:4px; opacity:0; transition:all 0.12s; font-family:inherit; }
.label-edit-btn:hover { color:var(--accent2); background:var(--accent-soft); }
.label-row.hidden .label-dot { opacity:0.22; }
.label-row.hidden .label-name { opacity:0.35; }
.label-add-btn { display:flex; align-items:center; gap:5px; width:100%; padding:4px 5px; background:none; border:1px dashed var(--border); border-radius:6px; color:var(--text3); font-family:inherit; font-size:0.76rem; cursor:pointer; transition:all 0.12s; margin-top:3px; }
.label-add-btn:hover { border-color:var(--accent); color:var(--accent2); background:var(--accent-soft); }

/* ‚îÄ‚îÄ HABITS SIDEBAR ‚îÄ‚îÄ */
.habit-row { display:flex; align-items:center; gap:6px; padding:4px 5px; border-radius:6px; transition:background 0.12s; margin-bottom:3px; }
.habit-row:hover { background:var(--surface2); }
.habit-row:hover .habit-edit-btn { opacity:1; }
.habit-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.habit-name { font-size:0.78rem; color:var(--text); flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.habit-streak { font-size:0.65rem; color:var(--accent2); font-weight:600; display:flex; align-items:center; gap:2px; }
.habit-edit-btn { background:none; border:none; color:var(--text3); cursor:pointer; font-size:0.7rem; padding:2px 4px; border-radius:4px; opacity:0; transition:all 0.12s; font-family:inherit; }
.habit-edit-btn:hover { color:var(--accent2); background:var(--accent-soft); }
.habit-check-today { width:18px; height:18px; border-radius:4px; border:2px solid var(--border); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:0.65rem; transition:all 0.15s; flex-shrink:0; color:#fff; }
.habit-check-today.done { border-color:var(--green); background:var(--green); }

/* ‚îÄ‚îÄ CALENDAR AREA ‚îÄ‚îÄ */
.calendar-area { flex:1; display:flex; flex-direction:column; overflow:hidden; }

/* ‚îÄ‚îÄ MONTH ‚îÄ‚îÄ */
.month-view { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.day-headers { display:grid; grid-template-columns:repeat(7,1fr); border-bottom:1px solid var(--border); background:var(--surface); }
.day-header { text-align:center; padding:8px 4px; font-size:0.66rem; font-weight:600; letter-spacing:0.08em; color:var(--text3); text-transform:uppercase; border-right:1px solid var(--border); }
.day-header:last-child { border-right:none; }
.month-grid { flex:1; display:grid; grid-template-columns:repeat(7,1fr); grid-template-rows:repeat(6,1fr); overflow:hidden; }
.day-cell { border-right:1px solid var(--border); border-bottom:1px solid var(--border); padding:4px; overflow:hidden; cursor:pointer; transition:background 0.1s; display:flex; flex-direction:column; position:relative; }
.day-cell:nth-child(7n) { border-right:none; }
.day-cell:hover { background:#ffffff06; }
[data-theme="light"] .day-cell:hover { background:#00000005; }
.day-cell.other-month { opacity:0.35; }
.day-cell.today .day-num-inner { background:var(--accent); color:#fff; }
.day-cell.drag-over { background:var(--accent-soft) !important; outline:2px dashed var(--accent); outline-offset:-2px; }
.day-num { display:flex; align-items:center; margin-bottom:2px; }
.day-num-inner { width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.72rem; font-weight:600; color:var(--text2); flex-shrink:0; }
.event-pill { display:flex; align-items:center; gap:3px; padding:2px 5px; border-radius:4px; font-size:0.65rem; margin-bottom:2px; cursor:grab; overflow:hidden; white-space:nowrap; color:var(--text); transition:opacity 0.1s,transform 0.1s; min-width:0; border-left:2px solid; user-select:none; }
.event-pill:hover { opacity:0.85; }
.event-pill.dragging { opacity:0.4; transform:scale(0.97); cursor:grabbing; }
.event-pill.multiday-start { border-radius:4px 0 0 4px; margin-right:0; border-right:none; }
.event-pill.multiday-mid { border-radius:0; margin-right:0; margin-left:0; border-left:none; border-right:none; }
.event-pill.multiday-end { border-radius:0 4px 4px 0; border-left:none; }
.event-pill.multiday-start .pill-text, .event-pill.multiday-mid .pill-text { padding-right:4px; }
.pill-dot { width:5px; height:5px; border-radius:50%; flex-shrink:0; }
.pill-text { overflow:hidden; text-overflow:ellipsis; flex:1; }
.pill-recur { font-size:0.56rem; flex-shrink:0; opacity:0.7; }
.pill-label { font-size:0.55rem; background:#ffffff18; padding:1px 4px; border-radius:3px; flex-shrink:0; max-width:52px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.more-events { font-size:0.6rem; color:var(--text3); padding:1px 3px; cursor:pointer; }
.more-events:hover { color:var(--accent2); }

/* ‚îÄ‚îÄ WEEK ‚îÄ‚îÄ */
.week-view { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.week-header { display:grid; grid-template-columns:52px repeat(7,1fr); border-bottom:1px solid var(--border); background:var(--surface); flex-shrink:0; }
.week-day-header { text-align:center; padding:8px 4px; border-right:1px solid var(--border); }
.week-day-header:last-child { border-right:none; }
.wdh-name { font-size:0.63rem; font-weight:600; letter-spacing:0.08em; color:var(--text3); text-transform:uppercase; }
.wdh-num { font-size:1.2rem; font-weight:700; color:var(--text); margin-top:1px; display:flex; align-items:center; justify-content:center; width:30px; height:30px; border-radius:50%; margin:1px auto 0; }
.wdh-num.today { background:var(--accent); color:#fff; }
.allday-row { display:grid; border-bottom:1px solid var(--border); background:var(--surface); flex-shrink:0; min-height:26px; }
.allday-row.week-allday { grid-template-columns:52px repeat(7,1fr); }
.allday-row.day-allday { grid-template-columns:52px 1fr; }
.allday-gutter { border-right:1px solid var(--border); display:flex; align-items:center; justify-content:flex-end; padding:3px 6px 0 0; font-size:0.56rem; color:var(--text3); font-weight:600; letter-spacing:0.04em; text-transform:uppercase; }
.allday-cell { border-right:1px solid var(--border); padding:2px 3px; display:flex; flex-direction:column; gap:1px; }
.allday-cell:last-child { border-right:none; }
.allday-pill { display:flex; align-items:center; gap:3px; padding:2px 5px; border-radius:4px; font-size:0.65rem; cursor:pointer; overflow:hidden; white-space:nowrap; color:var(--text); transition:opacity 0.1s; border-left:2px solid; }
.allday-pill:hover { opacity:0.8; }
.allday-pill-dot { width:5px; height:5px; border-radius:50%; flex-shrink:0; }
.allday-pill-text { overflow:hidden; text-overflow:ellipsis; flex:1; }
.week-body { flex:1; display:grid; grid-template-columns:52px repeat(7,1fr); overflow-y:auto; position:relative; }
.time-col { border-right:1px solid var(--border); flex-shrink:0; }
.time-label { height:60px; display:flex; align-items:flex-start; justify-content:flex-end; padding:3px 7px 0 0; font-size:0.6rem; color:var(--text3); border-bottom:1px solid var(--border); }
.week-day-col { border-right:1px solid var(--border); position:relative; min-height:1440px; }
.week-day-col:last-child { border-right:none; }
.hour-line { position:absolute; left:0; right:0; height:60px; border-bottom:1px solid var(--border); pointer-events:none; }
.now-line { position:absolute; left:0; right:0; z-index:2; pointer-events:none; }
.now-line::after { content:''; position:absolute; left:0; right:0; height:2px; background:var(--red); top:0; }
.now-dot { width:9px; height:9px; background:var(--red); border-radius:50%; position:absolute; left:-4px; top:-4px; }
.week-event { position:absolute; left:2px; right:2px; border-radius:5px; padding:3px 6px; font-size:0.7rem; cursor:pointer; overflow:hidden; border-left:3px solid; transition:filter 0.1s,transform 0.1s; z-index:1; cursor:grab; }
.week-event:hover { filter:brightness(1.1); z-index:3; }
.week-event.dragging { opacity:0.5; cursor:grabbing; }
.we-title { font-weight:500; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:0.72rem; }
.we-time { color:var(--text2); font-size:0.6rem; }

/* ‚îÄ‚îÄ DAY ‚îÄ‚îÄ */
.day-view { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.day-header-bar { text-align:center; padding:8px; border-bottom:1px solid var(--border); background:var(--surface); flex-shrink:0; }
.dhb-name { font-size:0.68rem; color:var(--text3); font-weight:600; text-transform:uppercase; letter-spacing:0.08em; }
.dhb-num { font-size:1.7rem; font-weight:700; color:var(--text); }
.day-body { flex:1; display:grid; grid-template-columns:52px 1fr; overflow-y:auto; }

/* ‚îÄ‚îÄ AGENDA VIEW ‚îÄ‚îÄ */
.agenda-view { flex:1; overflow-y:auto; padding:16px 20px; }
.agenda-day-group { margin-bottom:22px; }
.agenda-day-header { display:flex; align-items:baseline; gap:10px; margin-bottom:8px; padding-bottom:6px; border-bottom:1px solid var(--border); }
.agenda-day-name { font-size:0.7rem; font-weight:700; color:var(--text3); text-transform:uppercase; letter-spacing:0.1em; width:32px; }
.agenda-day-date { font-family:'DM Serif Display',serif; font-size:1.4rem; color:var(--text); line-height:1; }
.agenda-day-date.today { color:var(--accent); }
.agenda-day-month { font-size:0.78rem; color:var(--text2); font-weight:500; }
.agenda-event { display:flex; align-items:flex-start; gap:12px; padding:9px 12px; border-radius:9px; margin-bottom:5px; cursor:pointer; transition:background 0.1s; border-left:3px solid; }
.agenda-event:hover { background:var(--surface2); }
.agenda-event-time { font-size:0.76rem; color:var(--text2); min-width:80px; padding-top:1px; }
.agenda-event-body { flex:1; }
.agenda-event-title { font-size:0.88rem; font-weight:500; }
.agenda-event-meta { font-size:0.72rem; color:var(--text2); margin-top:3px; display:flex; gap:8px; flex-wrap:wrap; }
.agenda-habit-check { width:20px; height:20px; border-radius:5px; border:2px solid; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:0.7rem; color:#fff; transition:all 0.15s; flex-shrink:0; margin-top:2px; }
.agenda-habit-check.done { opacity:1; }
.agenda-empty { text-align:center; padding:60px 20px; color:var(--text3); font-size:0.88rem; }

/* ‚îÄ‚îÄ YEAR VIEW ‚îÄ‚îÄ */
.year-view { flex:1; overflow-y:auto; padding:16px; }
.year-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; }
@media(max-width:900px){ .year-grid { grid-template-columns:repeat(3,1fr); } }
@media(max-width:600px){ .year-grid { grid-template-columns:repeat(2,1fr); } }
.year-month { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:10px; }
.year-month-name { font-size:0.78rem; font-weight:600; color:var(--text2); margin-bottom:6px; text-align:center; }
.year-month-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; }
.year-day-label { font-size:0.52rem; color:var(--text3); text-align:center; padding-bottom:2px; font-weight:600; }
.year-day { aspect-ratio:1; border-radius:3px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:0.6rem; color:var(--text3); transition:all 0.1s; position:relative; }
.year-day:hover { background:var(--surface3); color:var(--text); }
.year-day.other-m { opacity:0.2; }
.year-day.today { background:var(--accent) !important; color:#fff !important; font-weight:700; border-radius:50%; }
.year-day.has-1 { background:var(--accent-soft); color:var(--accent2); }
.year-day.has-2 { background:var(--accent)40; color:var(--accent2); }
.year-day.has-3 { background:var(--accent)70; color:#fff; }
.year-day.has-4 { background:var(--accent)99; color:#fff; }
.year-day.has-many { background:var(--accent); color:#fff; }

/* ‚îÄ‚îÄ OVERLAYS & MODALS ‚îÄ‚îÄ */
.overlay { position:fixed; inset:0; background:#00000099; z-index:100; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.2s; }
.overlay.open { opacity:1; pointer-events:all; }
.modal { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:24px; width:460px; max-width:95vw; max-height:90vh; overflow-y:auto; box-shadow:0 24px 80px var(--shadow); transform:translateY(20px) scale(0.97); transition:transform 0.2s; }
.overlay.open .modal { transform:translateY(0) scale(1); }
.modal-title { font-family:'DM Serif Display',serif; font-size:1.3rem; margin-bottom:16px; color:var(--text); }
.form-group { margin-bottom:11px; }
.form-label { font-size:0.68rem; font-weight:600; color:var(--text2); margin-bottom:4px; display:block; letter-spacing:0.05em; text-transform:uppercase; }
.form-input { width:100%; background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:8px; font-family:inherit; font-size:0.86rem; outline:none; transition:border-color 0.15s; }
.form-input:focus { border-color:var(--accent); }
select.form-input option { background:var(--surface2); }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:16px; padding-top:12px; border-top:1px solid var(--border); }
.btn-cancel { background:none; border:1px solid var(--border); color:var(--text2); padding:7px 14px; border-radius:8px; cursor:pointer; font-family:inherit; font-size:0.8rem; transition:all 0.15s; }
.btn-cancel:hover { border-color:var(--text3); color:var(--text); }
.btn-save { background:var(--accent); border:none; color:#fff; padding:7px 14px; border-radius:8px; cursor:pointer; font-family:inherit; font-size:0.8rem; font-weight:600; transition:all 0.15s; }
.btn-save:hover { background:var(--accent2); }
.btn-delete { background:none; border:1px solid var(--red); color:var(--red); padding:7px 14px; border-radius:8px; cursor:pointer; font-family:inherit; font-size:0.8rem; transition:all 0.15s; margin-right:auto; }
.btn-delete:hover { background:#f8717120; }
.recur-section { background:var(--surface2); border-radius:10px; padding:12px; margin-bottom:11px; border:1px solid var(--border); }
.recur-section .form-group { margin-bottom:8px; }
.recur-section .form-group:last-child { margin-bottom:0; }
.color-picker { display:flex; gap:6px; flex-wrap:wrap; }
.color-swatch { width:24px; height:24px; border-radius:50%; cursor:pointer; border:3px solid transparent; transition:all 0.12s; position:relative; }
.color-swatch.selected::after { content:'‚úì'; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.62rem; font-weight:700; }
.color-swatch:hover { transform:scale(1.15); }
.label-color-row { display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
.label-color-sw { width:22px; height:22px; border-radius:50%; cursor:pointer; border:3px solid transparent; transition:all 0.12s; position:relative; flex-shrink:0; }
.label-color-sw.selected::after { content:'\2713'; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.6rem; font-weight:700; }
.label-color-sw:hover { transform:scale(1.15); }

/* ‚îÄ‚îÄ EVENT POPUP ‚îÄ‚îÄ */
.event-popup { position:fixed; z-index:90; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:13px; width:285px; box-shadow:0 12px 40px var(--shadow); display:none; }
.event-popup.open { display:block; }
.ep-header { display:flex; align-items:flex-start; gap:8px; margin-bottom:7px; }
.ep-color { width:10px; height:10px; border-radius:50%; flex-shrink:0; margin-top:4px; }
.ep-title { font-weight:600; font-size:0.9rem; flex:1; }
.ep-close { background:none; border:none; color:var(--text3); cursor:pointer; font-size:1.1rem; line-height:1; }
.ep-meta { font-size:0.73rem; color:var(--text2); margin-bottom:2px; }
.ep-recur-badge { display:inline-flex; align-items:center; gap:3px; font-size:0.66rem; background:var(--accent-soft); color:var(--accent2); padding:2px 7px; border-radius:10px; margin-top:4px; }
.ep-label-badge { display:inline-flex; align-items:center; gap:5px; font-size:0.72rem; padding:2px 8px; border-radius:20px; margin-top:5px; font-weight:500; }
.ep-label-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
.ep-cal-badge { display:inline-flex; align-items:center; gap:5px; font-size:0.72rem; color:var(--text2); margin-top:4px; }
.ep-cal-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
.ep-desc { font-size:0.75rem; color:var(--text2); margin-top:7px; border-top:1px solid var(--border); padding-top:7px; }
.ep-actions { display:flex; gap:5px; margin-top:9px; flex-wrap:wrap; }
.ep-btn { flex:1; padding:5px 4px; border-radius:6px; border:1px solid var(--border); background:none; color:var(--text2); font-family:inherit; font-size:0.7rem; cursor:pointer; transition:all 0.12s; white-space:nowrap; text-align:center; }
.ep-btn:hover { border-color:var(--accent); color:var(--accent2); }
.ep-btn.danger { border-color:var(--red); color:var(--red); }
.ep-btn.danger:hover { background:#f8717120; }
.ep-btn.success { border-color:var(--green); color:var(--green); }
.ep-btn.success:hover { background:#4ade8020; }

/* Copy / Delete / Label modals */
.copy-modal { width:340px; }
.copy-modal p { font-size:0.82rem; color:var(--text2); margin-bottom:14px; }
.del-dialog { width:360px; }
.del-dialog p { font-size:0.81rem; color:var(--text2); margin-bottom:4px; }
.del-choice { display:flex; flex-direction:column; gap:6px; margin:11px 0; }
.del-opt { display:flex; align-items:flex-start; gap:8px; padding:9px 11px; border-radius:8px; border:1px solid var(--border); cursor:pointer; transition:all 0.12s; }
.del-opt:hover { border-color:var(--red); background:#f8717110; }
.del-opt input { margin-top:3px; accent-color:var(--accent); }
.del-opt-label { font-size:0.82rem; font-weight:500; }
.del-opt-sub { font-size:0.72rem; color:var(--text2); margin-top:2px; }
.label-modal { width:350px; }
.cal-modal { width:350px; }
.habit-modal { width:380px; }

/* Timezone / reminder fields */
.tz-row { display:flex; align-items:center; gap:8px; }

/* ‚îÄ‚îÄ IMPORT/EXPORT ‚îÄ‚îÄ */
.io-wrapper { position:relative; }
.io-dropdown { position:absolute; top:calc(100% + 6px); right:0; background:var(--surface); border:1px solid var(--border); border-radius:10px; min-width:195px; box-shadow:0 12px 36px var(--shadow); z-index:200; overflow:hidden; display:none; }
.io-wrapper.open .io-dropdown { display:block; }
.io-section-label { font-size:0.63rem; font-weight:700; color:var(--text3); text-transform:uppercase; letter-spacing:0.1em; padding:9px 13px 3px; }
.io-item { display:flex; align-items:center; gap:8px; padding:8px 13px; cursor:pointer; font-size:0.81rem; color:var(--text2); transition:all 0.12s; border:none; background:none; font-family:inherit; width:100%; text-align:left; }
.io-item:hover { background:var(--surface2); color:var(--text); }
.io-item .io-icon { font-size:0.95rem; width:16px; text-align:center; flex-shrink:0; }
.io-item .io-sub { font-size:0.68rem; color:var(--text3); display:block; margin-top:1px; }
.io-divider { height:1px; background:var(--border); margin:3px 0; }
.import-modal { width:420px; }
.import-drop-zone { border:2px dashed var(--border); border-radius:10px; padding:24px 18px; text-align:center; cursor:pointer; transition:all 0.2s; margin-bottom:12px; }
.import-drop-zone:hover,.import-drop-zone.drag-over { border-color:var(--accent); background:var(--accent-soft); }
.import-drop-zone .dz-icon { font-size:1.8rem; margin-bottom:6px; }
.import-drop-zone .dz-title { font-size:0.88rem; font-weight:600; color:var(--text); margin-bottom:3px; }
.import-drop-zone .dz-sub { font-size:0.74rem; color:var(--text2); }
.import-preview { background:var(--surface2); border-radius:8px; padding:11px 13px; margin-bottom:12px; display:none; }
.import-preview .ip-stat { font-size:0.8rem; color:var(--text2); margin-bottom:3px; }
.import-mode { display:flex; gap:7px; margin-bottom:4px; }
.import-mode-opt { flex:1; padding:8px 9px; border-radius:8px; border:1px solid var(--border); background:none; font-family:inherit; font-size:0.76rem; color:var(--text2); cursor:pointer; transition:all 0.12s; text-align:center; }
.import-mode-opt.selected { border-color:var(--accent); background:var(--accent-soft); color:var(--accent2); }
.import-mode-sub { font-size:0.68rem; color:var(--text3); text-align:center; margin-top:3px; }

/* ‚îÄ‚îÄ JUMP TO DATE ‚îÄ‚îÄ */
.jump-wrapper { position:relative; }
.jump-btn { background:none; border:1px solid var(--border); color:var(--text2); padding:4px 10px; border-radius:8px; cursor:pointer; font-family:inherit; font-size:0.78rem; font-weight:500; transition:all 0.15s; display:flex; align-items:center; gap:4px; }
.jump-btn:hover { border-color:var(--accent); color:var(--accent2); }
.jump-dropdown { position:absolute; top:calc(100% + 6px); left:50%; transform:translateX(-50%); background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:14px; box-shadow:0 12px 36px var(--shadow); z-index:200; display:none; min-width:220px; }
.jump-wrapper.open .jump-dropdown { display:block; }
.jump-dropdown label { font-size:0.68rem; font-weight:600; color:var(--text2); text-transform:uppercase; letter-spacing:0.06em; display:block; margin-bottom:6px; }
.jump-date-input { width:100%; background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:8px; font-family:inherit; font-size:0.88rem; outline:none; transition:border-color 0.15s; margin-bottom:8px; }
.jump-date-input:focus { border-color:var(--accent); }
.jump-go-btn { width:100%; background:var(--accent); border:none; color:#fff; padding:7px; border-radius:8px; cursor:pointer; font-family:inherit; font-size:0.82rem; font-weight:600; transition:background 0.15s; }
.jump-go-btn:hover { background:var(--accent2); }

/* ‚îÄ‚îÄ FIREBASE / SYNC ‚îÄ‚îÄ */
.sync-indicator { display:flex; align-items:center; gap:5px; padding:4px 10px; border-radius:8px; border:1px solid var(--border); font-size:0.76rem; color:var(--text2); background:var(--surface2); cursor:pointer; transition:all 0.15s; user-select:none; white-space:nowrap; }
.sync-indicator:hover { border-color:var(--accent); color:var(--text); }
.sync-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; transition:background 0.3s; }
.sync-dot.connected { background:#4ade80; box-shadow:0 0 6px #4ade8060; }
.sync-dot.syncing { background:#fbbf24; animation:pulse-dot 1s infinite; }
.sync-dot.offline { background:#f87171; }
.sync-dot.local { background:var(--text3); }
@keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:0.4} }
.room-badge { display:inline-flex; align-items:center; gap:4px; background:var(--accent-soft); border:1px solid var(--accent); color:var(--accent2); padding:3px 9px; border-radius:20px; font-size:0.74rem; font-weight:600; letter-spacing:0.06em; cursor:pointer; transition:all 0.15s; white-space:nowrap; }
.room-badge:hover { background:var(--accent); color:#fff; }
.fb-modal { width:470px; }
.fb-steps {} 
.fb-step { display:flex; gap:11px; margin-bottom:14px; }
.fb-step-num { width:21px; height:21px; border-radius:50%; background:var(--accent); color:#fff; font-size:0.68rem; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:1px; }
.fb-step-body { flex:1; }
.fb-step-title { font-size:0.83rem; font-weight:600; color:var(--text); margin-bottom:3px; }
.fb-step-sub { font-size:0.74rem; color:var(--text2); line-height:1.5; }
.fb-step-sub a { color:var(--accent2); text-decoration:none; }
.fb-step-sub a:hover { text-decoration:underline; }
.fb-config-area { width:100%; min-height:100px; background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:9px 11px; border-radius:8px; font-family:'Courier New',monospace; font-size:0.76rem; outline:none; resize:vertical; transition:border-color 0.15s; }
.fb-config-area:focus { border-color:var(--accent); }
.fb-skip { background:none; border:none; color:var(--text3); font-family:inherit; font-size:0.76rem; cursor:pointer; padding:4px; text-decoration:underline; }
.fb-skip:hover { color:var(--text2); }
.fb-info-box { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:9px 12px; font-size:0.76rem; color:var(--text2); line-height:1.6; margin-bottom:12px; }
.fb-info-box strong { color:var(--text); }
.room-modal { width:390px; }
.room-section { margin-bottom:18px; }
.room-section-title { font-size:0.76rem; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:9px; }
.room-divider { display:flex; align-items:center; gap:9px; margin:16px 0; color:var(--text3); font-size:0.73rem; }
.room-divider::before,.room-divider::after { content:''; flex:1; height:1px; background:var(--border); }
.room-join-row { display:flex; gap:7px; }
.room-join-input { flex:1; background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:8px 11px; border-radius:8px; font-family:'Courier New',monospace; font-size:0.88rem; font-weight:600; letter-spacing:0.1em; outline:none; text-transform:uppercase; transition:border-color 0.15s; }
.room-join-input:focus { border-color:var(--accent); }
.btn-join { background:var(--surface3); border:1px solid var(--border); color:var(--text); padding:8px 14px; border-radius:8px; cursor:pointer; font-family:inherit; font-size:0.81rem; font-weight:600; transition:all 0.15s; }
.btn-join:hover { border-color:var(--accent); color:var(--accent2); }
.room-current { background:var(--accent-soft); border:1px solid var(--accent); border-radius:10px; padding:11px 13px; display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
.room-current-code { font-family:'Courier New',monospace; font-size:1.05rem; font-weight:700; color:var(--accent2); letter-spacing:0.14em; }
.room-current-label { font-size:0.68rem; color:var(--text2); margin-top:2px; }
.btn-leave { background:none; border:1px solid var(--red); color:var(--red); padding:5px 11px; border-radius:7px; cursor:pointer; font-family:inherit; font-size:0.74rem; transition:all 0.15s; }
.btn-leave:hover { background:#f8717120; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:var(--surface3); border:1px solid var(--border); color:var(--text); padding:9px 18px; border-radius:10px; font-size:0.8rem; z-index:999; box-shadow:0 8px 24px var(--shadow); opacity:0; transition:opacity 0.3s; pointer-events:none; white-space:nowrap; }

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar { width:5px; height:5px; } ::-webkit-scrollbar-track { background:transparent; } ::-webkit-scrollbar-thumb { background:var(--surface3); border-radius:10px; }
.no-events { color:var(--text3); font-size:0.75rem; text-align:center; padding:12px 0; }

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
@media(max-width:680px){
  nav { padding:6px 8px; gap:5px; }
  .logo { font-size:1rem; }
  .nav-center { gap:4px; }
  .month-title { min-width:140px; font-size:1rem; }
  .search-input { width:100px; font-size:0.74rem; }
  .search-input:focus { width:150px; }
  .sync-indicator span:last-child { display:none; }
  .sidebar { width:200px; }
  .modal { padding:18px; }
  .year-grid { grid-template-columns:repeat(2,1fr); }
  .agenda-view { padding:10px 12px; }
}
@media(max-width:480px){
  .view-tabs .nav-btn:not(.active) { padding:5px 7px; font-size:0.72rem; }
  .add-btn { padding:5px 10px; font-size:0.76rem; }
  .nav-center { order:-1; width:100%; justify-content:center; }
  nav { justify-content:space-between; }
}

/* ‚îÄ‚îÄ DRAG GHOST ‚îÄ‚îÄ */
.drag-ghost { position:fixed; pointer-events:none; z-index:9999; opacity:0.85; background:var(--drag-ghost); backdrop-filter:blur(4px); border-radius:6px; padding:4px 10px; font-size:0.75rem; color:var(--accent2); border:1px solid var(--accent); font-family:'DM Sans',sans-serif; white-space:nowrap; }

/* ‚îÄ‚îÄ REMINDER BADGE ‚îÄ‚îÄ */
.reminder-badge { display:inline-flex; align-items:center; gap:3px; font-size:0.68rem; background:#fbbf2420; color:#fbbf24; padding:2px 7px; border-radius:10px; margin-top:4px; }

/* ‚îÄ‚îÄ SETTINGS PANEL ‚îÄ‚îÄ */
.settings-modal { width:420px; }
.settings-section { margin-bottom:20px; }
.settings-section-title { font-size:0.72rem; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:10px; padding-bottom:6px; border-bottom:1px solid var(--border); }
.setting-row { display:flex; align-items:center; justify-content:space-between; padding:7px 0; }
.setting-label { font-size:0.84rem; color:var(--text); }
.setting-sub { font-size:0.72rem; color:var(--text2); margin-top:2px; }
.toggle-sw { position:relative; width:36px; height:20px; cursor:pointer; }
.toggle-sw input { opacity:0; width:0; height:0; position:absolute; }
.toggle-track { position:absolute; inset:0; background:var(--surface3); border-radius:20px; transition:background 0.2s; }
.toggle-sw input:checked + .toggle-track { background:var(--accent); }
.toggle-thumb { position:absolute; width:14px; height:14px; background:#fff; border-radius:50%; top:3px; left:3px; transition:transform 0.2s; }
.toggle-sw input:checked ~ .toggle-thumb { transform:translateX(16px); }
</style>

<!-- ‚îÄ‚îÄ NAV ‚îÄ‚îÄ -->
<nav id="main-nav">
  <div class="logo">Cal<span>¬∑</span>IO</div>
  <div class="view-tabs">
    <button class="nav-btn active" onclick="setView('month')" id="btn-month">Month</button>
    <button class="nav-btn" onclick="setView('week')" id="btn-week">Week</button>
    <button class="nav-btn" onclick="setView('day')" id="btn-day">Day</button>
    <button class="nav-btn" onclick="setView('year')" id="btn-year">Year</button>
    <button class="nav-btn" onclick="setView('agenda')" id="btn-agenda">Agenda</button>
  </div>
  <div class="nav-center">
    <button class="arrow-btn" onclick="navigate(-1)">&#8249;</button>
    <button class="today-btn" onclick="goToday()">Today</button>
    <button class="arrow-btn" onclick="navigate(1)">&#8250;</button>
    <div class="month-title" id="main-title" onclick="openJumpToDate()" title="Click to jump to date (G)"></div>
    <div class="jump-wrapper" id="jump-wrapper">
      <button class="jump-btn" onclick="openJumpToDate()" title="Jump to date (G)">üìÖ Go to‚Ä¶</button>
      <div class="jump-dropdown" id="jump-dropdown">
        <label>Jump to Date</label>
        <input type="date" class="jump-date-input" id="jump-date-input" onkeydown="if(event.key==='Enter')confirmJump()" />
        <button class="jump-go-btn" onclick="confirmJump()">Go to Date</button>
      </div>
    </div>
  </div>

  <!-- Search -->
  <div class="search-wrap" id="search-wrap">
    <span class="search-icon">üîç</span>
    <input class="search-input" id="search-input" placeholder="Search events‚Ä¶" autocomplete="off"
      oninput="handleSearch(this.value)" onfocus="handleSearch(this.value)" />
    <div class="search-results" id="search-results"></div>
  </div>

  <button class="nav-btn" id="sidebar-toggle-btn" onclick="toggleSidebar()" title="Toggle sidebar (Esc)">‚ò∞</button>

  <!-- Import/Export -->
  <div class="io-wrapper" id="io-wrapper">
    <button class="nav-btn" onclick="toggleIODropdown(event)" title="Import / Export">‚áÖ</button>
    <div class="io-dropdown" id="io-dropdown">
      <div class="io-section-label">Export</div>
      <button class="io-item" onclick="exportJSON()"><span class="io-icon">üì¶</span><span><span style="font-weight:500;color:var(--text)">Export JSON</span><span class="io-sub">Full backup</span></span></button>
      <button class="io-item" onclick="exportICS()"><span class="io-icon">üìÖ</span><span><span style="font-weight:500;color:var(--text)">Export .ics</span><span class="io-sub">Google, Apple, Outlook</span></span></button>
      <div class="io-divider"></div>
      <div class="io-section-label">Import</div>
      <button class="io-item" onclick="openImportModal('json')"><span class="io-icon">üìÇ</span><span><span style="font-weight:500;color:var(--text)">Import JSON</span><span class="io-sub">Restore backup</span></span></button>
      <button class="io-item" onclick="openImportModal('ics')"><span class="io-icon">üóì</span><span><span style="font-weight:500;color:var(--text)">Import .ics</span></span></button>
    </div>
  </div>

  <!-- Settings -->
  <button class="icon-btn" onclick="openSettings()" title="Settings">‚öô</button>

  <!-- Firebase sync -->
  <div id="sync-indicator" class="sync-indicator" onclick="openRoomModal()" title="Firebase sync">
    <div class="sync-dot local" id="sync-dot"></div>
    <span id="sync-label">Local</span>
  </div>
  <div id="room-badge-wrap" style="display:none">
    <div class="room-badge" onclick="openRoomModal()">‚ö° <span id="room-badge-code"></span></div>
  </div>

  <button class="add-btn" onclick="openModal()">+ New Event</button>
</nav>

<input type="file" id="file-input" style="display:none" />

<div class="main">
  <!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
  <div class="sidebar" id="sidebar">

    <!-- Mini calendar -->
    <div id="mini-cal-section">
      <div class="mini-cal-header">
        <span class="mini-cal-title" id="mini-title"></span>
        <div style="display:flex;align-items:center;gap:2px">
          <button class="mini-arrow" onclick="miniNav(-1)">&#8249;</button>
          <button class="mini-arrow" onclick="miniNav(1)">&#8250;</button>
          <button class="mini-toggle-btn" onclick="toggleMiniCal()" title="Hide">‚úï</button>
        </div>
      </div>
      <div class="mini-grid" id="mini-grid"></div>
    </div>
    <div id="mini-show-row" style="display:none">
      <div class="section-title">Mini Calendar <button class="mini-toggle-btn" onclick="toggleMiniCal()">Show</button></div>
    </div>

    <!-- Calendars -->
    <div id="calendars-section">
      <div class="section-title">Calendars
        <div style="display:flex;align-items:center;gap:3px">
          <button class="mini-toggle-btn" onclick="openCalModal(null)">+ Add</button>
          <button class="mini-toggle-btn" onclick="toggleCalendars()" id="cals-toggle-btn">‚úï</button>
        </div>
      </div>
      <div id="calendars-list"></div>
    </div>
    <div id="calendars-show-row" style="display:none">
      <div class="section-title">Calendars <button class="mini-toggle-btn" onclick="toggleCalendars()">Show</button></div>
    </div>

    <!-- Labels -->
    <div id="labels-section">
      <div class="section-title">Labels
        <div style="display:flex;align-items:center;gap:3px">
          <button class="mini-toggle-btn" onclick="openLabelModal(null)">+ Add</button>
          <button class="mini-toggle-btn" onclick="toggleLabels()" id="labels-toggle-btn">‚úï</button>
        </div>
      </div>
      <div id="labels-list"></div>
    </div>
    <div id="labels-show-row" style="display:none">
      <div class="section-title">Labels <button class="mini-toggle-btn" onclick="toggleLabels()">Show</button></div>
    </div>

    <!-- Habits -->
    <div id="habits-section">
      <div class="section-title">Habits
        <div style="display:flex;align-items:center;gap:3px">
          <button class="mini-toggle-btn" onclick="openHabitModal(null)">+ Add</button>
          <button class="mini-toggle-btn" onclick="toggleHabits()" id="habits-toggle-btn">‚úï</button>
        </div>
      </div>
      <div id="habits-list"></div>
    </div>
    <div id="habits-show-row" style="display:none">
      <div class="section-title">Habits <button class="mini-toggle-btn" onclick="toggleHabits()">Show</button></div>
    </div>

    <!-- Upcoming -->
    <div id="upcoming-section">
      <div class="section-title">Upcoming
        <button class="mini-toggle-btn" onclick="toggleUpcoming()" id="upcoming-toggle-btn">‚úï</button>
      </div>
      <div id="upcoming-list"></div>
    </div>
    <div id="upcoming-show-row" style="display:none">
      <div class="section-title">Upcoming <button class="mini-toggle-btn" onclick="toggleUpcoming()">Show</button></div>
    </div>

  </div>
  <div class="calendar-area" id="calendar-area"></div>
</div>

<!-- ‚îÄ‚îÄ EVENT MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="modal-overlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-title" id="modal-title">New Event</div>
    <div class="form-group">
      <label class="form-label">Title</label>
      <input class="form-input" id="ev-title" placeholder="Event title" />
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Start Date</label>
        <input class="form-input" id="ev-date" type="date" />
      </div>
      <div class="form-group">
        <label class="form-label">End Date</label>
        <input class="form-input" id="ev-end-date" type="date" placeholder="Same day" />
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">All Day</label>
        <select class="form-input" id="ev-allday" onchange="toggleTimeFields()">
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Calendar</label>
        <div style="display:flex;gap:6px;align-items:center">
          <select class="form-input" id="ev-calendar" style="flex:1"></select>
          <button type="button" onclick="openCalModalFromEvent()" title="New calendar"
            style="flex-shrink:0;background:var(--surface3);border:1px solid var(--border);color:var(--text2);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all 0.15s;"
            onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent2)'"
            onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text2)'">+</button>
        </div>
      </div>
    </div>
    <div id="time-fields" style="display:none">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Start Time</label>
          <input class="form-input" id="ev-start" type="time" value="09:00" />
        </div>
        <div class="form-group">
          <label class="form-label">End Time</label>
          <input class="form-input" id="ev-end" type="time" value="10:00" />
        </div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <input class="form-input" id="ev-desc" placeholder="Optional description" />
    </div>
    <div class="form-group">
      <label class="form-label">Label</label>
      <div style="display:flex;gap:6px;align-items:center">
        <select class="form-input" id="ev-label" onchange="onLabelChange()" style="flex:1">
          <option value="">‚Äî No label ‚Äî</option>
        </select>
        <button type="button" onclick="openLabelModalFromEvent()" title="New label"
          style="flex-shrink:0;background:var(--surface3);border:1px solid var(--border);color:var(--text2);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all 0.15s;"
          onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent2)'"
          onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text2)'">+</button>
      </div>
      <div id="ev-label-preview" style="display:none;margin-top:6px;padding:5px 9px;border-radius:7px;font-size:0.76rem;font-weight:500;align-items:center;gap:6px;">
        <span id="ev-label-preview-dot" style="width:8px;height:8px;border-radius:50%;flex-shrink:0;"></span>
        <span id="ev-label-preview-text"></span>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Reminder</label>
      <select class="form-input" id="ev-reminder">
        <option value="">No reminder</option>
        <option value="0">At event time</option>
        <option value="5">5 minutes before</option>
        <option value="10">10 minutes before</option>
        <option value="15">15 minutes before</option>
        <option value="30">30 minutes before</option>
        <option value="60">1 hour before</option>
        <option value="120">2 hours before</option>
        <option value="1440">1 day before</option>
      </select>
    </div>
    <!-- RECURRENCE -->
    <div class="form-group">
      <label class="form-label">Repeat</label>
      <select class="form-input" id="ev-recur-type" onchange="onRecurTypeChange()">
        <option value="none">Does not repeat</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
      </select>
    </div>
    <div class="recur-section" id="recur-section" style="display:none">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Every</label>
          <input class="form-input" id="ev-recur-interval" type="number" min="1" max="99" value="1" />
        </div>
        <div class="form-group">
          <label class="form-label" id="recur-unit-label">day(s)</label>
          <select class="form-input" id="ev-recur-end-type" onchange="onRecurEndChange()">
            <option value="never">Never ends</option>
            <option value="on">Ends on date</option>
            <option value="after">Ends after N times</option>
          </select>
        </div>
      </div>
      <div class="form-group" id="recur-end-date-row" style="display:none">
        <label class="form-label">End Date</label>
        <input class="form-input" id="ev-recur-end-date" type="date" />
      </div>
      <div class="form-group" id="recur-end-count-row" style="display:none">
        <label class="form-label">Occurrences</label>
        <input class="form-input" id="ev-recur-count" type="number" min="1" max="999" value="10" />
      </div>
    </div>
    <div class="modal-actions" id="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="saveEvent()">Save Event</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ COPY MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="copy-overlay" onclick="if(event.target===this)closeCopyModal()">
  <div class="modal copy-modal">
    <div class="modal-title">Copy Event</div>
    <p>Choose a new date to copy <strong id="copy-ev-name" style="color:var(--text)"></strong> to.</p>
    <div class="form-group"><label class="form-label">Copy to Date</label><input class="form-input" id="copy-date" type="date" /></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeCopyModal()">Cancel</button>
      <button class="btn-save" onclick="confirmCopy()">Copy Event</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ DELETE DIALOG ‚îÄ‚îÄ -->
<div class="overlay" id="del-overlay" onclick="if(event.target===this)closeDelDialog()">
  <div class="modal del-dialog">
    <div class="modal-title">Delete Recurring Event</div>
    <p>How would you like to delete <strong id="del-ev-name" style="color:var(--text)"></strong>?</p>
    <div class="del-choice">
      <label class="del-opt"><input type="radio" name="del-scope" value="this" checked /><div><div class="del-opt-label">This occurrence only</div><div class="del-opt-sub">Removes just this one date from the series</div></div></label>
      <label class="del-opt"><input type="radio" name="del-scope" value="future" /><div><div class="del-opt-label">This and following events</div><div class="del-opt-sub">Ends the series at this date</div></div></label>
      <label class="del-opt"><input type="radio" name="del-scope" value="all" /><div><div class="del-opt-label">All occurrences</div><div class="del-opt-sub">Deletes the entire repeating series</div></div></label>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeDelDialog()">Cancel</button>
      <button class="btn-delete" style="margin-right:0" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ CALENDAR MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="cal-overlay" onclick="if(event.target===this)closeCalModal()">
  <div class="modal cal-modal">
    <div class="modal-title" id="cal-modal-title">New Calendar</div>
    <div class="form-group"><label class="form-label">Name</label><input class="form-input" id="cal-name" placeholder="e.g. Work, Family, Personal‚Ä¶" /></div>
    <div class="form-group"><label class="form-label">Color</label><div class="label-color-row" id="cal-color-picker"></div></div>
    <div class="modal-actions" id="cal-modal-actions">
      <button class="btn-cancel" onclick="closeCalModal()">Cancel</button>
      <button class="btn-save" onclick="saveCalendar()">Save Calendar</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ LABEL MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="label-overlay" onclick="if(event.target===this)closeLabelModal()">
  <div class="modal label-modal">
    <div class="modal-title" id="label-modal-title">New Label</div>
    <div class="form-group"><label class="form-label">Name</label><input class="form-input" id="lbl-name" placeholder="e.g. Important, Travel‚Ä¶" /></div>
    <div class="form-group"><label class="form-label">Color</label><div class="label-color-row" id="label-color-picker"></div></div>
    <div class="modal-actions" id="label-modal-actions">
      <button class="btn-cancel" onclick="closeLabelModal()">Cancel</button>
      <button class="btn-save" onclick="saveLabel()">Save Label</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ HABIT MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="habit-overlay" onclick="if(event.target===this)closeHabitModal()">
  <div class="modal habit-modal">
    <div class="modal-title" id="habit-modal-title">New Habit</div>
    <div class="form-group"><label class="form-label">Name</label><input class="form-input" id="habit-name" placeholder="e.g. Meditate, Exercise, Read‚Ä¶" /></div>
    <div class="form-group"><label class="form-label">Frequency</label>
      <select class="form-input" id="habit-freq">
        <option value="daily">Every day</option>
        <option value="weekdays">Weekdays only</option>
        <option value="weekly">Once a week</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Color</label><div class="label-color-row" id="habit-color-picker"></div></div>
    <div class="modal-actions" id="habit-modal-actions">
      <button class="btn-cancel" onclick="closeHabitModal()">Cancel</button>
      <button class="btn-save" onclick="saveHabit()">Save Habit</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ SETTINGS MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="settings-overlay" onclick="if(event.target===this)closeSettings()">
  <div class="modal settings-modal">
    <div class="modal-title">Settings</div>

    <div class="settings-section">
      <div class="settings-section-title">Appearance</div>
      <div class="setting-row">
        <div><div class="setting-label">Light Mode</div><div class="setting-sub">Switch between dark and light themes</div></div>
        <label class="toggle-sw">
          <input type="checkbox" id="theme-toggle" onchange="toggleTheme()" />
          <div class="toggle-track"></div>
          <div class="toggle-thumb"></div>
        </label>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Time Zone</div>
      <div class="form-group">
        <label class="form-label">Display Time Zone</label>
        <select class="form-input" id="tz-select" onchange="onTzChange()">
          <option value="">Use device timezone</option>
        </select>
        <div style="font-size:0.72rem;color:var(--text2);margin-top:5px;" id="tz-current-label"></div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Notifications</div>
      <div class="setting-row">
        <div><div class="setting-label">Browser Notifications</div><div class="setting-sub" id="notif-status">Click to request permission</div></div>
        <button class="btn-save" style="padding:5px 12px;font-size:0.76rem;" onclick="requestNotifPermission()">Enable</button>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeSettings()">Close</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ IMPORT MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="import-overlay" onclick="if(event.target===this)closeImportModal()">
  <div class="modal import-modal">
    <div class="modal-title" id="import-modal-title">Import Events</div>
    <div class="import-drop-zone" id="import-drop-zone" onclick="triggerFileInput()">
      <div class="dz-icon" id="dz-icon">üìÅ</div>
      <div class="dz-title" id="dz-title">Click to choose a file</div>
      <div class="dz-sub" id="dz-sub">or drag & drop here</div>
    </div>
    <div class="import-preview" id="import-preview">
      <div class="ip-stat" id="ip-count"></div>
      <div class="ip-stat" id="ip-range"></div>
    </div>
    <div style="margin-bottom:6px">
      <label class="form-label">Import mode</label>
      <div class="import-mode">
        <button class="import-mode-opt selected" id="mode-merge" onclick="setImportMode('merge')">Merge</button>
        <button class="import-mode-opt" id="mode-replace" onclick="setImportMode('replace')">Replace all</button>
      </div>
      <div class="import-mode-sub" id="import-mode-desc">Add alongside existing events.</div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeImportModal()">Cancel</button>
      <button class="btn-save" id="import-confirm-btn" onclick="confirmImport()" disabled style="opacity:0.4;cursor:not-allowed">Import</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ FIREBASE SETUP ‚îÄ‚îÄ -->
<div class="overlay" id="fb-setup-overlay" onclick="if(event.target===this)closeFbSetup()">
  <div class="modal fb-modal">
    <div class="modal-title">Connect to Firebase</div>
    <div class="fb-info-box">Firebase lets you <strong>sync across devices</strong> and <strong>collaborate in real-time</strong> using a shared room code ‚Äî no accounts needed.</div>
    <div class="fb-steps">
      <div class="fb-step"><div class="fb-step-num">1</div><div class="fb-step-body"><div class="fb-step-title">Create a Firebase project</div><div class="fb-step-sub">Go to <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a> ‚Üí Add project ‚Üí disable Analytics ‚Üí Create.</div></div></div>
      <div class="fb-step"><div class="fb-step-num">2</div><div class="fb-step-body"><div class="fb-step-title">Add a Web app & copy config</div><div class="fb-step-sub">Project Overview ‚Üí &lt;/&gt; Web ‚Üí register ‚Üí copy the <code style="background:var(--surface3);padding:1px 4px;border-radius:3px">firebaseConfig</code> object.</div></div></div>
      <div class="fb-step"><div class="fb-step-num">3</div><div class="fb-step-body"><div class="fb-step-title">Enable Firestore</div><div class="fb-step-sub">Build ‚Üí Firestore Database ‚Üí Create ‚Üí <strong>test mode</strong> ‚Üí any region ‚Üí Enable.</div></div></div>
      <div class="fb-step"><div class="fb-step-num">4</div><div class="fb-step-body"><div class="fb-step-title">Paste your config</div>
        <div class="fb-step-sub" style="margin-bottom:7px">Paste exactly as shown ‚Äî the full <code style="background:var(--surface3);padding:1px 3px;border-radius:3px">const firebaseConfig = { ‚Ä¶ }</code> block works fine.</div>
        <textarea class="fb-config-area" id="fb-config-input" placeholder="const firebaseConfig = {&#10;  apiKey: &quot;...&quot;,&#10;  authDomain: &quot;...&quot;,&#10;  projectId: &quot;...&quot;,&#10;  ...&#10;};"></textarea>
        <div id="fb-config-error" style="color:var(--red);font-size:0.74rem;margin-top:4px;display:none"></div>
      </div></div>
    </div>
    <div class="modal-actions">
      <button class="fb-skip" onclick="closeFbSetup()">Skip for now</button>
      <button class="btn-save" onclick="connectFirebase()">Connect Firebase</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ ROOM MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="room-overlay" onclick="if(event.target===this)closeRoomModal()">
  <div class="modal room-modal">
    <div class="modal-title">Sync & Collaboration</div>
    <div id="room-no-firebase" style="display:none">
      <div class="fb-info-box" style="margin-bottom:12px">Firebase is not connected. Set it up to use sync and rooms.</div>
      <div class="modal-actions" style="margin-top:0;padding-top:0;border-top:none">
        <button class="btn-cancel" onclick="closeRoomModal()">Close</button>
        <button class="btn-save" onclick="closeRoomModal();openFbSetup()">Connect Firebase</button>
      </div>
    </div>
    <div id="room-firebase-panel" style="display:none">
      <div id="room-active-section" style="display:none">
        <div class="room-section-title">Current Room</div>
        <div class="room-current">
          <div><div class="room-current-code" id="room-active-code"></div><div class="room-current-label">Share this code to collaborate</div></div>
          <button class="btn-leave" onclick="leaveRoom()">Leave</button>
        </div>
        <button class="btn-save" style="width:100%;margin-bottom:6px" onclick="copyRoomCode()">üìã Copy room code</button>
        <button class="btn-cancel" style="width:100%;text-align:center" onclick="closeRoomModal()">Done</button>
      </div>
      <div id="room-noroom-section" style="display:none">
        <div class="room-section">
          <div class="room-section-title">Create a new room</div>
          <div class="fb-info-box">Anyone with the code can view and edit events in real-time.</div>
          <button class="btn-save" style="width:100%" onclick="createRoom()">‚ú¶ Create New Room</button>
        </div>
        <div class="room-divider">or join existing</div>
        <div class="room-section">
          <div class="room-section-title">Join a room</div>
          <div class="room-join-row">
            <input class="room-join-input" id="room-join-input" placeholder="ENTER CODE" maxlength="6" oninput="this.value=this.value.toUpperCase()" onkeydown="if(event.key==='Enter')joinRoom()" />
            <button class="btn-join" onclick="joinRoom()">Join</button>
          </div>
          <div id="room-join-error" style="color:var(--red);font-size:0.74rem;margin-top:5px;display:none"></div>
        </div>
        <div class="modal-actions" style="border-top:1px solid var(--border);padding-top:11px;margin-top:3px">
          <button class="btn-cancel" onclick="closeRoomModal()">Cancel</button>
          <button class="fb-skip" onclick="disconnectFirebase()" style="margin-left:auto">Disconnect Firebase</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ EVENT POPUP ‚îÄ‚îÄ -->
<div class="event-popup" id="event-popup">
  <div class="ep-header">
    <div class="ep-color" id="ep-color"></div>
    <div class="ep-title" id="ep-title"></div>
    <button class="ep-close" onclick="closePopup()">√ó</button>
  </div>
  <div class="ep-meta" id="ep-date-meta"></div>
  <div class="ep-meta" id="ep-time-meta"></div>
  <div id="ep-recur-badge" class="ep-recur-badge" style="display:none">‚Üª <span id="ep-recur-text"></span></div>
  <div id="ep-reminder-badge" class="reminder-badge" style="display:none">üîî <span id="ep-reminder-text"></span></div>
  <div id="ep-label-badge" class="ep-label-badge" style="display:none"><span class="ep-label-dot" id="ep-label-dot"></span><span id="ep-label-text"></span></div>
  <div id="ep-cal-badge" class="ep-cal-badge" style="display:none"><span class="ep-cal-dot" id="ep-cal-dot"></span><span id="ep-cal-text"></span></div>
  <div class="ep-desc" id="ep-desc" style="display:none"></div>
  <div class="ep-actions">
    <button class="ep-btn" onclick="editEventFromPopup()">‚úè Edit</button>
    <button class="ep-btn success" onclick="copyEventFromPopup()">‚éò Copy</button>
    <button class="ep-btn danger" onclick="deleteEventFromPopup()">üóë Delete</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ DRAG GHOST ‚îÄ‚îÄ -->
<div class="drag-ghost" id="drag-ghost" style="display:none"></div>

<div id="toast"></div>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COLORS=[
  {name:'violet',hex:'#7c6af7'},{name:'pink',hex:'#f472b6'},{name:'red',hex:'#f87171'},
  {name:'orange',hex:'#fb923c'},{name:'yellow',hex:'#fbbf24'},{name:'green',hex:'#4ade80'},
  {name:'teal',hex:'#2dd4bf'},{name:'blue',hex:'#60a5fa'},{name:'indigo',hex:'#818cf8'}
];
const DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const RECUR_UNITS={daily:'day(s)',weekly:'week(s)',monthly:'month(s)',yearly:'year(s)'};
const TZ_LIST=[
  'America/New_York','America/Chicago','America/Denver','America/Los_Angeles','America/Anchorage',
  'America/Honolulu','America/Toronto','America/Vancouver','America/Sao_Paulo','America/Argentina/Buenos_Aires',
  'Europe/London','Europe/Paris','Europe/Berlin','Europe/Rome','Europe/Madrid','Europe/Amsterdam',
  'Europe/Moscow','Africa/Cairo','Africa/Johannesburg','Asia/Dubai','Asia/Kolkata','Asia/Dhaka',
  'Asia/Bangkok','Asia/Singapore','Asia/Tokyo','Asia/Shanghai','Asia/Seoul','Australia/Sydney',
  'Australia/Melbourne','Pacific/Auckland','Pacific/Honolulu'
];

let view='month', today=new Date();
let cursor=new Date(today.getFullYear(),today.getMonth(),1);
let miniCursor=new Date(today.getFullYear(),today.getMonth(),1);
let events=[], labels=[], calendars=[], habits=[];
let editingId=null, popupEventId=null, popupEventDate=null;
let delTargetId=null, delTargetDate=null, copySourceId=null;
let editingLabelId=null, editingCalId=null, editingHabitId=null;
let selectedLabelColor=COLORS[1].hex, selectedCalColor=COLORS[0].hex, selectedHabitColor=COLORS[2].hex;
let sidebarVisible=true, miniCalVisible=true, upcomingVisible=true;
let labelsVisible=true, calendarsVisible=true, habitsVisible=true;
let currentTheme='dark', currentTz='', notifPermission='default';
let importedEventsBuffer=[], importMode='merge', importType='json';
let reminderTimers={};
// Drag state
let dragEventId=null, dragStartDate=null, dragCurrentDate=null;
let isDragging=false, dragGhostEl=null;
// Touch state
let touchStartX=0, touchStartY=0, touchStartTime=0;
let longPressTimer=null, touchDate=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadAll(){
  try{ events=JSON.parse(localStorage.getItem('calioEvents')||'[]'); }catch{ events=[]; }
  try{ labels=JSON.parse(localStorage.getItem('calioLabels')||'[]'); }catch{ labels=[]; }
  try{ calendars=JSON.parse(localStorage.getItem('calioCalendars')||'[]'); }catch{ calendars=[]; }
  try{ habits=JSON.parse(localStorage.getItem('calioHabits')||'[]'); }catch{ habits=[]; }
  // Ensure default "Personal" calendar exists
  if(!calendars.length) calendars=[{id:'default',name:'Personal',color:COLORS[0].hex,visible:true}];
  loadPrefs();
}
function saveEvents(){ localStorage.setItem('calioEvents',JSON.stringify(events)); }
function saveLabels(){ localStorage.setItem('calioLabels',JSON.stringify(labels)); }
function saveCalendars(){ localStorage.setItem('calioCalendars',JSON.stringify(calendars)); }
function saveHabits(){ localStorage.setItem('calioHabits',JSON.stringify(habits)); }
function loadPrefs(){
  const p=JSON.parse(localStorage.getItem('calioPrefs')||'{}');
  sidebarVisible=p.sidebarVisible!==false;
  miniCalVisible=p.miniCalVisible!==false;
  upcomingVisible=p.upcomingVisible!==false;
  labelsVisible=p.labelsVisible!==false;
  calendarsVisible=p.calendarsVisible!==false;
  habitsVisible=p.habitsVisible!==false;
  currentTheme=p.theme||'dark';
  currentTz=p.tz||'';
  applyPrefs();
  applyTheme();
  populateTzSelect();
}
function savePrefs(){
  localStorage.setItem('calioPrefs',JSON.stringify({
    sidebarVisible,miniCalVisible,upcomingVisible,labelsVisible,
    calendarsVisible,habitsVisible,theme:currentTheme,tz:currentTz
  }));
}
function applyPrefs(){
  document.getElementById('sidebar').classList.toggle('collapsed',!sidebarVisible);
  document.getElementById('sidebar-toggle-btn').classList.toggle('active',sidebarVisible);
  const show=(id,vis)=>{ document.getElementById(id+'').style.display=vis?'':'none'; };
  show('mini-cal-section',miniCalVisible); show('mini-show-row',!miniCalVisible);
  show('upcoming-section',upcomingVisible); show('upcoming-show-row',!upcomingVisible);
  show('labels-section',labelsVisible); show('labels-show-row',!labelsVisible);
  show('calendars-section',calendarsVisible); show('calendars-show-row',!calendarsVisible);
  show('habits-section',habitsVisible); show('habits-show-row',!habitsVisible);
}
function applyTheme(){
  document.documentElement.setAttribute('data-theme',currentTheme);
  const tog=document.getElementById('theme-toggle');
  if(tog) tog.checked=(currentTheme==='light');
}

function uuid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATE UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmtDate(d){ return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }
function parseDate(s){ if(!s) return null; const[y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function isSameDay(a,b){ return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate(); }
function addDays(d,n){ const r=new Date(d); r.setDate(r.getDate()+n); return r; }
function getWeekStart(d){ return new Date(d.getFullYear(),d.getMonth(),d.getDate()-d.getDay()); }
// Convert a local date to display date in selected tz
function toDisplayDate(dateStr,timeStr){
  if(!currentTz||!timeStr) return {date:dateStr,time:timeStr};
  try{
    const dt=new Date(dateStr+'T'+timeStr+':00');
    const parts=new Intl.DateTimeFormat('en-CA',{timeZone:currentTz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false}).formatToParts(dt);
    const get=t=>parts.find(p=>p.type===t)?.value||'';
    return {date:`${get('year')}-${get('month')}-${get('day')}`,time:`${get('hour')}:${get('minute')}`};
  }catch{return {date:dateStr,time:timeStr};}
}
function formatTzTime(timeStr){
  if(!timeStr) return '';
  if(!currentTz) return timeStr;
  try{
    const dt=new Date('2000-01-01T'+timeStr+':00');
    return dt.toLocaleTimeString('en-US',{timeZone:currentTz,hour:'2-digit',minute:'2-digit',hour12:true});
  }catch{return timeStr;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECURRENCE ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function recurSummary(ev){
  const r=ev.recurrence;
  if(!r||r.type==='none') return null;
  const unit={daily:'day',weekly:'week',monthly:'month',yearly:'year'}[r.type];
  let s=(r.interval&&r.interval>1)?`Every ${r.interval} ${unit}s`:`${r.type.charAt(0).toUpperCase()+r.type.slice(1)}`;
  if(r.endType==='on'&&r.endDate) s+=` until ${r.endDate}`;
  else if(r.endType==='after') s+=` ¬∑ ${r.count}x`;
  return s;
}
function occursOnDate(ev,date){
  const start=parseDate(ev.date);
  if(!start) return false;
  const dStr=fmtDate(date);
  // Multi-day spanning check (no recurrence needed)
  if(ev.endDate&&ev.endDate>ev.date){
    const end=parseDate(ev.endDate);
    if(date>=start&&date<=end) return true;
  }
  const r=ev.recurrence;
  if(!r||r.type==='none'){
    return isSameDay(start,date);
  }
  if(date<start) return false;
  const exc=ev.exceptions||[];
  if(exc.includes(dStr)) return false;
  // Check end conditions
  if(r.endType==='on'&&r.endDate&&dStr>r.endDate) return false;
  const diffMs=date-start;
  const diffDays=Math.round(diffMs/(1000*60*60*24));
  const interval=r.interval||1;
  if(r.type==='daily') return diffDays%interval===0;
  if(r.type==='weekly') return diffDays%7===0&&(diffDays/7)%interval===0;
  if(r.type==='monthly') return date.getDate()===start.getDate()&&(date.getFullYear()*12+date.getMonth()-(start.getFullYear()*12+start.getMonth()))%interval===0;
  if(r.type==='yearly') return date.getDate()===start.getDate()&&date.getMonth()===start.getMonth()&&(date.getFullYear()-start.getFullYear())%interval===0;
  return false;
}
function eventsForDate(date){
  const dStr=fmtDate(date);
  return events.filter(ev=>{
    const cal=calendars.find(c=>c.id===(ev.calendarId||'default'));
    if(cal&&cal.visible===false) return false;
    const lbl=ev.labelId?labels.find(l=>l.id===ev.labelId):null;
    if(lbl&&lbl.visible===false) return false;
    return occursOnDate(ev,date);
  });
}
function isMultiDay(ev){
  return ev.endDate&&ev.endDate>ev.date;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEWS & NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setView(v){
  view=v;
  ['month','week','day','agenda','year'].forEach(x=>{
    const b=document.getElementById('btn-'+x);
    if(b) b.classList.toggle('active',x===v);
  });
  if(v==='day') cursor=new Date(today.getFullYear(),today.getMonth(),today.getDate());
  render();
}
function navigate(dir){
  if(view==='month'||view==='year') cursor=new Date(cursor.getFullYear(),cursor.getMonth()+dir*(view==='year'?12:1),1);
  else if(view==='week') cursor=new Date(cursor.getFullYear(),cursor.getMonth(),cursor.getDate()+dir*7);
  else if(view==='agenda') cursor=new Date(cursor.getFullYear(),cursor.getMonth(),cursor.getDate()+dir*30);
  else cursor=new Date(cursor.getFullYear(),cursor.getMonth(),cursor.getDate()+dir);
  render();
}
function goToday(){
  today=new Date();
  cursor=view==='month'||view==='year'?new Date(today.getFullYear(),today.getMonth(),1):new Date(today);
  render();
}
function miniNav(dir){ miniCursor=new Date(miniCursor.getFullYear(),miniCursor.getMonth()+dir,1); renderMini(); }
function toggleSidebar(){ sidebarVisible=!sidebarVisible; applyPrefs(); savePrefs(); }
function toggleMiniCal(){ miniCalVisible=!miniCalVisible; applyPrefs(); savePrefs(); }
function toggleUpcoming(){ upcomingVisible=!upcomingVisible; applyPrefs(); savePrefs(); }
function toggleLabels(){ labelsVisible=!labelsVisible; applyPrefs(); savePrefs(); }
function toggleCalendars(){ calendarsVisible=!calendarsVisible; applyPrefs(); savePrefs(); }
function toggleHabits(){ habitsVisible=!habitsVisible; applyPrefs(); savePrefs(); }

function render(){
  today=new Date();
  updateTitle();
  renderCalendar();
  renderMini();
  renderSidebar();
  scheduleAllReminders();
}
function updateTitle(){
  const t=document.getElementById('main-title');
  if(view==='month') t.textContent=MONTHS[cursor.getMonth()]+' '+cursor.getFullYear();
  else if(view==='year') t.textContent=cursor.getFullYear();
  else if(view==='agenda') t.textContent='Agenda ¬∑ '+MONTHS[cursor.getMonth()]+' '+cursor.getFullYear();
  else if(view==='week'){
    const ws=getWeekStart(cursor),we=addDays(ws,6);
    t.textContent=MONTHS[ws.getMonth()].slice(0,3)+' '+ws.getDate()+' ‚Äì '+(ws.getMonth()!==we.getMonth()?MONTHS[we.getMonth()].slice(0,3)+' ':'')+we.getDate()+', '+we.getFullYear();
  } else t.textContent=DAYS[cursor.getDay()]+', '+MONTHS[cursor.getMonth()]+' '+cursor.getDate()+', '+cursor.getFullYear();
}
function renderCalendar(){
  const area=document.getElementById('calendar-area'); area.innerHTML='';
  if(view==='month') renderMonth(area);
  else if(view==='week') renderWeek(area);
  else if(view==='day') renderDay(area);
  else if(view==='agenda') renderAgenda(area);
  else renderYear(area);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MONTH VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMonth(area){
  const mv=document.createElement('div'); mv.className='month-view';
  const dh=document.createElement('div'); dh.className='day-headers';
  DAYS.forEach(d=>{ const el=document.createElement('div'); el.className='day-header'; el.textContent=d; dh.appendChild(el); });
  mv.appendChild(dh);
  const grid=document.createElement('div'); grid.className='month-grid';
  const first=new Date(cursor.getFullYear(),cursor.getMonth(),1);
  const sd=first.getDay();
  const dim=new Date(cursor.getFullYear(),cursor.getMonth()+1,0).getDate();
  // Build 6-week grid
  for(let i=0;i<42;i++){
    const date=new Date(cursor.getFullYear(),cursor.getMonth(),1-sd+i);
    const cell=buildMonthCell(date, date.getMonth()!==cursor.getMonth());
    grid.appendChild(cell);
  }
  mv.appendChild(grid);
  area.appendChild(mv);
}
function buildMonthCell(date,otherMonth){
  const dStr=fmtDate(date);
  const cell=document.createElement('div');
  cell.className='day-cell'+(otherMonth?' other-month':'')+(isSameDay(date,today)?' today':'');
  cell.dataset.date=dStr;
  // Day number
  const dn=document.createElement('div'); dn.className='day-num';
  const dni=document.createElement('div'); dni.className='day-num-inner'; dni.textContent=date.getDate();
  dn.appendChild(dni); cell.appendChild(dn);
  // Events
  const dayEvs=eventsForDate(date);
  // Handle multi-day events spanning this cell
  const maxShow=3;
  let shown=0;
  dayEvs.forEach(ev=>{
    if(shown>=maxShow){ return; }
    const pill=makePill(ev,date); cell.appendChild(pill); shown++;
  });
  if(dayEvs.length>maxShow){
    const more=document.createElement('div'); more.className='more-events';
    more.textContent=`+${dayEvs.length-maxShow} more`;
    more.onclick=e=>{e.stopPropagation();openModal(dStr);};
    cell.appendChild(more);
  }
  // Click to create
  cell.onclick=()=>openModal(dStr);
  // Drag & drop
  cell.addEventListener('dragover',e=>{ e.preventDefault(); cell.classList.add('drag-over'); });
  cell.addEventListener('dragleave',()=>cell.classList.remove('drag-over'));
  cell.addEventListener('drop',e=>{ e.preventDefault(); cell.classList.remove('drag-over'); handleDrop(dStr); });
  // Touch long-press
  cell.addEventListener('touchstart',e=>handleTouchStart(e,dStr),{passive:true});
  cell.addEventListener('touchend',handleTouchEnd,{passive:true});
  cell.addEventListener('touchmove',handleTouchMove,{passive:true});
  return cell;
}
function makePill(ev,date){
  const cal=calendars.find(c=>c.id===(ev.calendarId||'default'));
  const color=ev.color||(cal?cal.color:COLORS[0].hex);
  const lbl=ev.labelId?labels.find(l=>l.id===ev.labelId):null;
  const pill=document.createElement('div');
  pill.className='event-pill';
  pill.style.borderLeftColor=color;
  pill.style.background=color+'22';
  // Multi-day classes
  if(isMultiDay(ev)){
    const start=parseDate(ev.date), end=parseDate(ev.endDate);
    if(isSameDay(date,start)) pill.classList.add('multiday-start');
    else if(isSameDay(date,end)) pill.classList.add('multiday-end');
    else pill.classList.add('multiday-mid');
    pill.style.background=color+'33';
  }
  const dot=document.createElement('div'); dot.className='pill-dot'; dot.style.background=color;
  const txt=document.createElement('div'); txt.className='pill-text'; txt.textContent=ev.title;
  pill.appendChild(dot); pill.appendChild(txt);
  if(ev.recurrence&&ev.recurrence.type!=='none'){
    const rb=document.createElement('span'); rb.className='pill-recur'; rb.textContent='‚Üª'; pill.appendChild(rb);
  }
  if(lbl){ const lb=document.createElement('span'); lb.className='pill-label'; lb.textContent=lbl.name; pill.appendChild(lb); }
  pill.draggable=true;
  pill.onclick=e=>{ e.stopPropagation(); showPopup(ev.id,date,e); };
  pill.addEventListener('dragstart',e=>{ e.stopPropagation(); startDrag(ev.id,fmtDate(date),e); });
  pill.addEventListener('dragend',endDrag);
  return pill;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEEK VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderWeek(area){
  const ws=getWeekStart(cursor);
  const wv=document.createElement('div'); wv.className='week-view';
  // Header
  const hdr=document.createElement('div'); hdr.className='week-header';
  const gutter=document.createElement('div'); gutter.className=''; hdr.appendChild(gutter);
  for(let i=0;i<7;i++){
    const d=addDays(ws,i);
    const wdh=document.createElement('div'); wdh.className='week-day-header';
    const name=document.createElement('div'); name.className='wdh-name'; name.textContent=DAYS[d.getDay()];
    const num=document.createElement('div'); num.className='wdh-num'+(isSameDay(d,today)?' today':''); num.textContent=d.getDate();
    wdh.appendChild(name); wdh.appendChild(num); hdr.appendChild(wdh);
  }
  wv.appendChild(hdr);
  // All-day row
  const adr=buildAlldayRow('week',ws,7);
  wv.appendChild(adr);
  // Time grid
  const body=document.createElement('div'); body.className='week-body';
  // Time labels col
  const tcol=document.createElement('div'); tcol.className='time-col';
  for(let h=0;h<24;h++){
    const tl=document.createElement('div'); tl.className='time-label';
    tl.textContent=h===0?'':h<12?`${h} AM`:h===12?'12 PM':`${h-12} PM`;
    tcol.appendChild(tl);
  }
  body.appendChild(tcol);
  for(let i=0;i<7;i++){
    const d=addDays(ws,i);
    const col=buildWeekDayCol(d);
    body.appendChild(col);
  }
  wv.appendChild(body);
  area.appendChild(wv);
  // Scroll to 8am
  requestAnimationFrame(()=>{ body.scrollTop=8*60; });
}
function buildAlldayRow(type,startDate,count){
  const adr=document.createElement('div');
  adr.className='allday-row '+(type==='week'?'week-allday':'day-allday');
  const ag=document.createElement('div'); ag.className='allday-gutter'; ag.textContent='All-day'; adr.appendChild(ag);
  for(let i=0;i<count;i++){
    const d=addDays(startDate,i);
    const cell=document.createElement('div'); cell.className='allday-cell';
    eventsForDate(d).filter(ev=>ev.allDay||isMultiDay(ev)).forEach(ev=>{
      const pill=makeAlldayPill(ev,d);
      cell.appendChild(pill);
    });
    adr.appendChild(cell);
  }
  return adr;
}
function makeAlldayPill(ev,date){
  const cal=calendars.find(c=>c.id===(ev.calendarId||'default'));
  const color=ev.color||(cal?cal.color:COLORS[0].hex);
  const pill=document.createElement('div'); pill.className='allday-pill';
  pill.style.borderLeftColor=color; pill.style.background=color+'22';
  const dot=document.createElement('div'); dot.className='allday-pill-dot'; dot.style.background=color;
  const txt=document.createElement('div'); txt.className='allday-pill-text'; txt.textContent=ev.title;
  pill.appendChild(dot); pill.appendChild(txt);
  pill.onclick=e=>{e.stopPropagation();showPopup(ev.id,date,e);};
  return pill;
}
function buildWeekDayCol(date){
  const dStr=fmtDate(date);
  const col=document.createElement('div'); col.className='week-day-col';
  // Hour lines
  for(let h=0;h<24;h++){
    const hl=document.createElement('div'); hl.className='hour-line'; hl.style.top=(h*60)+'px'; col.appendChild(hl);
    // Click to create event at this hour
    hl.onclick=()=>{ const t=h.toString().padStart(2,'0')+':00'; openModal(dStr,t); };
  }
  // Now line
  if(isSameDay(date,today)){
    const nl=document.createElement('div'); nl.className='now-line';
    const mins=today.getHours()*60+today.getMinutes();
    nl.style.top=mins+'px';
    const nd=document.createElement('div'); nd.className='now-dot'; nl.appendChild(nd);
    col.appendChild(nl);
  }
  // Timed events
  eventsForDate(date).filter(ev=>!ev.allDay&&!isMultiDay(ev)).forEach(ev=>{
    const el=buildWeekEvent(ev,date); if(el) col.appendChild(el);
  });
  // Drop target
  col.addEventListener('dragover',e=>{ e.preventDefault(); col.classList.add('drag-over'); });
  col.addEventListener('dragleave',()=>col.classList.remove('drag-over'));
  col.addEventListener('drop',e=>{ e.preventDefault(); col.classList.remove('drag-over'); handleDrop(dStr); });
  return col;
}
function buildWeekEvent(ev,date){
  if(!ev.start||!ev.end) return null;
  const [sh,sm]=ev.start.split(':').map(Number);
  const [eh,em]=ev.end.split(':').map(Number);
  const top=sh*60+sm, height=Math.max(20,eh*60+em-top);
  const cal=calendars.find(c=>c.id===(ev.calendarId||'default'));
  const color=ev.color||(cal?cal.color:COLORS[0].hex);
  const el=document.createElement('div'); el.className='week-event';
  el.style.top=top+'px'; el.style.height=height+'px';
  el.style.borderLeftColor=color; el.style.background=color+'28'; el.style.color='var(--text)';
  const title=document.createElement('div'); title.className='we-title'; title.textContent=ev.title;
  const time=document.createElement('div'); time.className='we-time'; time.textContent=`${formatTzTime(ev.start)||ev.start}‚Äì${formatTzTime(ev.end)||ev.end}`;
  el.appendChild(title); el.appendChild(time);
  el.draggable=true;
  el.onclick=e=>{e.stopPropagation();showPopup(ev.id,date,e);};
  el.addEventListener('dragstart',e=>{e.stopPropagation();startDrag(ev.id,fmtDate(date),e);});
  el.addEventListener('dragend',endDrag);
  return el;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAY VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDay(area){
  const dv=document.createElement('div'); dv.className='day-view';
  const dhb=document.createElement('div'); dhb.className='day-header-bar';
  const dn=document.createElement('div'); dn.className='dhb-name'; dn.textContent=DAYS[cursor.getDay()];
  const dd=document.createElement('div'); dd.className='dhb-num'; dd.textContent=cursor.getDate();
  dhb.appendChild(dn); dhb.appendChild(dd);
  dv.appendChild(dhb);
  const dayEvs=eventsForDate(cursor);
  const alldayEvs=dayEvs.filter(ev=>ev.allDay||isMultiDay(ev));
  if(alldayEvs.length){
    const adr=buildAlldayRow('day',cursor,1); dv.appendChild(adr);
  }
  const body=document.createElement('div'); body.className='day-body';
  const tcol=document.createElement('div'); tcol.className='time-col';
  for(let h=0;h<24;h++){
    const tl=document.createElement('div'); tl.className='time-label';
    tl.textContent=h===0?'':h<12?`${h} AM`:h===12?'12 PM':`${h-12} PM`;
    tcol.appendChild(tl);
  }
  body.appendChild(tcol);
  const dcol=buildWeekDayCol(cursor); dcol.style.minHeight='1440px';
  body.appendChild(dcol);
  dv.appendChild(body);
  area.appendChild(dv);
  requestAnimationFrame(()=>{ body.scrollTop=8*60; });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AGENDA VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAgenda(area){
  const av=document.createElement('div'); av.className='agenda-view';
  const startDate=new Date(cursor.getFullYear(),cursor.getMonth(),1);
  const endDate=new Date(cursor.getFullYear(),cursor.getMonth()+2,0); // 2 months
  let hasAny=false;
  for(let d=new Date(startDate);d<=endDate;d=addDays(d,1)){
    const dayEvs=eventsForDate(d);
    // Also add habits for today
    const todayHabits=habitsForDate(d);
    if(!dayEvs.length&&!todayHabits.length) continue;
    hasAny=true;
    const group=document.createElement('div'); group.className='agenda-day-group';
    const dhdr=document.createElement('div'); dhdr.className='agenda-day-header';
    const dname=document.createElement('div'); dname.className='agenda-day-name'; dname.textContent=DAYS[d.getDay()];
    const ddate=document.createElement('div'); ddate.className='agenda-day-date'+(isSameDay(d,today)?' today':''); ddate.textContent=d.getDate();
    const dmonth=document.createElement('div'); dmonth.className='agenda-day-month'; dmonth.textContent=MONTHS[d.getMonth()].slice(0,3)+' '+d.getFullYear();
    dhdr.appendChild(dname); dhdr.appendChild(ddate); dhdr.appendChild(dmonth);
    group.appendChild(dhdr);
    // Events
    dayEvs.sort((a,b)=>(a.allDay?'00:00':a.start||'00:00').localeCompare(b.allDay?'00:00':b.start||'00:00'));
    dayEvs.forEach(ev=>{
      const row=buildAgendaEvent(ev,d); group.appendChild(row);
    });
    // Habits
    todayHabits.forEach(h=>{
      const row=buildAgendaHabit(h,d); group.appendChild(row);
    });
    av.appendChild(group);
  }
  if(!hasAny){
    const empty=document.createElement('div'); empty.className='agenda-empty';
    empty.textContent='No events this period. Click + New Event to get started.';
    av.appendChild(empty);
  }
  area.appendChild(av);
  // Scroll to today's group after render
  requestAnimationFrame(()=>{
    const todayGroup=av.querySelector('.agenda-day-date.today');
    if(todayGroup) todayGroup.closest('.agenda-day-group').scrollIntoView({behavior:'smooth',block:'start'});
    else av.scrollTop=0;
  });
}
function buildAgendaEvent(ev,date){
  const cal=calendars.find(c=>c.id===(ev.calendarId||'default'));
  const color=ev.color||(cal?cal.color:COLORS[0].hex);
  const row=document.createElement('div'); row.className='agenda-event'; row.style.borderLeftColor=color;
  const tspan=document.createElement('div'); tspan.className='agenda-event-time';
  tspan.textContent=ev.allDay?'All day':`${formatTzTime(ev.start)||ev.start||''} ‚Äì ${formatTzTime(ev.end)||ev.end||''}`;
  const body=document.createElement('div'); body.className='agenda-event-body';
  const title=document.createElement('div'); title.className='agenda-event-title'; title.textContent=ev.title;
  const meta=document.createElement('div'); meta.className='agenda-event-meta';
  if(cal){ const cs=document.createElement('span'); cs.textContent='üìÖ '+cal.name; cs.style.color=color; meta.appendChild(cs); }
  if(ev.recurrence&&ev.recurrence.type!=='none'){ const rs=document.createElement('span'); rs.textContent='‚Üª '+recurSummary(ev); meta.appendChild(rs); }
  body.appendChild(title); body.appendChild(meta);
  row.appendChild(tspan); row.appendChild(body);
  row.onclick=e=>showPopup(ev.id,date,e);
  return row;
}
function buildAgendaHabit(h,date){
  const done=isHabitDone(h,date);
  const row=document.createElement('div'); row.className='agenda-event'; row.style.borderLeftColor=h.color||COLORS[2].hex;
  row.style.opacity=done?'0.6':'1';
  const check=document.createElement('div'); check.className='agenda-habit-check'+(done?' done':'');
  check.style.borderColor=h.color||COLORS[2].hex;
  if(done){ check.style.background=h.color||COLORS[2].hex; check.textContent='‚úì'; }
  check.onclick=e=>{e.stopPropagation();toggleHabitDay(h.id,date);};
  const tspan=document.createElement('div'); tspan.className='agenda-event-time'; tspan.textContent='Habit';
  const body=document.createElement('div'); body.className='agenda-event-body';
  const title=document.createElement('div'); title.className='agenda-event-title'; title.textContent=h.name;
  const streak=document.createElement('div'); streak.className='agenda-event-meta';
  const streakN=getHabitStreak(h);
  if(streakN>0){ streak.textContent=`üî• ${streakN} day streak`; streak.style.color=h.color||COLORS[2].hex; }
  body.appendChild(title); if(streakN>0) body.appendChild(streak);
  row.appendChild(check); row.appendChild(tspan); row.appendChild(body);
  return row;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// YEAR VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderYear(area){
  const year=cursor.getFullYear();
  const yv=document.createElement('div'); yv.className='year-view';
  const grid=document.createElement('div'); grid.className='year-grid';
  for(let m=0;m<12;m++){
    const mc=buildYearMonth(year,m);
    grid.appendChild(mc);
  }
  yv.appendChild(grid);
  area.appendChild(yv);
}
function buildYearMonth(year,month){
  const mc=document.createElement('div'); mc.className='year-month';
  const name=document.createElement('div'); name.className='year-month-name'; name.textContent=MONTHS[month].slice(0,3);
  mc.appendChild(name);
  const mgrid=document.createElement('div'); mgrid.className='year-month-grid';
  DAYS.forEach(d=>{ const dl=document.createElement('div'); dl.className='year-day-label'; dl.textContent=d[0]; mgrid.appendChild(dl); });
  const first=new Date(year,month,1);
  const sd=first.getDay();
  const dim=new Date(year,month+1,0).getDate();
  for(let i=0;i<sd;i++){
    const empty=document.createElement('div'); empty.className='year-day other-m'; mgrid.appendChild(empty);
  }
  for(let d=1;d<=dim;d++){
    const date=new Date(year,month,d);
    const evCount=eventsForDate(date).length;
    const yd=document.createElement('div');
    yd.className='year-day'+(isSameDay(date,today)?' today':'')+(evCount===0?'':evCount===1?' has-1':evCount===2?' has-2':evCount===3?' has-3':evCount===4?' has-4':' has-many');
    yd.textContent=d;
    yd.title=evCount?`${evCount} event${evCount>1?'s':''}`:null;
    yd.onclick=()=>{ cursor=new Date(year,month,d); setView('day'); };
    mgrid.appendChild(yd);
  }
  mc.appendChild(mgrid);
  return mc;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MINI CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMini(){
  if(!miniCalVisible) return;
  document.getElementById('mini-title').textContent=MONTHS[miniCursor.getMonth()].slice(0,3)+' '+miniCursor.getFullYear();
  const grid=document.getElementById('mini-grid'); grid.innerHTML='';
  DAYS.forEach(d=>{ const el=document.createElement('div'); el.className='mini-day-label'; el.textContent=d[0]; grid.appendChild(el); });
  const first=new Date(miniCursor.getFullYear(),miniCursor.getMonth(),1);
  const sd=first.getDay();
  const dim=new Date(miniCursor.getFullYear(),miniCursor.getMonth()+1,0).getDate();
  for(let i=0;i<sd;i++) addMiniDay(grid,new Date(miniCursor.getFullYear(),miniCursor.getMonth(),1-sd+i),true);
  for(let d=1;d<=dim;d++) addMiniDay(grid,new Date(miniCursor.getFullYear(),miniCursor.getMonth(),d),false);
  for(let i=1;i<=42-sd-dim;i++) addMiniDay(grid,new Date(miniCursor.getFullYear(),miniCursor.getMonth()+1,i),true);
}
function addMiniDay(grid,date,other){
  const el=document.createElement('div');
  const evCount=eventsForDate(date).length;
  el.className='mini-day'+(other?' other-month':'')+(isSameDay(date,today)?' today':'')+(evCount>0?' has-events':'');
  el.textContent=date.getDate();
  el.onclick=()=>{
    if(view==='month') cursor=new Date(date.getFullYear(),date.getMonth(),1);
    else cursor=new Date(date);
    render();
    openModal(fmtDate(date));
  };
  grid.appendChild(el);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSidebar(){
  renderCalendarsList();
  renderLabelsList();
  renderHabitsList();
  renderUpcoming();
}
function renderCalendarsList(){
  const list=document.getElementById('calendars-list'); if(!list) return; list.innerHTML='';
  calendars.forEach(cal=>{
    const cnt=events.filter(e=>e.calendarId===(cal.id||'default')||(!e.calendarId&&cal.id==='default')).length;
    const row=document.createElement('div'); row.className='cal-row';
    const chk=document.createElement('div'); chk.className='cal-check';
    chk.style.borderColor=cal.color;
    if(cal.visible!==false){ chk.style.background=cal.color; chk.textContent='‚úì'; }
    chk.onclick=e=>{e.stopPropagation(); cal.visible=cal.visible===false?true:false; saveCalendars(); render(); };
    const nm=document.createElement('div'); nm.className='cal-name'; nm.textContent=cal.name;
    const ct=document.createElement('div'); ct.className='cal-count'; ct.textContent=cnt||'';
    const eb=document.createElement('button'); eb.className='cal-edit-btn'; eb.textContent='‚Ä¢‚Ä¢‚Ä¢';
    eb.onclick=e=>{e.stopPropagation();openCalModal(cal.id);};
    row.appendChild(chk); row.appendChild(nm); row.appendChild(ct); row.appendChild(eb);
    list.appendChild(row);
  });
  const addBtn=document.createElement('button'); addBtn.className='cal-add-btn';
  addBtn.innerHTML='<span>+</span> New calendar'; addBtn.onclick=()=>openCalModal(null);
  list.appendChild(addBtn);
}
function renderLabelsList(){
  const list=document.getElementById('labels-list'); if(!list) return; list.innerHTML='';
  if(!labels.length){
    const e=document.createElement('div'); e.style.cssText='font-size:0.72rem;color:var(--text3);padding:3px 5px;'; e.textContent='No labels yet.'; list.appendChild(e);
  }
  labels.forEach(lbl=>{
    const cnt=events.filter(e=>e.labelId===lbl.id).length;
    const row=document.createElement('div'); row.className='label-row'+(lbl.visible===false?' hidden':'');
    const vis=document.createElement('button'); vis.className='label-vis-btn';
    vis.innerHTML=lbl.visible===false
      ?'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M17.94 17.94A10 10 0 0 1 12 20c-7 0-11-8-11-8a18 18 0 0 1 5.06-5.94M9.9 4.24A9 9 0 0 1 12 4c7 0 11 8 11 8a18 18 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
      :'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
    vis.onclick=e=>{e.stopPropagation();lbl.visible=lbl.visible===false?true:false;saveLabels();render();};
    const dot=document.createElement('div'); dot.className='label-dot'; dot.style.background=lbl.color;
    const nm=document.createElement('div'); nm.className='label-name'; nm.textContent=lbl.name;
    const ct=document.createElement('div'); ct.className='label-count'; ct.textContent=cnt||'';
    const eb=document.createElement('button'); eb.className='label-edit-btn'; eb.textContent='‚Ä¢‚Ä¢‚Ä¢';
    eb.onclick=e=>{e.stopPropagation();openLabelModal(lbl.id);};
    row.appendChild(vis); row.appendChild(dot); row.appendChild(nm); row.appendChild(ct); row.appendChild(eb);
    list.appendChild(row);
  });
  const addBtn=document.createElement('button'); addBtn.className='label-add-btn';
  addBtn.innerHTML='<span>+</span> New label'; addBtn.onclick=()=>openLabelModal(null);
  list.appendChild(addBtn);
}
function renderHabitsList(){
  const list=document.getElementById('habits-list'); if(!list) return; list.innerHTML='';
  if(!habits.length){
    const e=document.createElement('div'); e.style.cssText='font-size:0.72rem;color:var(--text3);padding:3px 5px;'; e.textContent='No habits yet.'; list.appendChild(e);
  }
  habits.forEach(h=>{
    const done=isHabitDone(h,today);
    const streak=getHabitStreak(h);
    const row=document.createElement('div'); row.className='habit-row';
    const dot=document.createElement('div'); dot.className='habit-dot'; dot.style.background=h.color||COLORS[2].hex;
    const chk=document.createElement('div'); chk.className='habit-check-today'+(done?' done':'');
    chk.style.borderColor=h.color||COLORS[2].hex;
    if(done){ chk.style.background=h.color||COLORS[2].hex; chk.textContent='‚úì'; }
    chk.onclick=e=>{e.stopPropagation();toggleHabitDay(h.id,today);};
    const nm=document.createElement('div'); nm.className='habit-name'; nm.textContent=h.name;
    const st=document.createElement('div'); st.className='habit-streak'; if(streak>0){ st.textContent='üî•'+streak; }
    const eb=document.createElement('button'); eb.className='habit-edit-btn'; eb.textContent='‚Ä¢‚Ä¢‚Ä¢';
    eb.onclick=e=>{e.stopPropagation();openHabitModal(h.id);};
    row.appendChild(chk); row.appendChild(dot); row.appendChild(nm); row.appendChild(st); row.appendChild(eb);
    list.appendChild(row);
  });
}
function renderUpcoming(){
  const list=document.getElementById('upcoming-list'); if(!list) return; list.innerHTML='';
  const upcoming=[];
  for(let i=0;i<=30;i++){
    const d=addDays(today,i);
    eventsForDate(d).forEach(ev=>upcoming.push({ev,date:d}));
  }
  upcoming.sort((a,b)=>{
    if(a.date<b.date) return -1; if(a.date>b.date) return 1;
    return (a.ev.start||'').localeCompare(b.ev.start||'');
  });
  if(!upcoming.length){ const e=document.createElement('div'); e.className='no-events'; e.textContent='No upcoming events'; list.appendChild(e); return; }
  upcoming.slice(0,8).forEach(({ev,date})=>{
    const cal=calendars.find(c=>c.id===(ev.calendarId||'default'));
    const color=ev.color||(cal?cal.color:COLORS[0].hex);
    const item=document.createElement('div'); item.className='upcoming-event'; item.style.borderLeftColor=color;
    const t=document.createElement('div'); t.className='ev-title'; t.textContent=ev.title;
    if(ev.recurrence&&ev.recurrence.type!=='none'){ const rb=document.createElement('span'); rb.className='recur-badge'; rb.textContent='‚Üª'; t.appendChild(rb); }
    const d=document.createElement('div'); d.className='ev-date';
    const isToday=isSameDay(date,today), isTomorrow=isSameDay(date,addDays(today,1));
    d.textContent=(isToday?'Today':isTomorrow?'Tomorrow':DAYS[date.getDay()]+', '+MONTHS[date.getMonth()].slice(0,3)+' '+date.getDate())+(ev.allDay?'':(ev.start?' ¬∑ '+(formatTzTime(ev.start)||ev.start):''));
    item.appendChild(t); item.appendChild(d);
    item.onclick=e=>showPopup(ev.id,date,e);
    list.appendChild(item);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HABITS ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function habitsForDate(date){
  return habits.filter(h=>{
    if(h.freq==='daily') return true;
    if(h.freq==='weekdays') return date.getDay()>=1&&date.getDay()<=5;
    if(h.freq==='weekly') return date.getDay()===1;
    return true;
  });
}
function isHabitDone(h,date){
  const dStr=fmtDate(date);
  return (h.completions||[]).includes(dStr);
}
function toggleHabitDay(id,date){
  const h=habits.find(x=>x.id===id); if(!h) return;
  const dStr=fmtDate(date);
  if(!h.completions) h.completions=[];
  if(h.completions.includes(dStr)) h.completions=h.completions.filter(d=>d!==dStr);
  else h.completions.push(dStr);
  saveHabits(); renderSidebar(); if(view==='agenda') renderCalendar();
  if(fbDb&&currentRoom) fbSaveHabit(h);
}
function getHabitStreak(h){
  if(!h.completions||!h.completions.length) return 0;
  let streak=0, d=new Date(today);
  while(true){
    const dStr=fmtDate(d);
    if(h.completions.includes(dStr)) streak++;
    else if(!isSameDay(d,today)) break;
    d=addDays(d,-1);
    if(streak>365) break;
  }
  return streak;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(dateStr,timeStr){
  editingId=null;
  document.getElementById('modal-title').textContent='New Event';
  document.getElementById('ev-title').value='';
  document.getElementById('ev-date').value=dateStr||fmtDate(today);
  document.getElementById('ev-end-date').value='';
  document.getElementById('ev-desc').value='';
  document.getElementById('ev-allday').value='yes';
  document.getElementById('ev-start').value=timeStr||'09:00';
  document.getElementById('ev-end').value=timeStr?`${String(parseInt(timeStr)+1).padStart(2,'0')}:00`:'10:00';
  document.getElementById('ev-recur-type').value='none';
  document.getElementById('ev-recur-interval').value=1;
  document.getElementById('ev-recur-end-type').value='never';
  document.getElementById('ev-recur-end-date').value='';
  document.getElementById('ev-recur-count').value=10;
  document.getElementById('ev-reminder').value='';
  toggleTimeFields(); onRecurTypeChange(); onRecurEndChange();
  populateLabelDropdown('');
  populateCalendarDropdown('');
  document.getElementById('modal-actions').innerHTML=`<button class="btn-cancel" onclick="closeModal()">Cancel</button><button class="btn-save" onclick="saveEvent()">Save Event</button>`;
  document.getElementById('modal-overlay').classList.add('open');
  setTimeout(()=>document.getElementById('ev-title').focus(),80);
}
function openEditModal(id){
  const ev=events.find(e=>e.id===id); if(!ev) return;
  editingId=id;
  document.getElementById('modal-title').textContent='Edit Event';
  document.getElementById('ev-title').value=ev.title;
  document.getElementById('ev-date').value=ev.date;
  document.getElementById('ev-end-date').value=ev.endDate||'';
  document.getElementById('ev-desc').value=ev.description||'';
  document.getElementById('ev-allday').value=ev.allDay?'yes':'no';
  document.getElementById('ev-start').value=ev.start||'09:00';
  document.getElementById('ev-end').value=ev.end||'10:00';
  const r=ev.recurrence||{type:'none'};
  document.getElementById('ev-recur-type').value=r.type||'none';
  document.getElementById('ev-recur-interval').value=r.interval||1;
  document.getElementById('ev-recur-end-type').value=r.endType||'never';
  document.getElementById('ev-recur-end-date').value=r.endDate||'';
  document.getElementById('ev-recur-count').value=r.count||10;
  document.getElementById('ev-reminder').value=ev.reminder!=null?String(ev.reminder):'';
  toggleTimeFields(); onRecurTypeChange(); onRecurEndChange();
  populateLabelDropdown(ev.labelId||'');
  populateCalendarDropdown(ev.calendarId||'default');
  document.getElementById('modal-actions').innerHTML=`<button class="btn-delete" onclick="handleDeleteEdit('${id}')">Delete</button><button class="btn-cancel" onclick="closeModal()">Cancel</button><button class="btn-save" onclick="saveEvent()">Save Changes</button>`;
  document.getElementById('modal-overlay').classList.add('open');
}
function closeModal(){ document.getElementById('modal-overlay').classList.remove('open'); }
function handleOverlayClick(e){ if(e.target===document.getElementById('modal-overlay')) closeModal(); }
function toggleTimeFields(){ document.getElementById('time-fields').style.display=document.getElementById('ev-allday').value==='yes'?'none':'block'; }
function onRecurTypeChange(){
  const t=document.getElementById('ev-recur-type').value;
  document.getElementById('recur-section').style.display=t==='none'?'none':'block';
  if(t!=='none') document.getElementById('recur-unit-label').textContent={daily:'day(s)',weekly:'week(s)',monthly:'month(s)',yearly:'year(s)'}[t];
}
function onRecurEndChange(){
  const et=document.getElementById('ev-recur-end-type').value;
  document.getElementById('recur-end-date-row').style.display=et==='on'?'block':'none';
  document.getElementById('recur-end-count-row').style.display=et==='after'?'block':'none';
}
function populateLabelDropdown(selectedId){
  const sel=document.getElementById('ev-label'); sel.innerHTML='<option value="">‚Äî No label ‚Äî</option>';
  labels.forEach(lbl=>{ const o=document.createElement('option'); o.value=lbl.id; o.textContent=lbl.name; if(lbl.id===selectedId) o.selected=true; sel.appendChild(o); });
  onLabelChange();
}
function populateCalendarDropdown(selectedId){
  const sel=document.getElementById('ev-calendar'); sel.innerHTML='';
  calendars.forEach(cal=>{ const o=document.createElement('option'); o.value=cal.id; o.textContent=cal.name; if(cal.id===(selectedId||'default')) o.selected=true; sel.appendChild(o); });
}
function onLabelChange(){
  const lid=document.getElementById('ev-label').value;
  const prev=document.getElementById('ev-label-preview');
  if(!prev) return;
  if(lid){ const lbl=labels.find(l=>l.id===lid); if(lbl){ prev.style.display='flex'; prev.style.background=lbl.color+'22'; prev.style.color=lbl.color; document.getElementById('ev-label-preview-dot').style.background=lbl.color; document.getElementById('ev-label-preview-text').textContent=lbl.name; return; } }
  prev.style.display='none';
}
function saveEvent(){
  const title=document.getElementById('ev-title').value.trim();
  if(!title){ document.getElementById('ev-title').style.borderColor='var(--red)'; setTimeout(()=>document.getElementById('ev-title').style.borderColor='',1500); return; }
  const allDay=document.getElementById('ev-allday').value==='yes';
  const rType=document.getElementById('ev-recur-type').value;
  const recurrence=rType==='none'?{type:'none'}:{type:rType,interval:Math.max(1,parseInt(document.getElementById('ev-recur-interval').value)||1),endType:document.getElementById('ev-recur-end-type').value,endDate:document.getElementById('ev-recur-end-date').value||null,count:Math.max(1,parseInt(document.getElementById('ev-recur-count').value)||10)};
  const reminderVal=document.getElementById('ev-reminder').value;
  const calId=document.getElementById('ev-calendar').value||'default';
  const cal=calendars.find(c=>c.id===calId);
  const lid=document.getElementById('ev-label').value;
  const lbl=lid?labels.find(l=>l.id===lid):null;
  const color=lbl?lbl.color:(cal?cal.color:COLORS[0].hex);
  const existing=editingId?events.find(e=>e.id===editingId):null;
  const startDate=document.getElementById('ev-date').value;
  const endDate=document.getElementById('ev-end-date').value;
  const ev={
    id:editingId||uuid(), title, date:startDate,
    endDate:endDate&&endDate>startDate?endDate:null,
    allDay, start:allDay?null:document.getElementById('ev-start').value,
    end:allDay?null:document.getElementById('ev-end').value,
    description:document.getElementById('ev-desc').value.trim(),
    color, recurrence, labelId:lid||null, calendarId:calId,
    reminder:reminderVal!==''?parseInt(reminderVal):null,
    exceptions:existing?existing.exceptions||[]:[],
    timezone:currentTz||null
  };
  if(editingId){ const idx=events.findIndex(e=>e.id===editingId); if(idx>=0) events[idx]=ev; }
  else events.push(ev);
  localStorage.setItem('calioEvents',JSON.stringify(events));
  _fbPushEvent(ev);
  closeModal(); render();
  scheduleReminder(ev);
}
function handleDeleteEdit(id){
  closeModal();
  const ev=events.find(e=>e.id===id);
  if(ev?.recurrence?.type!=='none') openDelDialog(id,parseDate(ev.date));
  else{ const _did=id; events=events.filter(e=>e.id!==_did); localStorage.setItem('calioEvents',JSON.stringify(events)); _fbDeleteEventDoc(_did); render(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELETE DIALOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDelDialog(id,date){
  delTargetId=id; delTargetDate=date;
  const ev=events.find(e=>e.id===id);
  document.getElementById('del-ev-name').textContent=ev?ev.title:'';
  document.querySelector('input[name="del-scope"][value="this"]').checked=true;
  document.getElementById('del-overlay').classList.add('open');
}
function closeDelDialog(){ document.getElementById('del-overlay').classList.remove('open'); delTargetId=null; delTargetDate=null; }
function confirmDelete(){
  if(!delTargetId) return;
  const ev=events.find(e=>e.id===delTargetId); if(!ev){ closeDelDialog(); return; }
  const scope=document.querySelector('input[name="del-scope"]:checked').value;
  if(scope==='all'){ events=events.filter(e=>e.id!==delTargetId); _fbDeleteEventDoc(delTargetId); }
  else if(scope==='this'&&delTargetDate){ if(!ev.exceptions) ev.exceptions=[]; ev.exceptions.push(fmtDate(delTargetDate)); _fbPushEvent(ev); }
  else if(scope==='future'&&delTargetDate){ if(!ev.recurrence) ev.recurrence={}; ev.recurrence.endType='on'; ev.recurrence.endDate=fmtDate(addDays(delTargetDate,-1)); _fbPushEvent(ev); }
  else { events=events.filter(e=>e.id!==delTargetId); _fbDeleteEventDoc(delTargetId); }
  localStorage.setItem('calioEvents',JSON.stringify(events));
  closeDelDialog(); closePopup(); render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COPY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCopyModal(id){ copySourceId=id; const ev=events.find(e=>e.id===id); document.getElementById('copy-ev-name').textContent=ev?ev.title:''; document.getElementById('copy-date').value=fmtDate(today); document.getElementById('copy-overlay').classList.add('open'); }
function closeCopyModal(){ document.getElementById('copy-overlay').classList.remove('open'); copySourceId=null; }
function confirmCopy(){
  if(!copySourceId) return;
  const ev=events.find(e=>e.id===copySourceId); if(!ev) return;
  const nd=document.getElementById('copy-date').value; if(!nd) return;
  const newEv={...ev,id:uuid(),date:nd,endDate:null,recurrence:{type:'none'},exceptions:[]};
  events.push(newEv);
  localStorage.setItem('calioEvents',JSON.stringify(events)); _fbPushEvent(newEv);
  closeCopyModal(); closePopup(); render();
  showToast(`Copied "${ev.title}" to ${nd}`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENT POPUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPopup(id,date,e){
  closePopup();
  const ev=events.find(x=>x.id===id); if(!ev) return;
  popupEventId=id; popupEventDate=date;
  const p=document.getElementById('event-popup');
  const cal=calendars.find(c=>c.id===(ev.calendarId||'default'));
  const color=ev.color||(cal?cal.color:COLORS[0].hex);
  document.getElementById('ep-color').style.background=color;
  document.getElementById('ep-title').textContent=ev.title;
  const dt=date instanceof Date?date:parseDate(ev.date);
  document.getElementById('ep-date-meta').textContent='üìÖ '+DAYS[dt.getDay()]+', '+MONTHS[dt.getMonth()]+' '+dt.getDate()+', '+dt.getFullYear();
  const dispStart=formatTzTime(ev.start)||ev.start;
  const dispEnd=formatTzTime(ev.end)||ev.end;
  document.getElementById('ep-time-meta').textContent=ev.allDay?'üóì All day':`üïê ${dispStart||''} ‚Äì ${dispEnd||''}`;
  const rs=recurSummary(ev);
  const badge=document.getElementById('ep-recur-badge');
  if(rs){badge.style.display='inline-flex';document.getElementById('ep-recur-text').textContent=rs;}else{badge.style.display='none';}
  // Reminder
  const rb=document.getElementById('ep-reminder-badge');
  if(ev.reminder!=null){ rb.style.display='inline-flex'; document.getElementById('ep-reminder-text').textContent=ev.reminder===0?'At event time':`${ev.reminder<60?ev.reminder+' min':ev.reminder/60+' hr'} before`; }
  else rb.style.display='none';
  // Label
  const lblBadge=document.getElementById('ep-label-badge');
  if(ev.labelId){ const lbl=labels.find(l=>l.id===ev.labelId); if(lbl){ lblBadge.style.display='inline-flex'; lblBadge.style.background=lbl.color+'22'; lblBadge.style.color=lbl.color; document.getElementById('ep-label-dot').style.background=lbl.color; document.getElementById('ep-label-text').textContent=lbl.name; }else lblBadge.style.display='none'; }
  else lblBadge.style.display='none';
  // Calendar
  const calBadge=document.getElementById('ep-cal-badge');
  if(cal&&cal.id!=='default'){ calBadge.style.display='inline-flex'; document.getElementById('ep-cal-dot').style.background=cal.color; document.getElementById('ep-cal-text').textContent=cal.name; }
  else calBadge.style.display='none';
  // Description
  const desc=document.getElementById('ep-desc');
  if(ev.description){desc.textContent=ev.description;desc.style.display='block';}else desc.style.display='none';
  p.classList.add('open');
  const px=Math.min(e.clientX+12,window.innerWidth-300);
  const py=Math.min(e.clientY+12,window.innerHeight-280);
  p.style.left=px+'px'; p.style.top=py+'px';
}
function closePopup(){ document.getElementById('event-popup').classList.remove('open'); popupEventId=null; popupEventDate=null; }
function editEventFromPopup(){ if(popupEventId) openEditModal(popupEventId); }
function copyEventFromPopup(){ if(popupEventId){ closePopup(); openCopyModal(popupEventId); } }
function deleteEventFromPopup(){
  if(!popupEventId) return;
  const ev=events.find(e=>e.id===popupEventId);
  if(ev?.recurrence?.type!=='none'){ const d=popupEventDate; closePopup(); openDelDialog(ev.id,d); }
  else{ const _pid=popupEventId; events=events.filter(e=>e.id!==_pid); localStorage.setItem('calioEvents',JSON.stringify(events)); _fbDeleteEventDoc(_pid); closePopup(); render(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleSearch(q){
  const wrap=document.getElementById('search-wrap');
  const res=document.getElementById('search-results');
  res.innerHTML='';
  if(!q.trim()){ wrap.classList.remove('has-results'); return; }
  const ql=q.toLowerCase();
  const matches=events.filter(ev=>(ev.title||'').toLowerCase().includes(ql)||(ev.description||'').toLowerCase().includes(ql));
  if(!matches.length){
    const e=document.createElement('div'); e.className='sr-empty'; e.textContent='No events found'; res.appendChild(e);
  } else {
    matches.slice(0,12).forEach(ev=>{
      const cal=calendars.find(c=>c.id===(ev.calendarId||'default'));
      const color=ev.color||(cal?cal.color:COLORS[0].hex);
      const item=document.createElement('div'); item.className='sr-item';
      const title=document.createElement('div'); title.className='sr-title'; title.textContent=ev.title;
      const meta=document.createElement('div'); meta.className='sr-meta'; meta.textContent=(cal?cal.name+' ¬∑ ':'')+ev.date+(ev.start?' ¬∑ '+ev.start:'');
      item.style.borderLeft=`3px solid ${color}`;
      item.appendChild(title); item.appendChild(meta);
      item.onclick=()=>{
        document.getElementById('search-input').value=''; wrap.classList.remove('has-results');
        cursor=parseDate(ev.date); setView('month');
        setTimeout(()=>showPopup(ev.id,parseDate(ev.date),{clientX:window.innerWidth/2,clientY:200}),100);
      };
      res.appendChild(item);
    });
  }
  wrap.classList.add('has-results');
}
// Close search on outside click is handled in the main click listener

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAG & DROP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startDrag(evId,dateStr,e){
  dragEventId=evId; dragStartDate=dateStr; isDragging=true;
  const ev=events.find(x=>x.id===evId);
  // Show ghost label
  const ghost=document.getElementById('drag-ghost');
  ghost.textContent=ev?ev.title:'Event'; ghost.style.display='block';
  if(e.dataTransfer){ e.dataTransfer.effectAllowed='move'; e.dataTransfer.setDragImage(ghost,0,0); }
  setTimeout(()=>{ghost.style.display='none';},0);
  document.getElementById('calendar-area').addEventListener('dragover',trackDragGhost);
}
function trackDragGhost(e){
  const ghost=document.getElementById('drag-ghost');
  ghost.style.display='block'; ghost.style.left=(e.clientX+12)+'px'; ghost.style.top=(e.clientY+12)+'px';
}
function endDrag(){
  isDragging=false; dragEventId=null; dragStartDate=null;
  document.getElementById('drag-ghost').style.display='none';
  document.getElementById('calendar-area').removeEventListener('dragover',trackDragGhost);
  document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
}
function handleDrop(targetDateStr){
  if(!dragEventId||!dragStartDate||dragStartDate===targetDateStr) return endDrag();
  const ev=events.find(e=>e.id===dragEventId); if(!ev) return endDrag();
  // For recurring events, just move the base date; show toast warning
  const wasRecurring=ev.recurrence&&ev.recurrence.type!=='none';
  ev.date=targetDateStr;
  if(ev.endDate){
    // Shift end date by same delta
    const startD=parseDate(dragStartDate), endD=parseDate(ev.endDate), targetD=parseDate(targetDateStr);
    const delta=Math.round((targetD-startD)/(1000*60*60*24));
    ev.endDate=fmtDate(addDays(endD,delta));
  }
  localStorage.setItem('calioEvents',JSON.stringify(events));
  _fbPushEvent(ev);
  render();
  showToast(wasRecurring?`Moved "${ev.title}" (all occurrences shifted)`:`Moved "${ev.title}" to ${targetDateStr}`);
  endDrag();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOUCH SUPPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleTouchStart(e,dateStr){
  touchStartX=e.touches[0].clientX; touchStartY=e.touches[0].clientY;
  touchStartTime=Date.now(); touchDate=dateStr;
  longPressTimer=setTimeout(()=>{
    if(touchDate) openModal(touchDate);
    navigator.vibrate&&navigator.vibrate(40);
  },500);
}
function handleTouchMove(e){
  const dx=Math.abs(e.touches[0].clientX-touchStartX);
  const dy=Math.abs(e.touches[0].clientY-touchStartY);
  if(dx>8||dy>8) clearTimeout(longPressTimer);
}
function handleTouchEnd(e){
  clearTimeout(longPressTimer);
  const dt=Date.now()-touchStartTime;
  const dx=Math.abs(e.changedTouches[0].clientX-touchStartX);
  // Swipe navigation
  if(dt<400&&dx>50){
    const dir=e.changedTouches[0].clientX<touchStartX?1:-1;
    navigate(dir);
  }
}
// Add swipe to main body for navigation in all views
document.getElementById('calendar-area').addEventListener('touchstart',e=>{ touchStartX=e.touches[0].clientX; touchStartY=e.touches[0].clientY; touchStartTime=Date.now(); },{passive:true});
document.getElementById('calendar-area').addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-touchStartX;
  const dy=Math.abs(e.changedTouches[0].clientY-touchStartY);
  const dt=Date.now()-touchStartTime;
  if(dt<400&&Math.abs(dx)>60&&dy<60) navigate(dx<0?1:-1);
},{passive:true});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDARS CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedCalColorLocal=COLORS[0].hex;
function buildCalColorPicker(sel){
  const cp=document.getElementById('cal-color-picker'); cp.innerHTML='';
  COLORS.forEach(c=>{
    const sw=document.createElement('div'); sw.className='label-color-sw'+(sel===c.hex?' selected':'');
    sw.style.background=c.hex; sw.onclick=()=>{selectedCalColorLocal=c.hex;buildCalColorPicker(c.hex);};
    cp.appendChild(sw);
  });
}
function openCalModal(id){
  editingCalId=id;
  const cal=id?calendars.find(c=>c.id===id):null;
  document.getElementById('cal-modal-title').textContent=id?'Edit Calendar':'New Calendar';
  document.getElementById('cal-name').value=cal?cal.name:'';
  selectedCalColorLocal=cal?cal.color:COLORS[0].hex;
  buildCalColorPicker(selectedCalColorLocal);
  const actions=document.getElementById('cal-modal-actions');
  if(id&&id!=='default') actions.innerHTML=`<button class="btn-delete" onclick="deleteCalendar('${id}')">Delete</button><button class="btn-cancel" onclick="closeCalModal()">Cancel</button><button class="btn-save" onclick="saveCalendar()">Save</button>`;
  else actions.innerHTML=`<button class="btn-cancel" onclick="closeCalModal()">Cancel</button><button class="btn-save" onclick="saveCalendar()">Save Calendar</button>`;
  document.getElementById('cal-overlay').classList.add('open');
  setTimeout(()=>document.getElementById('cal-name').focus(),80);
}
function closeCalModal(){ document.getElementById('cal-overlay').classList.remove('open'); editingCalId=null; }

// Called from event modal ‚Äî open cal create, then re-open event modal with new cal selected
function openCalModalFromEvent(){
  // Snapshot current event form state so we can restore it
  const snap=snapshotEventForm();
  openCalModal(null);
  // After saveCalendar completes, reopen event modal with the new calendar selected
  const _origSaveCal=saveCalendar;
  saveCalendar=function(){
    _origSaveCal.call(this);
    saveCalendar=_origSaveCal; // restore
    restoreEventForm(snap);
    // Select the newly created calendar
    const newCal=calendars[calendars.length-1];
    if(newCal){ populateCalendarDropdown(newCal.id); }
    document.getElementById('modal-overlay').classList.add('open');
  };
}
// Called from event modal ‚Äî open label create, then re-open event modal with new label selected
function openLabelModalFromEvent(){
  const snap=snapshotEventForm();
  openLabelModal(null);
  const _origSaveLbl=saveLabel;
  saveLabel=function(){
    _origSaveLbl.call(this);
    saveLabel=_origSaveLbl;
    restoreEventForm(snap);
    const newLbl=labels[labels.length-1];
    if(newLbl){ populateLabelDropdown(newLbl.id); }
    document.getElementById('modal-overlay').classList.add('open');
  };
}
function snapshotEventForm(){
  return {
    title:document.getElementById('ev-title').value,
    date:document.getElementById('ev-date').value,
    endDate:document.getElementById('ev-end-date').value,
    allDay:document.getElementById('ev-allday').value,
    start:document.getElementById('ev-start').value,
    end:document.getElementById('ev-end').value,
    desc:document.getElementById('ev-desc').value,
    label:document.getElementById('ev-label').value,
    calendar:document.getElementById('ev-calendar').value,
    reminder:document.getElementById('ev-reminder').value,
    recurType:document.getElementById('ev-recur-type').value,
    recurInterval:document.getElementById('ev-recur-interval').value,
    recurEndType:document.getElementById('ev-recur-end-type').value,
    recurEndDate:document.getElementById('ev-recur-end-date').value,
    recurCount:document.getElementById('ev-recur-count').value,
    editingId,
  };
}
function restoreEventForm(snap){
  editingId=snap.editingId;
  document.getElementById('modal-title').textContent=editingId?'Edit Event':'New Event';
  document.getElementById('ev-title').value=snap.title;
  document.getElementById('ev-date').value=snap.date;
  document.getElementById('ev-end-date').value=snap.endDate;
  document.getElementById('ev-allday').value=snap.allDay;
  document.getElementById('ev-start').value=snap.start;
  document.getElementById('ev-end').value=snap.end;
  document.getElementById('ev-desc').value=snap.desc;
  document.getElementById('ev-reminder').value=snap.reminder;
  document.getElementById('ev-recur-type').value=snap.recurType;
  document.getElementById('ev-recur-interval').value=snap.recurInterval;
  document.getElementById('ev-recur-end-type').value=snap.recurEndType;
  document.getElementById('ev-recur-end-date').value=snap.recurEndDate;
  document.getElementById('ev-recur-count').value=snap.recurCount;
  populateCalendarDropdown(snap.calendar);
  populateLabelDropdown(snap.label);
  toggleTimeFields(); onRecurTypeChange(); onRecurEndChange();
  document.getElementById('modal-actions').innerHTML=editingId
    ?`<button class="btn-delete" onclick="handleDeleteEdit('${editingId}')">Delete</button><button class="btn-cancel" onclick="closeModal()">Cancel</button><button class="btn-save" onclick="saveEvent()">Save Changes</button>`
    :`<button class="btn-cancel" onclick="closeModal()">Cancel</button><button class="btn-save" onclick="saveEvent()">Save Event</button>`;
}
function saveCalendar(){
  const name=document.getElementById('cal-name').value.trim();
  if(!name){ document.getElementById('cal-name').style.borderColor='var(--red)'; setTimeout(()=>document.getElementById('cal-name').style.borderColor='',1500); return; }
  if(editingCalId){ const c=calendars.find(x=>x.id===editingCalId); if(c){c.name=name;c.color=selectedCalColorLocal;} }
  else calendars.push({id:uuid(),name,color:selectedCalColorLocal,visible:true});
  saveCalendars(); closeCalModal(); render();
}
function deleteCalendar(id){
  events.forEach(ev=>{if(ev.calendarId===id){ev.calendarId='default';_fbPushEvent(ev);}});
  localStorage.setItem('calioEvents',JSON.stringify(events));
  calendars=calendars.filter(c=>c.id!==id);
  saveCalendars(); closeCalModal(); render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LABELS CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedLabelColorLocal=COLORS[1].hex;
function buildLabelColorPicker(){
  const cp=document.getElementById('label-color-picker'); cp.innerHTML='';
  COLORS.forEach(c=>{ const sw=document.createElement('div'); sw.className='label-color-sw'+(selectedLabelColorLocal===c.hex?' selected':''); sw.style.background=c.hex; sw.onclick=()=>{selectedLabelColorLocal=c.hex;buildLabelColorPicker();}; cp.appendChild(sw); });
}
function openLabelModal(id){
  editingLabelId=id;
  const lbl=id?labels.find(l=>l.id===id):null;
  document.getElementById('label-modal-title').textContent=id?'Edit Label':'New Label';
  document.getElementById('lbl-name').value=lbl?lbl.name:'';
  selectedLabelColorLocal=lbl?lbl.color:COLORS[1].hex;
  buildLabelColorPicker();
  const actions=document.getElementById('label-modal-actions');
  if(id) actions.innerHTML=`<button class="btn-delete" onclick="deleteLabel('${id}')">Delete</button><button class="btn-cancel" onclick="closeLabelModal()">Cancel</button><button class="btn-save" onclick="saveLabel()">Save</button>`;
  else actions.innerHTML=`<button class="btn-cancel" onclick="closeLabelModal()">Cancel</button><button class="btn-save" onclick="saveLabel()">Save Label</button>`;
  document.getElementById('label-overlay').classList.add('open');
  setTimeout(()=>document.getElementById('lbl-name').focus(),80);
}
function closeLabelModal(){ document.getElementById('label-overlay').classList.remove('open'); editingLabelId=null; }
function saveLabel(){
  const name=document.getElementById('lbl-name').value.trim();
  if(!name){ document.getElementById('lbl-name').style.borderColor='var(--red)'; setTimeout(()=>document.getElementById('lbl-name').style.borderColor='',1500); return; }
  let pushLbl;
  if(editingLabelId){ const lbl=labels.find(l=>l.id===editingLabelId); if(lbl){lbl.name=name;lbl.color=selectedLabelColorLocal;pushLbl=lbl;} }
  else{ const newLbl={id:uuid(),name,color:selectedLabelColorLocal,visible:true}; labels.push(newLbl); pushLbl=newLbl; }
  saveLabels(); if(pushLbl)_fbPushLabel(pushLbl); closeLabelModal(); render();
}
function deleteLabel(id){
  events.forEach(ev=>{if(ev.labelId===id){ev.labelId=null;_fbPushEvent(ev);}});
  localStorage.setItem('calioEvents',JSON.stringify(events));
  labels=labels.filter(l=>l.id!==id); saveLabels(); _fbDeleteLabelDoc(id); closeLabelModal(); render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HABITS CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedHabitColorLocal=COLORS[2].hex;
function buildHabitColorPicker(){
  const cp=document.getElementById('habit-color-picker'); cp.innerHTML='';
  COLORS.forEach(c=>{ const sw=document.createElement('div'); sw.className='label-color-sw'+(selectedHabitColorLocal===c.hex?' selected':''); sw.style.background=c.hex; sw.onclick=()=>{selectedHabitColorLocal=c.hex;buildHabitColorPicker();}; cp.appendChild(sw); });
}
function openHabitModal(id){
  editingHabitId=id;
  const h=id?habits.find(x=>x.id===id):null;
  document.getElementById('habit-modal-title').textContent=id?'Edit Habit':'New Habit';
  document.getElementById('habit-name').value=h?h.name:'';
  document.getElementById('habit-freq').value=h?h.freq:'daily';
  selectedHabitColorLocal=h?h.color:COLORS[2].hex;
  buildHabitColorPicker();
  const actions=document.getElementById('habit-modal-actions');
  if(id) actions.innerHTML=`<button class="btn-delete" onclick="deleteHabit('${id}')">Delete</button><button class="btn-cancel" onclick="closeHabitModal()">Cancel</button><button class="btn-save" onclick="saveHabit()">Save</button>`;
  else actions.innerHTML=`<button class="btn-cancel" onclick="closeHabitModal()">Cancel</button><button class="btn-save" onclick="saveHabit()">Save Habit</button>`;
  document.getElementById('habit-overlay').classList.add('open');
  setTimeout(()=>document.getElementById('habit-name').focus(),80);
}
function closeHabitModal(){ document.getElementById('habit-overlay').classList.remove('open'); editingHabitId=null; }
function saveHabit(){
  const name=document.getElementById('habit-name').value.trim();
  if(!name){ document.getElementById('habit-name').style.borderColor='var(--red)'; setTimeout(()=>document.getElementById('habit-name').style.borderColor='',1500); return; }
  const freq=document.getElementById('habit-freq').value;
  if(editingHabitId){ const h=habits.find(x=>x.id===editingHabitId); if(h){h.name=name;h.freq=freq;h.color=selectedHabitColorLocal;} }
  else habits.push({id:uuid(),name,freq,color:selectedHabitColorLocal,completions:[]});
  saveHabits(); closeHabitModal(); render();
}
function deleteHabit(id){ habits=habits.filter(h=>h.id!==id); saveHabits(); closeHabitModal(); render(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REMINDERS / NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function requestNotifPermission(){
  if(!('Notification' in window)){ showToast('Notifications not supported in this browser'); return; }
  Notification.requestPermission().then(p=>{
    notifPermission=p;
    const el=document.getElementById('notif-status');
    if(el) el.textContent=p==='granted'?'‚úì Enabled ‚Äî you will receive reminders':p==='denied'?'Blocked by browser ‚Äî enable in browser settings':'Permission not granted';
    if(p==='granted'){ showToast('Notifications enabled!'); scheduleAllReminders(); }
    else showToast('Notification permission '+p);
  });
}
function scheduleAllReminders(){
  Object.values(reminderTimers).forEach(t=>clearTimeout(t));
  reminderTimers={};
  if(typeof Notification==='undefined'||Notification.permission!=='granted') return;
  events.forEach(ev=>scheduleReminder(ev));
}
function scheduleReminder(ev){
  if(ev.reminder==null||ev.allDay) return;
  if(typeof Notification==='undefined'||Notification.permission!=='granted') return;
  const dateStr=ev.date, timeStr=ev.start;
  if(!dateStr||!timeStr) return;
  const eventDt=new Date(dateStr+'T'+timeStr+':00');
  const remindAt=new Date(eventDt.getTime()-ev.reminder*60000);
  const now=new Date();
  const delay=remindAt-now;
  if(delay<0||delay>7*24*3600*1000) return; // only schedule within 7 days
  if(reminderTimers[ev.id]) clearTimeout(reminderTimers[ev.id]);
  reminderTimers[ev.id]=setTimeout(()=>{
    const label=ev.reminder===0?'Starting now':`In ${ev.reminder<60?ev.reminder+' minutes':ev.reminder/60+' hour(s)'}`;
    try{
      new Notification(ev.title,{ body:`${label} ¬∑ ${timeStr}`, icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="%237c6af7"/></svg>' });
    }catch(e){}
  },delay);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THEME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTheme(){
  currentTheme=currentTheme==='dark'?'light':'dark';
  applyTheme(); savePrefs();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TIMEZONE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateTzSelect(){
  const sel=document.getElementById('tz-select'); if(!sel) return;
  sel.innerHTML='<option value="">Use device timezone</option>';
  TZ_LIST.forEach(tz=>{ const o=document.createElement('option'); o.value=tz; o.textContent=tz.replace('_',' '); if(tz===currentTz) o.selected=true; sel.appendChild(o); });
  updateTzLabel();
}
function onTzChange(){
  currentTz=document.getElementById('tz-select').value;
  savePrefs(); updateTzLabel(); render();
}
function updateTzLabel(){
  const el=document.getElementById('tz-current-label'); if(!el) return;
  try{
    const tz=currentTz||Intl.DateTimeFormat().resolvedOptions().timeZone;
    const now=new Date();
    const time=now.toLocaleTimeString('en-US',{timeZone:tz,hour:'2-digit',minute:'2-digit',hour12:true});
    const offset=now.toLocaleTimeString('en-US',{timeZone:tz,timeZoneName:'short'}).split(' ').pop();
    el.textContent=`Current time: ${time} (${offset})`;
  }catch{ el.textContent=''; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSettings(){
  document.getElementById('theme-toggle').checked=currentTheme==='light';
  populateTzSelect();
  const ns=document.getElementById('notif-status');
  if(ns){
    if(typeof Notification==='undefined') ns.textContent='Not supported in this browser';
    else if(Notification.permission==='granted') ns.textContent='‚úì Enabled';
    else if(Notification.permission==='denied') ns.textContent='Blocked by browser';
    else ns.textContent='Click to enable';
  }
  document.getElementById('settings-overlay').classList.add('open');
}
function closeSettings(){ document.getElementById('settings-overlay').classList.remove('open'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JUMP TO DATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openJumpToDate(){
  const jw=document.getElementById('jump-wrapper'); jw.classList.toggle('open');
  if(jw.classList.contains('open')){
    const d=view==='month'||view==='year'?new Date(cursor.getFullYear(),cursor.getMonth(),today.getDate()):cursor;
    document.getElementById('jump-date-input').value=fmtDate(d);
    setTimeout(()=>document.getElementById('jump-date-input').focus(),60);
  }
}
function closeJumpDropdown(){ document.getElementById('jump-wrapper').classList.remove('open'); }
function confirmJump(){
  const val=document.getElementById('jump-date-input').value; if(!val) return;
  const d=new Date(val+'T12:00:00'); if(isNaN(d)) return;
  cursor=view==='month'||view==='year'?new Date(d.getFullYear(),d.getMonth(),1):new Date(d);
  closeJumpDropdown(); render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT / EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleIODropdown(e){ e.stopPropagation(); document.getElementById('io-wrapper').classList.toggle('open'); }
function downloadFile(content,filename,mime){
  const blob=new Blob([content],{type:mime});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
}
function exportJSON(){
  const data={version:2,exportedAt:new Date().toISOString(),events,labels,calendars};
  downloadFile(JSON.stringify(data,null,2),'calio-backup.json','application/json');
  showToast('Exported JSON backup');
}
function escapeICS(s){ return (s||'').replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;'); }
function exportICS(){
  let ics='BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//CalIO//EN\r\n';
  events.forEach(ev=>{
    ics+='BEGIN:VEVENT\r\n';
    ics+=`UID:${ev.id}@calio\r\n`;
    ics+=`SUMMARY:${escapeICS(ev.title)}\r\n`;
    if(ev.description) ics+=`DESCRIPTION:${escapeICS(ev.description)}\r\n`;
    const fmt=s=>s.replace(/-/g,'');
    if(ev.allDay){
      ics+=`DTSTART;VALUE=DATE:${fmt(ev.date)}\r\n`;
      ics+=`DTEND;VALUE=DATE:${fmt(ev.endDate||ev.date)}\r\n`;
    } else {
      const st=(ev.start||'09:00').replace(':',''); const et=(ev.end||'10:00').replace(':','');
      ics+=`DTSTART:${fmt(ev.date)}T${st}00\r\n`;
      ics+=`DTEND:${fmt(ev.date)}T${et}00\r\n`;
    }
    ics+='END:VEVENT\r\n';
  });
  ics+='END:VCALENDAR';
  downloadFile(ics,'calio-events.ics','text/calendar');
  showToast('Exported .ics file');
}
function openImportModal(type){
  importType=type; importedEventsBuffer=[]; importMode='merge';
  document.getElementById('import-modal-title').textContent=type==='json'?'Import JSON Backup':'Import .ics File';
  document.getElementById('import-preview').style.display='none';
  document.getElementById('import-confirm-btn').disabled=true;
  document.getElementById('import-confirm-btn').style.opacity='0.4';
  document.getElementById('mode-merge').classList.add('selected'); document.getElementById('mode-replace').classList.remove('selected');
  document.getElementById('import-mode-desc').textContent='Add alongside existing events.';
  document.getElementById('dz-title').textContent='Click to choose a file';
  document.getElementById('io-wrapper').classList.remove('open');
  document.getElementById('import-overlay').classList.add('open');
}
function closeImportModal(){ document.getElementById('import-overlay').classList.remove('open'); importedEventsBuffer=[]; }
function setImportMode(m){
  importMode=m;
  document.getElementById('mode-merge').classList.toggle('selected',m==='merge');
  document.getElementById('mode-replace').classList.toggle('selected',m==='replace');
  document.getElementById('import-mode-desc').textContent=m==='replace'?'Replace ALL existing events.':'Add alongside existing events.';
}
function triggerFileInput(){ document.getElementById('file-input').click(); }
document.getElementById('file-input').onchange=e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{ processImportFile(file.name,ev.target.result); };
  reader.readAsText(file);
  e.target.value='';
};
const dz=document.getElementById('import-drop-zone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag-over');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag-over'));
dz.addEventListener('drop',e=>{
  e.preventDefault(); dz.classList.remove('drag-over');
  const file=e.dataTransfer.files[0]; if(!file) return;
  const reader=new FileReader(); reader.onload=ev=>processImportFile(file.name,ev.target.result); reader.readAsText(file);
});
function processImportFile(name,content){
  document.getElementById('dz-title').textContent=name;
  try{
    if(name.endsWith('.json')) importedEventsBuffer=parseJSONImport(content);
    else importedEventsBuffer=parseICSImport(content);
    const pr=document.getElementById('import-preview');
    document.getElementById('ip-count').innerHTML=`<strong>${importedEventsBuffer.length}</strong> event${importedEventsBuffer.length!==1?'s':''} found`;
    pr.style.display='block';
    const btn=document.getElementById('import-confirm-btn'); btn.disabled=false; btn.style.opacity='1';
  }catch(e){ showToast('Failed to parse file: '+e.message); }
}
function parseJSONImport(content){
  const data=JSON.parse(content);
  if(data.labels&&Array.isArray(data.labels)){ labels=data.labels; saveLabels(); }
  if(data.calendars&&Array.isArray(data.calendars)){ calendars=data.calendars; saveCalendars(); }
  const evs=data.events||data;
  return evs.map(ev=>({...ev,id:importMode==='merge'?uuid():ev.id}));
}
function parseICSImport(content){
  const lines=content.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
  const evts=[]; let cur=null;
  lines.forEach(line=>{
    if(line==='BEGIN:VEVENT'){cur={};}
    else if(line==='END:VEVENT'&&cur){
      if(cur.title){ evts.push({id:uuid(),title:cur.title,date:cur.date||fmtDate(today),endDate:cur.endDate||null,allDay:cur.allDay||false,start:cur.start||null,end:cur.end||null,description:cur.desc||'',color:COLORS[0].hex,recurrence:{type:'none'},exceptions:[],calendarId:'default'}); }
      cur=null;
    } else if(cur){
      const [key,...rest]=line.split(':'); const val=rest.join(':');
      if(key==='SUMMARY') cur.title=val;
      else if(key==='DESCRIPTION') cur.desc=val.replace(/\\n/g,'\n');
      else if(key.startsWith('DTSTART')){
        if(key.includes('VALUE=DATE')){ cur.allDay=true; cur.date=`${val.slice(0,4)}-${val.slice(4,6)}-${val.slice(6,8)}`; }
        else{ cur.date=`${val.slice(0,4)}-${val.slice(4,6)}-${val.slice(6,8)}`; cur.start=`${val.slice(9,11)}:${val.slice(11,13)}`; }
      }
      else if(key.startsWith('DTEND')){
        if(key.includes('VALUE=DATE')) cur.endDate=`${val.slice(0,4)}-${val.slice(4,6)}-${val.slice(6,8)}`;
        else cur.end=`${val.slice(9,11)}:${val.slice(11,13)}`;
      }
    }
  });
  return evts;
}
function confirmImport(){
  if(!importedEventsBuffer.length) return;
  if(importMode==='replace') events=importedEventsBuffer;
  else events=[...events,...importedEventsBuffer];
  localStorage.setItem('calioEvents',JSON.stringify(events));
  if(fbDb&&currentRoom){
    importedEventsBuffer.forEach(ev=>fbSaveEvent(ev));
    labels.forEach(lbl=>{const d={...lbl};delete d.id;fbDb.collection('rooms').doc(currentRoom).collection('labels').doc(lbl.id).set(d);});
  }
  closeImportModal(); render();
  showToast(`${importMode==='replace'?'Replaced with':'Imported'} ${importedEventsBuffer.length} event${importedEventsBuffer.length!==1?'s':''}`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.opacity='1'; clearTimeout(t._t); t._t=setTimeout(()=>t.style.opacity='0',2800); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KEYBOARD & CLICK LISTENERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('click',e=>{
  const p=document.getElementById('event-popup');
  if(p.classList.contains('open')&&!p.contains(e.target)) closePopup();
  const iow=document.getElementById('io-wrapper');
  if(iow.classList.contains('open')&&!iow.contains(e.target)) iow.classList.remove('open');
  const jw=document.getElementById('jump-wrapper');
  if(jw.classList.contains('open')&&!jw.contains(e.target)) closeJumpDropdown();
  const sw=document.getElementById('search-wrap');
  if(!sw.contains(e.target)){ sw.classList.remove('has-results'); }
});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    const anyOpen=[
      document.getElementById('modal-overlay'),document.getElementById('copy-overlay'),
      document.getElementById('del-overlay'),document.getElementById('import-overlay'),
      document.getElementById('label-overlay'),document.getElementById('cal-overlay'),
      document.getElementById('habit-overlay'),document.getElementById('settings-overlay'),
      document.getElementById('room-overlay'),document.getElementById('fb-setup-overlay'),
    ].some(el=>el&&el.classList.contains('open'));
    const dropOpen=document.getElementById('io-wrapper').classList.contains('open')||document.getElementById('jump-wrapper').classList.contains('open');
    const popOpen=document.getElementById('event-popup').classList.contains('open');
    if(anyOpen||dropOpen||popOpen){
      closeModal();closePopup();closeCopyModal();closeDelDialog();closeImportModal();
      closeLabelModal();closeCalModal();closeHabitModal();closeSettings();closeRoomModal();closeFbSetup();
      document.getElementById('io-wrapper').classList.remove('open');closeJumpDropdown();
    } else { toggleSidebar(); }
    return;
  }
  if(e.target.matches('input,select,textarea')) return;
  const mo=document.getElementById('modal-overlay');
  if(!mo.classList.contains('open')){
    if(e.key==='ArrowLeft') navigate(-1);
    if(e.key==='ArrowRight') navigate(1);
    if(e.key==='n') openModal();
    if(e.key==='g') openJumpToDate();
    if(e.key==='t') goToday();
    if(e.key==='m') setView('month');
    if(e.key==='w') setView('week');
    if(e.key==='d') setView('day');
    if(e.key==='a') setView('agenda');
    if(e.key==='y') setView('year');
    if(e.key==='?'||e.key==='/') document.getElementById('search-input').focus();
  }
});
setInterval(()=>{ if(view==='week'||view==='day') renderCalendar(); today=new Date(); },60000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let fbApp=null,fbDb=null,currentRoom=null,syncListeners=[],isFirebaseReady=false;
function loadFbConfig(){ try{return JSON.parse(localStorage.getItem('calioFbConfig')||'null');}catch{return null;} }
function saveFbConfig(cfg){ localStorage.setItem('calioFbConfig',JSON.stringify(cfg)); }
function clearFbConfig(){ localStorage.removeItem('calioFbConfig'); }
function loadSavedRoom(){ return localStorage.getItem('calioRoom')||null; }
function saveRoomLocal(code){ if(code) localStorage.setItem('calioRoom',code); else localStorage.removeItem('calioRoom'); }
function setSyncStatus(status,label){
  const dot=document.getElementById('sync-dot'),lbl=document.getElementById('sync-label');
  if(!dot||!lbl) return;
  dot.className='sync-dot '+status; lbl.textContent=label;
}
function initFirebase(cfg){
  try{
    if(fbApp){try{fbApp.delete();}catch(e){} fbApp=null;fbDb=null;}
    fbApp=!firebase.apps.length?firebase.initializeApp(cfg):firebase.app();
    fbDb=firebase.firestore();
    fbDb.enablePersistence({synchronizeTabs:true}).catch(()=>{});
    isFirebaseReady=true; setSyncStatus('connected','Firebase ready'); return true;
  }catch(err){ isFirebaseReady=false; setSyncStatus('offline','Firebase error'); return false; }
}
function tryAutoConnect(){
  const cfg=loadFbConfig(); if(!cfg){setSyncStatus('local','Local');return;}
  const ok=initFirebase(cfg); if(!ok) return;
  const savedRoom=loadSavedRoom(); if(savedRoom) attachRoom(savedRoom);
}
function genRoomCode(){ const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<6;i++) s+=c[Math.floor(Math.random()*c.length)]; return s; }
function detachListeners(){ syncListeners.forEach(u=>{try{u();}catch(e){}});syncListeners=[]; }
async function attachRoom(code){
  if(!fbDb){setSyncStatus('offline','Not connected');return false;}
  detachListeners(); currentRoom=code; saveRoomLocal(code); setSyncStatus('syncing','Connecting‚Ä¶'); updateRoomBadge();
  const roomRef=fbDb.collection('rooms').doc(code);
  try{await roomRef.set({updatedAt:Date.now()},{merge:true});}catch(e){}
  const evUnsub=roomRef.collection('events').onSnapshot(snap=>{
    events=[]; snap.forEach(doc=>events.push({...doc.data(),id:doc.id}));
    localStorage.setItem('calioEvents',JSON.stringify(events)); render(); setSyncStatus('connected','Synced ¬∑ '+code);
  },()=>setSyncStatus('offline','Sync error'));
  const lblUnsub=roomRef.collection('labels').onSnapshot(snap=>{
    labels=[]; snap.forEach(doc=>labels.push({...doc.data(),id:doc.id})); saveLabels(); renderSidebar();
  },()=>{});
  const habUnsub=roomRef.collection('habits').onSnapshot(snap=>{
    habits=[]; snap.forEach(doc=>habits.push({...doc.data(),id:doc.id})); saveHabits(); renderSidebar();
  },()=>{});
  syncListeners=[evUnsub,lblUnsub,habUnsub]; return true;
}
async function fbSaveEvent(ev){ if(!fbDb||!currentRoom) return; try{const d={...ev};delete d.id;await fbDb.collection('rooms').doc(currentRoom).collection('events').doc(ev.id).set(d);}catch(e){} }
async function fbDeleteEvent(id){ if(!fbDb||!currentRoom) return; try{await fbDb.collection('rooms').doc(currentRoom).collection('events').doc(id).delete();}catch(e){} }
async function fbSaveAllEvents(){ if(!fbDb||!currentRoom) return; setSyncStatus('syncing','Saving‚Ä¶'); try{for(let i=0;i<events.length;i+=400){const batch=fbDb.batch();events.slice(i,i+400).forEach(ev=>{const d={...ev};delete d.id;batch.set(fbDb.collection('rooms').doc(currentRoom).collection('events').doc(ev.id),d);});await batch.commit();}setSyncStatus('connected','Synced ¬∑ '+currentRoom);}catch(e){setSyncStatus('offline','Sync error');} }
async function fbSaveLabel(lbl){ if(!fbDb||!currentRoom) return; try{const d={...lbl};delete d.id;await fbDb.collection('rooms').doc(currentRoom).collection('labels').doc(lbl.id).set(d);}catch(e){} }
async function fbDeleteLabel(id){ if(!fbDb||!currentRoom) return; try{await fbDb.collection('rooms').doc(currentRoom).collection('labels').doc(id).delete();}catch(e){} }
async function fbSaveHabit(h){ if(!fbDb||!currentRoom) return; try{const d={...h};delete d.id;await fbDb.collection('rooms').doc(currentRoom).collection('habits').doc(h.id).set(d);}catch(e){} }
function _fbPushEvent(ev){ if(fbDb&&currentRoom) fbSaveEvent(ev); }
function _fbDeleteEventDoc(id){ if(fbDb&&currentRoom) fbDeleteEvent(id); }
function _fbPushLabel(lbl){ if(fbDb&&currentRoom) fbSaveLabel(lbl); }
function _fbDeleteLabelDoc(id){ if(fbDb&&currentRoom) fbDeleteLabel(id); }
function updateRoomBadge(){
  const wrap=document.getElementById('room-badge-wrap'),si=document.getElementById('sync-indicator');
  if(currentRoom){ if(wrap){wrap.style.display='';document.getElementById('room-badge-code').textContent=currentRoom;} if(si)si.style.display='none'; }
  else{ if(wrap)wrap.style.display='none'; if(si)si.style.display=''; }
}
function openFbSetup(){
  const cfg=loadFbConfig(); if(cfg) document.getElementById('fb-config-input').value=JSON.stringify(cfg,null,2);
  document.getElementById('fb-config-error').style.display='none';
  document.getElementById('fb-setup-overlay').classList.add('open');
}
function closeFbSetup(){ document.getElementById('fb-setup-overlay').classList.remove('open'); }
function parseFirebaseConfig(raw){
  let s=raw.trim().replace(/<script[^>]*>/gi,'').replace(/<\/script>/gi,'').trim().replace(/\/\/[^\n]*/g,'');
  const start=s.indexOf('{'); if(start===-1) throw new Error('No { } block found.');
  let depth=0,end=-1;
  for(let i=start;i<s.length;i++){if(s[i]==='{')depth++;else if(s[i]==='}'&&--depth===0){end=i;break;}}
  if(end===-1) throw new Error('Incomplete config ‚Äî missing closing }.');
  const result=(new Function('return '+s.slice(start,end+1)))();
  if(typeof result!=='object'||result===null) throw new Error('Config did not evaluate to an object.');
  return result;
}
function connectFirebase(){
  const raw=document.getElementById('fb-config-input').value.trim();
  const errEl=document.getElementById('fb-config-error'); errEl.style.display='none';
  let cfg;
  try{
    if(!raw) throw new Error('Paste your Firebase config first.');
    cfg=parseFirebaseConfig(raw);
    if(!cfg.apiKey) throw new Error('"apiKey" missing.');
    if(!cfg.projectId) throw new Error('"projectId" missing.');
  }catch(e){ errEl.textContent='‚ö† '+e.message; errEl.style.display='block'; return; }
  saveFbConfig(cfg);
  if(!initFirebase(cfg)){ errEl.textContent='‚ö† Firebase init failed ‚Äî check your config.'; errEl.style.display='block'; return; }
  closeFbSetup(); openRoomModal();
}
function disconnectFirebase(){
  detachListeners(); leaveRoom(true); clearFbConfig(); isFirebaseReady=false; fbDb=null;
  if(fbApp){try{fbApp.delete();}catch(e){} fbApp=null;}
  setSyncStatus('local','Local'); updateRoomBadge(); closeRoomModal(); showToast('Disconnected from Firebase');
}
function openRoomModal(){
  const noFb=document.getElementById('room-no-firebase'),fbPanel=document.getElementById('room-firebase-panel');
  const active=document.getElementById('room-active-section'),noRoom=document.getElementById('room-noroom-section');
  if(!isFirebaseReady){noFb.style.display='';fbPanel.style.display='none';}
  else{
    noFb.style.display='none';fbPanel.style.display='';
    if(currentRoom){active.style.display='';noRoom.style.display='none';document.getElementById('room-active-code').textContent=currentRoom;}
    else{active.style.display='none';noRoom.style.display='';document.getElementById('room-join-input').value='';document.getElementById('room-join-error').style.display='none';}
  }
  document.getElementById('room-overlay').classList.add('open');
}
function closeRoomModal(){ document.getElementById('room-overlay').classList.remove('open'); }
async function createRoom(){
  const code=genRoomCode();
  const ok=await attachRoom(code); if(!ok) return;
  closeRoomModal();
  await fbSaveAllEvents();
  for(const lbl of labels){const d={...lbl};delete d.id;await fbDb.collection('rooms').doc(code).collection('labels').doc(lbl.id).set(d);}
  for(const h of habits){const d={...h};delete d.id;await fbDb.collection('rooms').doc(code).collection('habits').doc(h.id).set(d);}
  showToast('Room created: '+code+' ‚Äî share this code!'); updateRoomBadge();
}
async function joinRoom(){
  const code=document.getElementById('room-join-input').value.trim().toUpperCase();
  const errEl=document.getElementById('room-join-error'); errEl.style.display='none';
  if(code.length!==6){errEl.textContent='Code must be 6 characters';errEl.style.display='';return;}
  try{const doc=await fbDb.collection('rooms').doc(code).get();if(!doc.exists){errEl.textContent='Room not found.';errEl.style.display='';return;}}catch(e){errEl.textContent='Connection error: '+e.message;errEl.style.display='';return;}
  await attachRoom(code); closeRoomModal(); showToast('Joined room: '+code); updateRoomBadge();
}
function leaveRoom(silent){
  detachListeners(); currentRoom=null; saveRoomLocal(null); updateRoomBadge();
  if(!silent) showToast('Left room ‚Äî back to local');
  setSyncStatus(isFirebaseReady?'connected':'local',isFirebaseReady?'Firebase ready':'Local');
  closeRoomModal();
}
function copyRoomCode(){ if(!currentRoom) return; navigator.clipboard.writeText(currentRoom).then(()=>showToast('Room code copied: '+currentRoom)); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadAll();
tryAutoConnect();
render();
scheduleAllReminders();
</script>
</body>
</html>
